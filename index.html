<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<script type="text/javascript">
var version = {major: 1, minor: 2, revision: 37, date: new Date("Oct 30, 2005"), extensions: {}};
</script>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>UUSEC Network - Your trusted security consultant!</title>
<script type="text/javascript">

// ---------------------------------------------------------------------------------
// Configuration repository
// ---------------------------------------------------------------------------------

var config = {
	// Options that can be set in the options panel and/or cookies
	options: {
		chkRegExpSearch: false,
		chkCaseSensitiveSearch: false,
		chkAnimate: true,
		txtUserName: "YourName",
		chkSaveBackups: true,
		chkAutoSave: false,
		chkGenerateAnRssFeed: false,
		chkSaveEmptyTemplate: false,
		chkOpenInNewWindow: true,
		chkToggleLinks: false,
		chkHttpReadOnly: false,
		chkForceMinorUpdate: false,
		txtMainTab: "tabTimeline",
		txtMoreTab: "moreTabAll"
		},
	// List of notification functions to be called when certain tiddlers are changed or deleted
	notifyTiny: [
		{name: "StyleSheetColors", notify: refreshStyles},
		{name: "StyleSheetLayout", notify: refreshStyles},
		{name: "StyleSheet", notify: refreshStyles},
		{name: null, notify: refreshMenu},
		{name: null, notify: refreshStory},
		{name: null, notify: refreshTabs},
		{name: "SiteTitle", notify: refreshTitle},
		{name: "SiteSubtitle", notify: refreshSubtitle},
		{name: "SideBarOptions", notify: refreshSidebar}
		],
	// Shadow tiddlers for emergencies
	shadowTiny: {
		SideBarOptions: "<<gradient vert #ffffff #cc9900>><<search>><<closeAll>><<permaview>><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel options 'Change site advanced options'>>>>",
		OptionsPanel: "These InterfaceOptions for customising site are saved in your browser\n\nYour username for signing your edits. Write it as a SiteWord (eg JoeBloggs)\n\n<<option txtUserName>>\n<<option chkSaveBackups>> SaveBackups\n<<option chkAutoSave>> AutoSave\n<<option chkGenerateAnRssFeed>> GenerateAnRssFeed\n<<option chkRegExpSearch>> RegExpSearch\n<<option chkCaseSensitiveSearch>> CaseSensitiveSearch\n<<option chkAnimate>> EnableAnimations\n\nSee AdvancedOptions",
		AdvancedOptions: "<<option chkOpenInNewWindow>> OpenLinksInNewWindow\n<<option chkSaveEmptyTemplate>> SaveEmptyTemplate\n<<option chkToggleLinks>> Clicking on links to tiddlers that are already open causes them to close\n^^(override with Control or other modifier key)^^\n<<option chkHttpReadOnly>> HideEditingFeatures when viewed over HTTP\n<<option chkForceMinorUpdate>> Treat edits as MinorChanges by preserving date and time\n^^(override with Shift key when clicking 'done' or by pressing Ctrl-Shift-Enter^^",
		SideBarTabs: "<<tabs txtMainTab Timeline Timeline TabTimeline All 'All tiddlers' TabAll Tags 'All tags' TabTags More 'More lists' TabMore>>",
		TabTimeline: "<<timeline>>",
		TabAll: "<<list all>>",
		TabTags: "<<allTags>>",
		TabMore: "<<tabs txtMoreTab Missing 'Missing tiddlers' TabMoreMissing Orphans 'Orphaned tiddlers' TabMoreOrphans>>",
		TabMoreMissing: "<<list missing>>",
		TabMoreOrphans: "<<list orphans>>"
		},
	// Miscellaneous options
	numRssItems: 20, // Number of items in the RSS feed
	animFast: 0.12, // Speed for animations (lower == slower)
	animSlow: 0.01, // Speed for EasterEgg animations
	// Messages
	messages: {
		customConfigError: "Error in systemConfig tiddler '%1' - %0",
		savedSnapshotError: "It appears that this site has been incorrectly saved.",
		subtitleUnknown: "(unknown)",
		undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
		shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
		externalLinkTooltip: "External link to %0",
		noTags: "There are no tagged tiddlers",
		notFileUrlError: "You need to save this site to a file before you can save changes",
		cantSaveError: "It's not possible to save changes using this browser. Use FireFox if you can",
		invalidFileError: "The original file '%0' does not appear to be a valid site",
		backupSaved: "Backup saved",
		backupFailed: "Failed to save backup file",
		rssSaved: "RSS feed saved",
		rssFailed: "Failed to save RSS feed file",
		emptySaved: "Empty template saved",
		emptyFailed: "Failed to save empty template file",
		mainSaved: "Main site file saved",
		mainFailed: "Failed to save main site file. Your changes have not been saved",
		macroError: "Error executing macro '%0'",
		overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
		unsavedChangesWarning: "WARNING! There are unsaved changes in site\n\nChoose OK to save\nChoose CANCEL to discard",
		dates: {
			months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"],
			days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
			}
		},
	views: {
		sitefied: {
			tag: {labelNoTags: "no tags", labelTags: "tags: ", tooltip: "Show tiddlers tagged with '%0'", openAllText: "Open all", openAllTooltip: "Open all of these tiddlers", popupNone: "No other tiddlers tagged with '%0'"},
			toolbarClose: {text: "close", tooltip: "Close this tiddler"},
			toolbarEdit: {text: "edit", tooltip: "Edit this tiddler"},
			toolbarPermalink: {text: "permalink", tooltip: "Permalink for this tiddler"},
			toolbarReferences: {text: "references", tooltip: "Show tiddlers that link to this one", popupNone: "No references"},
			defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it"
			},
		editor: {
			tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
			tagChooser: {text: "tags", tooltip: "Choose existing tags to add to this tiddler", popupNone: "There are no tags defined", tagTooltip: "Add the tag '%0'"},
			toolbarDone: {text: "done", tooltip: "Save changes to this tiddler"},
			toolbarCancel: {text: "cancel", tooltip: "Undo changes to this tiddler"},
			toolbarDelete: {text: "delete", tooltip: "Delete this tiddler"},
			defaultText: "Type the text for '%0'"
			}
		},
	macros: { // Each has a 'handler' member that is inserted later
		today: {},
		version: {},
		search: {label: "search", prompt: "Search this site", sizeTextbox: 15, accessKey: "F", successMsg: "%0 tiddlers found matching %1", failureMsg: "No tiddlers found matching %0"},
		tiddler: {},
		tag: {},
		timeline: {dateFormat: "DD MMM YYYY"},
		allTags: {tooltip: "Show tiddlers tagged with '%0'", noTags: "There are no tagged tiddlers"},
		list: {
			all: {prompt: "All tiddlers in alphabetical order"},
			missing: {prompt: "Tiny that have links to them but are not defined"},
			orphans: {prompt: "Tiny that are not linked to from any other tiddlers"},
			shadowed: {prompt: "Tiny shadowed with default contents"}
			},
		closeAll: {label: "close all", prompt: "Close all displayed tiddlers (except any that are being edited)"},
		permaview: {label: "permaview", prompt: "Link to an URL that retrieves all the currently displayed tiddlers"},
		saveChanges: {label: "save changes", prompt: "Save all tiddlers to create a new site", accessKey: "S"},
		slider: {},
		option: {},
		newTiddler: {label: "new tiddler", prompt: "Create a new tiddler", title: "New Tiddler", accessKey: "N"},
		newJournal: {label: "new journal", prompt: "Create a new tiddler from the current date and time", accessKey: "J"},
		sparkline: {},
		tabs: {},
		gradient: {}
		},
	textPrimitives: {}
};

config.textPrimitives.upperLetter = "[A-Z\u00c0-\u00de\u0150\u0170]";
config.textPrimitives.lowerLetter = "[a-z\u00df-\u00ff_0-9\\-\u0151\u0171]";
config.textPrimitives.anyLetter = "[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-\u0150\u0170\u0151\u0171]";
config.textPrimitives.anyDigit = "[0-9]";
config.textPrimitives.anyNumberChar = "[0-9\\.E]";
config.textPrimitives.urlPattern = "(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unsiteLink = "~";
config.textPrimitives.siteLink = "(?:" + config.textPrimitives.unsiteLink + "{0,1})(?:(?:" + config.textPrimitives.upperLetter + "+" +
											   config.textPrimitives.lowerLetter + "+" +
											   config.textPrimitives.upperLetter +
											   config.textPrimitives.anyLetter + "*)|(?:" +
											   config.textPrimitives.upperLetter + "{2,}" +
											   config.textPrimitives.lowerLetter + "+))";

// ---------------------------------------------------------------------------------
// Shadow stylesheet elements
// ---------------------------------------------------------------------------------

config.shadowTiny.StyleSheetColors = "body {\n	background: #fff;\n}\n\n#titleLine {\n	color: #fff;\n	background: #300;\n}\n\n#titleLine a {\n	color: #cf6;\n}\n\n#mainMenu {\n	color: #000;\n}\n\n#mainMenu .tiddlyLink {\n	color: #963;\n}\n\n#mainMenu .tiddlyLink:hover {\n	background: #963;\n	color: #fff;\n}\n\n#mainMenu .externalLink {\n	color: #963;\n}\n\n#mainMenu .externalLink:hover {\n	background: #963;\n	color: #fff;\n}\n\n#mainMenu .button {\n	color: #930;\n}\n\n#mainMenu .button:hover {\n	color: #cf6;\n	background: #930;\n}\n\n#messageArea {\n	background: #930;\n	color: #fff;\n}\n\n#messageArea a:link, #messageArea a:visited {\n	color: #c90;\n}\n\n#messageArea a:hover {\n	color: #963;\n}\n\n#messageArea a:active {\n	color: #fff;\n}\n\n.popup {\n	background: #eea;\n	border: 1px solid #930;\n}\n\n.popup hr {\n	color: #963;\n	background: #963;\n	border: 0;\n}\n\n.popup li.disabled {\n	color: #ba9;\n}\n\n.popup li a, .popup li a:visited {\n	color: #300;\n}\n\n.popup li a:hover {\n	background: #930;\n	color: #eea;\n}\n\n.tabSelected {\n	background: #eea;\n}\n\n.tabUnselected {\n	background: #c90;\n}\n\n.tabContents {\n	background: #eea;\n}\n\n.tiddler .button {\n	color: #930;\n}\n\n.tiddler .button:hover {\n	color: #cf6;\n	background: #930;\n}\n\n.tiddler .button:active {\n	color: #fff;\n	background: #c90;\n}\n\n.toolbar {\n	color: #aaa;\n}\n\n.footer {\n	color: #ddd;\n}\n\n.selectedTiddler .footer {\n	color: #888;\n}\n\n.viewer {\n	color: #000;\n}\n\n.viewer a:link, .body a:visited {\n	color: #963;\n}\n\n.viewer a:hover {\n	color: #fff;\n	background: #963;\n}\n\n.viewer .button {\n	background: #c90;\n	color: #300;\n	border-right: 1px solid #300;\n	border-bottom: 1px solid #300;\n}\n\n.viewer .button:hover {\n	background: #eea;\n	color: #c90;\n}\n\n.viewer blockquote {\n	border-left: 3px solid #666;\n}\n\n.viewer h1,.viewer h2,.viewer h3,.viewer h4,.viewer h5 {\n	background: #cc9;\n}\n\n.viewer table {\n	border: 2px solid #303030;\n}\n\n.viewer th {\n	background: #996;\n	border: 1px solid #606060;\n	color: #fff;\n}\n\n.viewer td, .viewer tr {\n	border: 1px solid #606060;\n}\n\n.viewer pre {\n	color: #000000;\n	border: 1px solid #963;\n	background: #eea;\n}\n\n.viewer code {\n	color: #630;\n}\n\n.viewer hr {\n	border-top: dashed 1px #606060;\n	border-left: none;\n	border-right: none;\n	border-bottom: none;\n	color: #666;\n}\n\n.highlight, .marked {\n	color: #000;\n	background: #ffe72f;\n}\n\n.editor {\n	color: #402C74;\n}\n\n.editor input {\n	border: 1px solid #000000;\n}\n\n.editor textarea {\n	border: 1px solid #000000;\n	width: 100%;\n}\n\n.editorFooter {\n	color: #aaa;\n}\n\n.editorFooter A {\n	color: #930;\n}\n\n.editorFooter A:hover {\n	color: #cf6;\n	background: #930;\n}\n\n.editorFooter A:active {\n	color: #fff;\n	background: #c90;\n}\n\n#sidebar {\n	color: #000;\n}\n\n#sidebarOptions {\n	background: #c90;\n}\n\n#sidebarOptions .button {\n	color: #930;\n}\n\n#sidebarOptions .button:hover {\n	color: #cf6;\n	background: #930;\n}\n\n#sidebarOptions .button:active {\n	color: #930;\n	background: #cf6;\n}\n\n#sidebarOptions .sliderPanel {\n	background: #eea;\n}\n\n#sidebarOptions .sliderPanel A {\n	color: #930;\n}\n\n#sidebarOptions .sliderPanel A:hover {\n	color: #cf6;\n	background: #930;\n}\n\n#sidebarOptions .sliderPanel A:active {\n	color: #930;\n	background: #cf6;\n}\n\n.sidebarSubHeading {\n	color: #300;\n}\n\n#sidebarTabs {\n	background: #c90;\n}\n\n#sidebarTabs .tabSelected {\n	color: #cf6;\n	background: #963;\n}\n\n#sidebarTabs .tabUnselected {\n	color: #cf6;\n	background: #930;\n}\n\n#sidebarTabs .tabContents {\n	background: #963;\n}\n\n\n#sidebarTabs .txtMoreTab .tabSelected {\n	background: #930;\n}\n\n#sidebarTabs .txtMoreTab .tabUnselected {\n	background: #300;\n}\n\n#sidebarTabs .txtMoreTab .tabContents {\n	background: #930;\n}\n\n#sidebarTabs .tabContents .tiddlyLink {\n	color: #cf6;\n}\n\n#sidebarTabs .tabContents .tiddlyLink:hover {\n	background: #ccff66;\n	color: #300;\n}\n\n#sidebarTabs .tabContents .button {\n	color: #cf6;\n}\n\n#sidebarTabs .tabContents .button:hover {\n	color: #300;\n	background: #cf6;\n}\n\n.sparkline {\n	background: #eea;\n	border: 0;\n}\n\n.sparktick {\n	background: #930;\n}\n\n.errorNoSuchMacro {\n	color: #ff0;\n	background: #f00;\n}\n\n.zoomer {\n	color: #963;\n	border: 1px solid #963;\n}";
config.shadowTiny.StyleSheetLayout = "body {\n	font-size: 9pt;\n	font-family: verdana,arial,helvetica;\n	margin: 0;\n	padding: 0;\n	position: relative;\n	z-index: 0;\n}\n\na:link, a:visited, a:hover, a:active{\n	text-decoration: none;\n}\n\n#contentWrapper {\n	position: relative;\n}\n\n#titleLine {\n	padding: 5em 1em 1em 1em;\n}\n\n#siteTitle {\n	font-size: 26pt;\n}\n\n#siteSubtitle {\n	padding-left: 1em;\n	font-size: 10pt;\n}\n\n#mainMenu {\n	position: absolute;\n	left: 0em;\n	width: 10em;\n	line-height: 166%;\n	padding: 1.5em 0.5em 0.5em 0.5em;\n	font-size: 10pt;\n	text-align: right;\n}\n\n\n#mainMenu .externalLink {\n	text-decoration: underline;\n}\n\n#displayArea {\n	margin: 1em 17em 0em 14em;\n}\n\n#messageArea {\n	padding: 0.5em;\n\n}\n\n#messageArea a:link, #messageArea a:visited {\n	display: inline;\n	text-decoration: underline;\n}\n\n.popup {\n	font-size: 8pt;\n	list-style: none;\n	padding: 0.2em;\n	margin: 0;\n}\n\n.popup hr {\n	display: block;\n	height: 1px;\n	width: auto;\n	padding: 0;\n	margin: 0.2em 0em;\n}\n\n.popup li {\n	display: block;\n	padding: 0;\n}\n\n.popup li.disabled {\n	padding: 0.2em;\n}\n\n.popup li a, .popup li a:visited {\n	display: block;\n	text-decoration: none;\n	padding: 0.2em;\n}\n\n.tabset {\n	padding: 1em 0em 0em 0.5em;\n}\n\n.tab {\n	margin: 0em 0em 0em 0.25em;\n	padding: 2px;\n}\n\n.tabContents {\n	padding: 0.5em;\n}\n\n.tabContents ul, .tabContents ol {\n	margin: 0;\n	padding: 0;\n}\n\n.tabContents li {\n	list-style: none;\n}\n\n.tabContents li.listLink {\n   margin-left: .75em;\n}\n\n.tiddler {\n	padding: 0;\n	padding: 1em 1em 0em 1em;\n	font-size: 9pt;\n}\n\n\n/* Can these styles be moved to the previous rule?\n.selectedTiddler {\n	padding: 1em 1em 0em 1em;\n	font-size: 9pt;\n}\n\n.unselectedTiddler {\n	padding: 1em 1em 0em 1em;\n	font-size: 9pt;\n} */\n\n.tiddler a.tiddlyLinkExisting {\n	font-weight: bold;\n}\n\n.tiddler a.tiddlyLinkNonExisting {\n	font-style: italic;\n}\n\n.tiddler a.tiddlyLinkNonExisting.shadow {\n	font-weight: bold;\n}\n\n.tiddler a.externalLink {\n	text-decoration: underline;\n}\n\n.tiddler .button {\n	padding: 0.2em 0.4em;\n}\n\n.tiddler .button:hover {\n	text-decoration: none;\n}\n\n.title {\n	font-size: 10pt;\n	font-weight: bold;\n}\n\n.shadow .title {\n	color: #888888;\n}\n\n.toolbar {\n	text-align: right;\n	font-weight: normal;\n	font-size: 8pt;\n	padding: 0;\n	padding-bottom: 2em;\n	visibility: hidden;\n}\n\n.selectedTiddler .toolbar {\n	visibility: visible;\n}\n\n.footer {\n/* Isn't 'clear:both' the right rule? */\n	clear: left;\n	clear: right;\n	font-weight: normal;\n	font-size: 8pt;\n	margin: 0;\n	padding: 0;\n}\n\n.body {\n	padding-top: 0.5em;\n}\n\n.viewer {\n	line-height: 140%;\n}\n\n.viewer .button {\n	margin: 0em 0.25em;\n	padding: 0em 0.25em;\n}\n\n.viewer blockquote {\n	font-size: 8pt;\n	line-height: 150%;\n	padding-left: 0.8em;\n	margin-left: 2.5em;\n}\n\n.viewer ul {\n	margin-left: 0.5em;\n	padding-left: 1.5em;\n}\n\n.viewer ol {\n	margin-left: 0.5em;\n	padding-left: 1.5em;\n}\n\n.viewer h1,.viewer h2,.viewer h3,.viewer h4,.viewer h5 {\n	font-weight: bold;\n	text-decoration: none;\n	padding-left: 0.4em;\n}\n\n.viewer h1 {font-size: 12pt;}\n.viewer h2 {font-size: 11pt;}\n.viewer h3 {font-size: 10pt;}\n.viewer h4 {font-size: 9pt;}\n.viewer h5 {font-size: 8pt;}\n\n.viewer table {\n	border-collapse: collapse;\n	margin: 0.8em 1.0em;;\n	font-size: 100%;\n}\n\n.viewer th, .viewer td, .viewer tr,.viewer caption{\n	padding: 3px;\n}\n\n.viewer pre {\n	padding: 0.5em;\n	margin-left: 0.5em;\n	font-size: 100%;\n	line-height: 1.4em;\n	overflow: auto;\n}\n\n.viewer code {\n	font-size: 100%;\n	line-height: 1.4em;\n}\n\n.viewer hr {\n	height: 1px;\n}\n\n.editor {\n	font-size: 8pt;\n	font-weight: normal;\n}\n\n.editor input {\n	display: block;\n	width: 100%;\n}\n\n.editor textarea {\n	display: block;\n	font: inherit;\n	width: 100%;\n}\n\n.editorFooter {\n	padding: 0.25em 0em;\n	font-size: 8pt;\n}\n\n.editorFooter A {\n	padding: 0.2em 0.4em;\n}\n\n.editorFooter A:hover {\n	text-decoration: none;\n}\n\n#sidebar {\n	position: absolute;\n	right: 0em;\n	width: 16em;\n	font-size: 8pt;\n}\n\n#sidebarOptions {\n	padding-top: 0em;\n}\n\n#sidebarOptions .button {\n	padding: 0.3em 0.2em 0.3em 1em;\n	display: block;\n}\n\n#sidebarOptions input {\n	margin: 0.4em 0em 0.3em 1em;\n}\n\n#sidebarOptions .sliderPanel {\n	padding: 0.5em;\n	font-size: 7pt;\n}\n\n#sidebarOptions .sliderPanel A {\n	font-weight: bold;\n}\n\n#sidebarOptions .sliderPanel input {\n	margin: 0;\n	margin-bottom: 0.3em;\n}\n\n.sidebarSubHeading {\n	font-size: 7pt;\n}\n\n#sidebarTabs .tabSelected {\n	position: relative;\n	top: -2px;\n}\n\n\n#sidebarTabs .tabContents {\n	width: 15em;\n	overflow: hidden;\n}\n\n.sparkline {\n	line-height: 100%;\n}\n\n.sparktick {\n	outline: 0;\n}\n\n.zoomer {\n	font-size: 10pt;\n	position: absolute;\n	padding: 1em;\n}\n";

// ---------------------------------------------------------------------------------
// Main
// ---------------------------------------------------------------------------------

// site storage
var store = new site();

// Animation engine
var anim = new Animator();

var readOnly = false;

// Starting up
function main()
{
	browserTests();
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	loadOptionsCookie();
	for(var s=0; s<config.notifyTiny.length; s++)
		store.addNotification(config.notifyTiny[s].name,config.notifyTiny[s].notify);
	store.loadFromDiv("storeArea","store");
	loadSystemConfig();
	readOnly = (document.location.toString().substr(0,7) == "http://") ? config.options.chkHttpReadOnly : false;
	store.notifyAll();
	restart();
}

// Restarting
function restart()
{
	var start = store.getTiddlerText("DefaultTiny");
	if(window.location.hash)
		displayTiny(null,convertUTF8ToUnicode(decodeURI(window.location.hash.substr(1))),1,null,null);
	else if(start)
		displayTiny(null,start,1,null,null);
}

// Shame...
function browserTests()
{
	var a = navigator.userAgent.toLowerCase();
	config.browser = {
		isIE: a.indexOf("msie") != -1 && a.indexOf("opera") == -1
		};
}

function saveTest()
{
	var saveTest = document.getElementById("saveTest");
	if(saveTest.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	saveTest.appendChild(document.createTextNode("savetest"));
}

function loadSystemConfig()
{
	var configTiny = store.getTaggedTiny("systemConfig");
	for(var t=0; t<configTiny.length; t++)
		{
		var ex = processConfig(configTiny[t].text);
		if(ex)
			displayMessage(config.messages.customConfigError.format([ex,configTiny[t].title]));
		}
}

// Merge a custom configuration over the top of the current configuration
// Returns a string error message or null if it went OK
function processConfig(customConfig)
{
	try
		{
		if(customConfig && customConfig != "")
			window.eval(customConfig);
		}
	catch(e)
		{
		//return(e.toString());
		}
	return null;
}

// ---------------------------------------------------------------------------------
// Formatters
// ---------------------------------------------------------------------------------

config.formatterHelpers = {

	charFormatHelper: function(w)
	{
		var e = createTiddlyElement(w.output,this.element);
		w.subsitefy(e,this.terminator);
	},
	
	inlineCssHelper:  function(w)
	{
		var styles = [];
		var lookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
		var lookaheadRegExp = new RegExp(lookahead,"mg");
		var hadStyle = false;
		do {
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var gotMatch = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(gotMatch)
				{
				var s,v;
				hadStyle = true;
				if(lookaheadMatch[1])
					{
					s = lookaheadMatch[1].unDash();
					v = lookaheadMatch[2];
					}
				else
					{
					s = lookaheadMatch[3].unDash();
					v = lookaheadMatch[4];
					}
				switch(s)
					{
					case "bgcolor": s = "backgroundColor"; break;
					}
				styles.push({style: s, value: v});
				w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
				}
		} while(gotMatch);
		return styles;
	},

	monospacedByLineHelper: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			var e = createTiddlyElement(w.output,"pre",null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}

};

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhc]?)$",
	lookahead: "^\\|([^\\n]*)\\|([fhc]?)$",
	rowTerminator: "\\|(?:[fhc]?)$\\n?",
	cellPattern: "(?:\\|([^\\n\\|]*)\\|)|(\\|[fhc]?$\\n?)",
	cellTerminator: "(?:\\x20*)\\|",
	rowTypes: {"c": "caption", "h": "thead", "": "tbody", "f": "tfoot"},
	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table");
		w.nextMatch = w.matchStart;
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		var currRowType = null, nextRowType;
		var rowContainer, rowElement;
		var prevColumns = [];
		var rowCount = 0;
		do {
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched)
				{
				nextRowType = lookaheadMatch[2];
				if(nextRowType != currRowType)
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
				currRowType = nextRowType;
				if(currRowType == "c")
					{
					if(rowCount == 0)
						rowContainer.setAttribute("align","top");
					else
						rowContainer.setAttribute("align","bottom");
					w.nextMatch = w.nextMatch + 1;
					w.subsitefy(rowContainer,this.rowTerminator);
					}
				else
					{
					rowElement = createTiddlyElement(rowContainer,"tr");
					this.rowHandler(w,rowElement,prevColumns);
					}
				rowCount++;
				}
		} while(matched);
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var currColCount = 1;
		var cellRegExp = new RegExp(this.cellPattern,"mg");
		do {
			cellRegExp.lastIndex = w.nextMatch;
			var cellMatch = cellRegExp.exec(w.source);
			matched = cellMatch && cellMatch.index == w.nextMatch;
			if(matched)
				{
				if(cellMatch[1] == "~")
					{
					var last = prevColumns[col];
					if(last)
						{
						last.rowCount++;
						last.element.setAttribute("rowSpan",last.rowCount);
						last.element.setAttribute("rowspan",last.rowCount);
						last.element.valign = "center";
						}
					w.nextMatch = cellMatch.index + cellMatch[0].length-1;
					}
				else if(cellMatch[1] == ">")
					{
					currColCount++;
					w.nextMatch = cellMatch.index + cellMatch[0].length-1;
					}
				else if(cellMatch[2])
					{
					w.nextMatch = cellMatch.index + cellMatch[0].length;;
					break;
					}
				else
					{
					var spaceLeft = false, spaceRight = false;
					w.nextMatch++;
					var styles = config.formatterHelpers.inlineCssHelper(w);
					while(w.source.substr(w.nextMatch,1) == " ")
						{
						spaceLeft = true;
						w.nextMatch++;
						}
					var cell;
					if(w.source.substr(w.nextMatch,1) == "!")
						{
						cell = createTiddlyElement(e,"th");
						w.nextMatch++;
						}
					else
						cell = createTiddlyElement(e,"td");
					prevColumns[col] = {rowCount: 1, element: cell};
					lastColCount = 1;
					lastColElement = cell;
					if(currColCount > 1)
						{
						cell.setAttribute("colSpan",currColCount);
						cell.setAttribute("colspan",currColCount);
						currColCount = 1;
						}
					for(var t=0; t<styles.length; t++)
						cell.style[styles[t].style] = styles[t].value;
					w.subsitefy(cell,this.cellTerminator);
					if(w.matchText.substr(w.matchText.length-2,1) == " ")
						spaceRight = true;
					if(spaceLeft && spaceRight)
						cell.align = "center";
					else if (spaceLeft)
						cell.align = "right";
					else if (spaceRight)
						cell.align = "left";
					w.nextMatch = w.nextMatch-1;
					}
				col++;
				}
		} while(matched);		
	}
},

{
	name: "rule",
	match: "^----$\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "heading",
	match: "^!{1,5}",
	terminator: "\\n",
	handler: function(w)
	{
		var e = createTiddlyElement(w.output,"h" + w.matchLength);
		w.subsitefy(e,this.terminator);
	}
},

{
	name: "monospacedByLine",
	match: "^\\{\\{\\{\\n",
	lookahead: "^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)",
	handler: config.formatterHelpers.monospacedByLineHelper
},

{
	name: "monospacedByLineForPlugin",
	match: "^//\\{\\{\\{\\n",
	lookahead: "^//\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^//\\}\\}\\}$\\n?)",
	handler: config.formatterHelpers.monospacedByLineHelper
},

{
	name: "sitefyCommentForPlugin", 
	match: "^/\\*\\*\\*\\n",
	terminator: "^\\*\\*\\*/\\n",
	handler: function(w)
	{
		w.subsitefy(w.output,this.terminator);
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	terminator: "^<<<\\n",
	handler: function(w)
	{
		var e = createTiddlyElement(w.output,"blockquote");
		w.subsitefy(e,this.terminator);
	}
},

{
	name: "quoteByLine",
	match: "^>+",
	terminator: "\\n",
	element: "blockquote",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.match,"mg");
		var placeStack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel)
				{
				for(t=currLevel; t<newLevel; t++)
					placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],this.element));
				}
			else if(newLevel < currLevel)
				{
				for(t=currLevel; t>newLevel; t--)
					placeStack.pop();
				}
			currLevel = newLevel;
			w.subsitefy(placeStack[placeStack.length-1],this.terminator);
			createTiddlyElement(placeStack[placeStack.length-1],"br");
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched)
				{
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				}
		} while(matched);
	}
},

{
	name: "list",
	match: "^(?:(?:\\*+)|(?:#+))",
	lookahead: "^(?:(\\*+)|(#+))",
	terminator: "\\n",
	outerElement: "ul",
	itemElement: "li",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		w.nextMatch = w.matchStart;
		var placeStack = [w.output];
		var currType = null, newType;
		var currLevel = 0, newLevel;
		var t;
		do {
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched)
				{
				if(lookaheadMatch[1])
					newType = "ul";
				if(lookaheadMatch[2])
					newType = "ol";
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				if(newLevel > currLevel)
					{
					for(t=currLevel; t<newLevel; t++)
						placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],newType));
					}
				else if(newLevel < currLevel)
					{
					for(t=currLevel; t>newLevel; t--)
						placeStack.pop();
					}
				else if(newLevel == currLevel && newType != currType)
					{
						placeStack.pop();
						placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],newType));
					}
				currLevel = newLevel;
				currType = newType;
				var e = createTiddlyElement(placeStack[placeStack.length-1],"li");
				w.subsitefy(e,this.terminator);
				}
		} while(matched);
	}
},

{
	name: "siteLink",
	match: config.textPrimitives.siteLink,
	badPrefix: config.textPrimitives.anyLetter,
	handler: function(w)
	{
		var preRegExp = new RegExp(config.textPrimitives.anyLetter,"mg");
		var preMatch = null;
		if(w.matchStart > 0)
			{
			preRegExp.lastIndex = w.matchStart-1;
			preMatch = preRegExp.exec(w.source);
			}
		if(preMatch && preMatch.index == w.matchStart-1)
			w.outputText(w.output,w.matchStart,w.nextMatch);
		else if(w.matchText.substr(0,1) == config.textPrimitives.unsiteLink)
			w.outputText(w.output,w.matchStart + 1,w.nextMatch);
		else
			{
			var link = createTiddlyLink(w.output,w.matchText,false);
			w.outputText(link,w.matchStart,w.nextMatch);
			}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookahead: "\\[\\[([^\\|\\]]*?)(?:(\\]\\])|(\\|(.*?)\\]\\]))",
	terminator: "\\|",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[2]) // Simple bracketted link
			{
			var link = createTiddlyLink(w.output,lookaheadMatch[1],false);
			w.outputText(link,w.nextMatch,w.nextMatch + lookaheadMatch[1].length);
			w.nextMatch += lookaheadMatch[1].length + 2;
			}
		else if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[3]) // Pretty bracketted link
			{
			var e;
			if(store.tiddlerExists(lookaheadMatch[4]))
				e = createTiddlyLink(w.output,lookaheadMatch[4],false);
			else
				e = createExternalLink(w.output,lookaheadMatch[4]);
			w.outputText(e,w.nextMatch,w.nextMatch + lookaheadMatch[1].length);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "urlLink",
	match: "(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)",
	handler: function(w)
	{
		var e = createExternalLink(w.output,w.matchText);
		w.outputText(e,w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[(?:[<]{0,1})(?:[>]{0,1})[Ii][Mm][Gg]\\[",
	lookahead: "\\[([<]{0,1})([>]{0,1})[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\]?)?(\\])",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) // Simple bracketted link
			{
			var e = w.output;
			if(lookaheadMatch[5])
				{
				if(store.tiddlerExists(lookaheadMatch[5]))
					e = createTiddlyLink(w.output,lookaheadMatch[5],false);
				else
					e = createExternalLink(w.output,lookaheadMatch[5]);
				}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3])
				img.title = lookaheadMatch[3];
			img.src = lookaheadMatch[4];
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "macro",
	match: "<<",
	lookahead: "<<([^>\\s]+)(?:\\s*)([^>]*)>>",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1])
			{
			var params = lookaheadMatch[2].readMacroParams();			
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			try
				{
				var macro = config.macros[lookaheadMatch[1]];
				if(macro && macro.handler)
					macro.handler(w.output,lookaheadMatch[1],params,w);
				else
					createTiddlyElement(w.output,"span",null,"errorNoSuchMacro","<<" + lookaheadMatch[1] + ">>");
				}
			catch(e)
				{
				displayMessage(config.messages.macroError.format([lookaheadMatch[1]]));
				displayMessage(e.toString());
				}
			}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookahead: "<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)</[Hh][Tt][Mm][Ll]>",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var e = createTiddlyElement(w.output,"span");
			e.innerHTML = lookaheadMatch[1];
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookahead: "/%((?:.|\\n)*?)%/",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
	}
},

{
	name: "boldByChar",
	match: "''",
	terminator: "''",
	element: "strong",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "strikeByChar",
	match: "==",
	terminator: "==",
	element: "strike",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "underlineByChar",
	match: "__",
	terminator: "__",
	element: "u",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "italicByChar",
	match: "//",
	terminator: "//",
	element: "em",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "subscriptByChar",
	match: "~~",
	terminator: "~~",
	element: "sub",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "superscriptByChar",
	match: "\\^\\^",
	terminator: "\\^\\^",
	element: "sup",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "monospacedByChar",
	match: "\\{\\{\\{",
	lookahead: "\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var e = createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "styleByChar",
	match: "@@",
	terminator: "@@",
	lookahead: "(?:([^\\(@]+)\\(([^\\)]+)(?:\\):))|(?:([^:@]+):([^;]+);)",
	handler:  function(w)
	{
		var e = createTiddlyElement(w.output,"span",null,null,null);
		var styles = config.formatterHelpers.inlineCssHelper(w);
		if(styles.length == 0)
			e.className = "marked";
		else
			for(var t=0; t<styles.length; t++)
				e.style[styles[t].style] = styles[t].value;
		w.subsitefy(e,this.terminator);
	}
},

{
	name: "lineBreak",
	match: "\\n",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
}
];

// ---------------------------------------------------------------------------------
// sitefier
// ---------------------------------------------------------------------------------

function sitefy(source,output,highlightText,highlightCaseSensitive)
{
	var w = new sitefier(source,output,config.formatters,highlightText,highlightCaseSensitive);
}

function sitefier(source,output,formatters,highlightText,highlightCaseSensitive)
{
	this.source = source;
	this.output = output;
	this.nextMatch = 0;
	this.highlightText = highlightText;
	this.highlightCaseSensitive = highlightCaseSensitive;
	this.highlightRegExp = null;
	this.highlightMatch = null;
	this.assembleFormatterMatches(formatters);
	if(highlightText)
		{
		this.highlightRegExp = new RegExp(highlightText,highlightCaseSensitive ? "mg" : "img");
		this.highlightMatch = this.highlightRegExp.exec(this.source);
		}
	if(source && source != "")
		this.subsitefy(output,null);
	return this;
}

sitefier.prototype.assembleFormatterMatches = function(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++)
		{
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
		}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

sitefier.prototype.subsitefy = function(output,terminator)
{
	// Temporarily replace the output pointer
	var oldOutput = this.output;
	this.output = output;
	// Prepare the terminator RegExp
	var terminatorRegExp = terminator ? new RegExp("(" + terminator + ")","mg") : null;
	do {
		// Prepare the RegExp match positions
		this.formatterRegExp.lastIndex = this.nextMatch;
		if(terminatorRegExp)
			terminatorRegExp.lastIndex = this.nextMatch;
		// Get the first matches
		var formatterMatch = this.formatterRegExp.exec(this.source);
		var terminatorMatch = terminatorRegExp ? terminatorRegExp.exec(this.source) : null;
		// Check for a terminator match
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index))
			{
			// Output any text before the match
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			// Set the match parameters
			this.matchStart = terminatorMatch.index;
			this.matchLength = terminatorMatch[1].length;
			this.matchText = terminatorMatch[1];
			this.nextMatch = terminatorMatch.index + terminatorMatch[1].length;
			// Restore the output pointer and exit
			this.output = oldOutput;
			return;		
			}
		// Check for a formatter match
		else if(formatterMatch)
			{
			// Output any text before the match
			if(formatterMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,formatterMatch.index);
			// Set the match parameters
			this.matchStart = formatterMatch.index;
			this.matchLength = formatterMatch[0].length;
			this.matchText = formatterMatch[0];
			this.nextMatch = this.formatterRegExp.lastIndex;
			// Figure out which formatter matched
			var matchingformatter = -1;
			for(var t=1; t<formatterMatch.length; t++)
				if(formatterMatch[t])
					matchingFormatter = t-1;
			// Call the formatter
			if(matchingFormatter != -1)
				this.formatters[matchingFormatter].handler(this);
			}
	} while(terminatorMatch || formatterMatch);
	// Output any text after the last match
	if(this.nextMatch < this.source.length)
		{
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
		}
	// Restore the output pointer
	this.output = oldOutput;
}

sitefier.prototype.outputText = function(place,startPos,endPos)
{
	// Check for highlights
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos))
		{
		// Deal with any plain text before the highlight
		if(this.highlightMatch.index > startPos)
			{
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
			}
		// Deal with the highlight
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		// Nudge along to the next highlight if we're done with this one
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
		}
	// Do the unhighlighted text left over
	if(startPos < endPos)
		{
		createTiddlyText(place,this.source.substring(startPos,endPos));
		}
}

// ---------------------------------------------------------------------------------
// Macro definitions
// ---------------------------------------------------------------------------------

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text;
	if(params[0])
		text = now.formatString(params[0].trim());
	else
		text = now.toLocaleString();
	createTiddlyElement(place,"span",null,null,text);
}

config.macros.version.handler = function(place)
{
	createTiddlyElement(place,"span",null,null,version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
}

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] ? params[0] : "all";
	var theList = document.createElement("ul");
	place.appendChild(theList);
	if(this[type].prompt)
		createTiddlyElement(theList,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for (t = 0; t < results.length; t++)
		{
		theListItem = document.createElement("li")
		theList.appendChild(theListItem);
		if(typeof results[t] == "string")
			createTiddlyLink(theListItem,results[t],true);
		else
			createTiddlyLink(theListItem,results[t].title,true);
		}
}

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
}

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
}

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
}

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
}

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags();
	var theDateList = createTiddlyElement(place,"ul",null,null,null);
	if(tags.length == 0)
		createTiddlyElement(theDateList,"li",null,"listTitle",this.noTags);
	for (t=0; t<tags.length; t++)
		{
		var theListItem =createTiddlyElement(theDateList,"li",null,null,null);
		var theTag = createTiddlyButton(theListItem,tags[t][0] + " (" + tags[t][1] + ")",this.tooltip.format([tags[t][0]]),onClickTag);
		theTag.setAttribute("tag",tags[t][0]);
		}
}

config.macros.timeline.handler = function(place,macroName,params)
{
	var tiddlers = store.reverseLookup("tags","excludeLists",false,"modified");
	var lastDay = "";
	for (t=tiddlers.length-1; t>=0; t--)
		{
		var tiddler = tiddlers[t];
		var theDay = tiddler.modified.convertToYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay)
			{
			var theDateList = document.createElement("ul");
			place.appendChild(theDateList);
			createTiddlyElement(theDateList,"li",null,"listTitle",tiddler.modified.formatString(this.dateFormat));
			lastDay = theDay;
			}
		var theDateListItem = createTiddlyElement(theDateList,"li",null,"listLink",null);
		theDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));
		}
}

config.macros.search.handler = function(place,macroName,params)
{
	var lastSearchText = "";
	var searchTimeout = null;
	var doSearch = function(txt)
		{
		closeAllTiny();
		var matches = store.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch,"title","excludeSearch");
		for(var t=matches.length-1; t>=0; t--)
			displayTiddler(null,matches[t].title,0,txt.value,config.options.chkCaseSensitiveSearch,false,false);
		var q = config.options.chkRegExpSearch ? "/" : "'";
		if(matches.length > 0)
			displayMessage(config.macros.search.successMsg.format([matches.length.toString(),q + txt.value + q]));
		else
			displayMessage(config.macros.search.failureMsg.format([q + txt.value + q]));
		lastSearchText = txt.value;
		};
	var clickHandler = function(e)
		{
		doSearch(this.nextSibling);
		return false;
		};
	var keyHandler = function(e)
		{
		if (!e) var e = window.event;
		switch(e.keyCode)
			{
			case 27:
				this.value = "";
				clearMessage();
				break;
			}
		if((this.value.length > 2) && (this.value != lastSearchText))
			{
			if(searchTimeout)
				clearTimeout(searchTimeout);
			var txt = this;
			searchTimeout = setTimeout(function() {doSearch(txt);},500);
			}
		};
	var focusHandler = function(e)
		{
		this.select();
		};
	var btn = createTiddlyButton(place,this.label,this.prompt,clickHandler);
	var txt = createTiddlyElement(place,"input",null,null,null);
	if(params[0])
		txt.value = params[0];
	txt.onkeyup = keyHandler;
	txt.onfocus = focusHandler;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",this.accessKey);
	txt.setAttribute("autocomplete","off");
	if(navigator.userAgent.toLowerCase().indexOf("safari") == -1)
		txt.setAttribute("type","text");
	else
		{
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
		}
}

config.macros.tiddler.handler = function(place,macroName,params)
{
	var wrapper = createTiddlyElement(place,"span",null,params[1] ? params[1] : null,null);
	var text = store.getTiddlerText(params[0]);
	if(text)
		sitefy(text,wrapper);
}

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0]);
}

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,function () {closeAllTiny(); return false;});
}

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,function () {onClickPermaView(); return false;});
}

config.macros.saveChanges.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place,this.label,this.prompt,function () {saveChanges(); return false;},null,null,this.accessKey);
}

config.macros.slider.onClickSlider = function(e)
{
	if (!e) var e = window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate)
		anim.startAnimating(new Slider(n,!isOpen,e.shiftKey || e.altKey,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOptionCookie(cookie);
	return false;
}

config.macros.slider.handler = function(place,macroName,params)
{
	var cookie = params[0] ? params[0] : "";
	var text = store.getTiddlerText(params[1]);
	var btn = createTiddlyButton(place,params[2],params[3],this.onClickSlider);
	var panel = createTiddlyElement(place,"div",null,"sliderPanel",null);
	panel.setAttribute("cookie",cookie);
	panel.style.display = config.options[cookie] ? "block" : "none";
	if(text)
		sitefy(text,panel);
}

config.macros.option.onChangeOption = function(e)
{
	var opt = this.getAttribute("option");
	var elementType,valueField;
	if(opt)
		{
		switch(opt.substr(0,3))
			{
			case "txt":
				elementType = "input";
				valueField = "value";
				break;
			case "chk":
				elementType = "input";
				valueField = "checked";
				break;
			}
		config.options[opt] = this[valueField];
		saveOptionCookie(opt);
		var nodes = document.getElementsByTagName(elementType);
		for(var t=0; t<nodes.length; t++)
			{
			var optNode = nodes[t].getAttribute("option");
			if(opt == optNode)
				nodes[t][valueField] = this[valueField];
			}
		}
	return(true);
}

config.macros.option.handler = function(place,macroName,params)
{
	var opt = params[0];
	if(config.options[opt] == undefined)
		return;
	var c;
	switch(opt.substr(0,3))
		{
		case "txt":
			c = document.createElement("input");
			c.onkeyup = this.onChangeOption;
			c.setAttribute("option",opt);
			c.size = 15;
			place.appendChild(c);
			c.value = config.options[opt];
			break;
		case "chk":
			c = document.createElement("input");
			c.setAttribute("type","checkbox");
			c.onclick = this.onChangeOption;
			c.setAttribute("option",opt);
			place.appendChild(c);
			c.checked = config.options[opt];
			break;
		}
}

config.macros.newTiddler.onClick = function()
{
	displayTiddler(null,config.macros.newTiddler.title,2,null,null,false,false);
	var e = document.getElementById("editorTitle" + config.macros.newTiddler.title);
	e.focus();
	e.select();
	return false;
}

config.macros.newTiddler.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
}

config.macros.newJournal.handler = function(place,macroName,params)
{
	if(!readOnly)
		{
		var now = new Date();
		var title = now.formatString(params[0].trim());
		var createJournal = function() {
			displayTiddler(null,title,2,null,null,false,false);
			var tagsBox = document.getElementById("editorTags" + title);
			if(tagsBox && params[1])
				tagsBox.value += " " + String.encodeTiddlyLink(params[1]);
			return false;
			};
		createTiddlyButton(place,this.label,this.prompt,createJournal,null,null,this.accessKey);
		}
}

config.macros.sparkline.handler = function(place,macroName,params)
{
	var data = [];
	var min = 0;
	var max = 0;
	for(var t=0; t<params.length; t++)
		{
		var v = parseInt(params[t]);
		if(v < min)
			min = v;
		if(v > max)
			max = v;
		data.push(v);
		}
	if(data.length < 1)
		return;
	var box = createTiddlyElement(place,"span",null,"sparkline",String.fromCharCode(160));
	box.title = data.join(",");
	var w = box.offsetWidth;
	var h = box.offsetHeight;
	box.style.paddingRight = (data.length * 2 - w) + "px";
	box.style.position = "relative";
	for(var d=0; d<data.length; d++)
		{
		var tick = document.createElement("img");
		tick.border = 0;
		tick.className = "sparktick";
		tick.style.position = "absolute";
		tick.src = "data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B";
		tick.style.left = d*2 + "px";
		tick.style.width = "2px";
		var v = Math.floor(((data[d] - min)/(max-min)) * h);
		tick.style.top = (h-v) + "px";
		tick.style.height = v + "px";
		box.appendChild(tick);
		}
}

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(place,"div",null,cookie,null);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset",null);
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++)
		{
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
		}
	if(!validTab)
		config.options[cookie] = params[1];
	this.switchTab(tabset,config.options[cookie]);
}

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
}

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++)
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab)
			{
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
			}
		else
			nodes[t].className = "tab tabUnselected"
	if(theTab)
		{
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			tabset.parentNode.removeChild(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents",null);
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		sitefy(store.getTiddlerText(theTab.getAttribute("content")),tabContent);
		if(cookie)
			{
			config.options[cookie] = tab;
			saveOptionCookie(cookie);
			}
		}
}

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,sitefier)
{
	var terminator = ">>";
	var panel = createTiddlyElement(place,"div",null,"gradient",null);
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	var styles = config.formatterHelpers.inlineCssHelper(sitefier);
	var t;
	for(t=0; t<styles.length; t++)
		panel.style[styles[t].style] = styles[t].value;
	var colours = [];
	for(t=1; t<params.length; t++)
		{
		var c = new RGB(params[t]);
		if(c)
			colours.push(c);
		}
	drawGradient(panel,params[0] != "vert",colours);
	sitefier.subsitefy(panel,terminator);
	if(document.all)
		{
		panel.style.height = "100%";
		panel.style.width = "100%";
		}
}

// ---------------------------------------------------------------------------------
// Tiddler() object
// ---------------------------------------------------------------------------------

function Tiddler()
{
	this.title = null;
	this.text = null;
	this.modifier = null;
	this.modified = new Date();
	this.links = [];
	this.tags = [];
	return this;
}

// Load a tiddler from an HTML DIV
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
	var text = Tiddler.unescapeLineBreaks(divRef.firstChild ? divRef.firstChild.nodeValue : "");
	var modifier = divRef.getAttribute("modifier");
	var modified = Date.convertFromYYYYMMDDHHMM(divRef.getAttribute("modified"));
	var tags = divRef.getAttribute("tags");
	this.set(title,text,modifier,modified,tags);
	return this;
}

// Format the text for storage in an HTML DIV
Tiddler.prototype.saveToDiv = function()
{
	return '<div tiddler="' + this.title + '" modified="' +
							this.modified.convertToYYYYMMDDHHMM() + '" modifier="' + this.modifier +
							'" tags="' + this.getTags() + '">' +
							this.escapeLineBreaks().htmlEncode() + '</div>';
}

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(url)
{
	var s = [];
	s.push("<item>");
	s.push("<title>" + this.title.htmlEncode() + "</title>");
	s.push("<description>" + this.text.replace(regexpNewLine,"<br />").htmlEncode() + "</description>");
	for(var t=0; t<this.tags.length; t++)
		s.push("<category>" + this.tags[t] + "</category>");
	s.push("<link>" + url + "#" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + "</link>");
	s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
	s.push("</item>");
	return(s.join("\n"));
}

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else
		this.tags = [];
	this.changed();
	return this;
}

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	if(this.tags)
		{
		var results = [];
		for(var t=0; t<this.tags.length; t++)
			results.push(String.encodeTiddlyLink(this.tags[t]));
		return results.join(" ");
		}
	else
		return "";
}

var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");

// Static method to Convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	if(text && text != "")
		return text.replace(regexpBackSlashEn,"\n").replace(regexpBackSlashEss,"\\").replace(regexpCarriageReturn,"");
	else
		return "";
}

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.replace(regexpBackSlash,"\\s").replace(regexpNewLine,"\\n").replace(regexpCarriageReturn,"");
}

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var nextPos = 0;
	var theLink;
	var aliasedPrettyLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
	var prettyLink = "\\[\\[([^\\]]+)\\]\\]";
	var siteNameRegExp = new RegExp("(" + config.textPrimitives.siteLink + ")|(?:" + aliasedPrettyLink + ")|(?:" + prettyLink + ")","mg");
	do {
		var formatMatch = siteNameRegExp.exec(this.text);
		if(formatMatch)
			{
			if(formatMatch[1] && formatMatch[1].substr(0,1) != config.textPrimitives.unsiteLink && formatMatch[1] != this.title)
				this.links.pushUnique(formatMatch[1]);
			else if(formatMatch[2] && store.tiddlerExists(formatMatch[3]))
				this.links.pushUnique(formatMatch[3]);
			else if(formatMatch[4] && formatMatch[4] != this.title)
				this.links.pushUnique(formatMatch[4]);
			}
	} while(formatMatch);
	return;
}

Tiddler.prototype.getSubtitle = function()
{
	var theModifier = this.modifier;
	if(!theModifier)
		theModifier = config.messages.subtitleUnknown;
	var theModified = this.modified;
	if(theModified)
		theModified = theModified.toLocaleString();
	else
		theModified = config.messages.subtitleUnknown;
	return(theModifier + ", " + theModified);
}

// ---------------------------------------------------------------------------------
// site() object contains Tiddler()s
// ---------------------------------------------------------------------------------

function site()
{
	this.tiddlers = {}; // Hashmap by name of tiddlers
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.dirty = false;
}

// Set the dirty flag
site.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
}

// Invoke the notification handlers for a particular tiddler
site.prototype.notify = function(title,doBlanket)
{
	for(var t=0; t<this.namedNotifications.length; t++)
		{
		var n = this.namedNotifications[t];
		if((n.name == null && doBlanket) || n.name == title)
			n.notify(title);
		}
}

// Invoke the notification handlers for all tiddlers
site.prototype.notifyAll = function()
{
	for(var t=0; t<this.namedNotifications.length; t++)
		{
		var n = this.namedNotifications[t];
		n.notify(n.name);
		}
}

// Add a notification handler to a tiddler
site.prototype.addNotification = function(title,fn)
{
	for (var i=0; i<this.namedNotifications.length; i++)
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	this.namedNotifications.push({name: title, notify: fn});
	return this;
}

// Clear a site so that it contains no tiddlers
site.prototype.clear = function(src)
{
	this.tiddlers = {};
	this.dirty = false;
}

site.prototype.removeTiddler = function(title)
{
	var tiddler = this.tiddlers[title];
	if(tiddler)
		{
		delete this.tiddlers[title];
		this.notify(title,true);
		this.dirty = true;
		}
}

site.prototype.tiddlerExists = function(title)
{
	var t = this.tiddlers[title];
	var s = config.shadowTiny[title];
	return (t != undefined && t instanceof Tiddler) || (s != undefined && s instanceof String);
}

site.prototype.getTiddlerText = function(title,defaultText)
{
	if(!title)
		return(defaultText);
	var tiddler = this.tiddlers[title];
	if(tiddler)
		return tiddler.text;
	else if(config.shadowTiny[title])
		return config.shadowTiny[title];
	else if(defaultText)
		return defaultText;
	else
		return null;
}

site.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,defaultText);
	if(text == null)
		return "";
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match)
			{
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1])
				{
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],match[1],depth-1));
				}
			lastPos = match.index + match[0].length;
			}
		else
			textOut.push(text.substr(lastPos));
	} while(match);
	return(textOut.join(""));
}

site.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags)
{
	var tiddler = this.tiddlers[title];
	if(tiddler)
		delete this.tiddlers[title];
	else
		tiddler = new Tiddler();
	tiddler.set(newTitle,newBody,modifier,modified,tags);
	this.tiddlers[newTitle] = tiddler;
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.dirty = true;
	return tiddler;
}

site.prototype.createTiddler = function(title)
{
	tiddler = this.tiddlers[title];
	if(!tiddler)
		{
		tiddler = new Tiddler();
		this.tiddlers[title] = tiddler;
		this.dirty = true;
		}
	return tiddler;
}

// Load contents of a site from an HTML DIV
site.prototype.loadFromDiv = function(srcID,idPrefix)
{
	if(document.normalize)
		document.normalize();
	var lenPrefix = idPrefix.length;
	var store = document.getElementById(srcID).childNodes;
	for(var t = 0; t < store.length; t++)
		{
		var e = store[t];
		var title = null;
		if(e.getAttribute)
			title = e.getAttribute("tiddler");
		if(!title && e.id && e.id.substr(0,lenPrefix) == idPrefix)
			title = e.id.substr(lenPrefix);
		if(title && title != "")
			{
			var tiddler = this.createTiddler(title);
			tiddler.loadFromDiv(e,title);
			}
		}
	this.dirty = false;
}

// Return an array of tiddlers matching a search string
site.prototype.search = function(searchText,caseSensitive,useRegExp,sortField,excludeTag)
{
	if (!useRegExp)
		searchText = searchText.escapeRegExp();
	var regExp = new RegExp(searchText,caseSensitive ? "m" : "im");
	var candidates = this.reverseLookup("tags",excludeTag,false);
	var results = [];
	for(var t=0; t<candidates.length; t++)
		{
		if(regExp.test(candidates[t].title) || regExp.test(candidates[t].text))
			results.push(candidates[t]);
		}
	if(!sortField)
		sortField = "title";
	results.sort(function (a,b) {if(a[sortField] == b[sortField]) return(0); else return (a[sortField] < b[sortField]) ? -1 : +1; });
	return results;
}

// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances
site.prototype.getTags = function()
{
	var results = [];
	for(var t in this.tiddlers)
		{
		var tiddler = this.tiddlers[t];
		for(g=0; g<tiddler.tags.length; g++)
			{
			var tag = tiddler.tags[g];
			var f = false;
			for(var c=0; c<results.length; c++)
				if(results[c][0] == tag)
					{
					f = true;
					results[c][1]++;
					}
			if(!f)
				results.push([tag,1]);
			}
		}
	results.sort(function (a,b) {if(a[0].toLowerCase() == b[0].toLowerCase()) return(0); else return (a[0].toLowerCase() < b[0].toLowerCase()) ? -1 : +1; });
	return results;
}

// Return an array of the tiddlers that are tagged with a given tag
site.prototype.getTaggedTiny = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
}

// Return an array of the tiddlers that link to a given tiddler
site.prototype.getReferringTiny = function(title,unusedParameter,sortField)
{
	return this.reverseLookup("links",title,true,sortField);
}

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
site.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	for(var t in this.tiddlers)
		{
		var tiddler = this.tiddlers[t];
		var f = !lookupMatch;
		for(var lookup=0; lookup<tiddler[lookupField].length; lookup++)
			if(tiddler[lookupField][lookup] == lookupValue)
				f = lookupMatch;
		if(f)
			results.push(tiddler);
		}
	if(!sortField)
		sortField = "title";
	results.sort(function (a,b) {if(a[sortField] == b[sortField]) return(0); else return (a[sortField] < b[sortField]) ? -1 : +1; });
	return results;
}

// Return the tiddlers as a sorted array
site.prototype.getTiny = function(field)
{
	var results = [];
	for(var t in this.tiddlers)
		results.push(this.tiddlers[t]);
	if(field)
		results.sort(function (a,b) {if(a[field] == b[field]) return(0); else return (a[field] < b[field]) ? -1 : +1; });
	return results;
}

// Return array of names of tiddlers that are referred to but not defined
site.prototype.getMissingLinks = function(sortField)
{
	var results = [];
	for(var t in this.tiddlers)
		{
		var tiddler = this.tiddlers[t];
		for(var n=0; n<tiddler.links.length;n++)
			{
			var link = tiddler.links[n];
			if(this.tiddlers[link] == null)
				results.pushUnique(link);
			}
		}
	results.sort();
	return results;
}

// Return an array of names of tiddlers that are defined but not referred to
site.prototype.getOrphans = function()
{
	var results = [];
	for(var t in this.tiddlers)
		if(this.getReferringTiny(t).length == 0)
			results.push(t);
	results.sort();
	return results;
}

// Return an array of names of tiddlers that are defined but not referred to
site.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiny)
		if(typeof config.shadowTiny[t] == "string")
			results.push(t);
	results.sort();
	return results;
}

// ---------------------------------------------------------------------------------
// Tiddler functions
// ---------------------------------------------------------------------------------

// Display several tiddlers from a list of space separated titles
function displayTiny(src,titles,state,highlightText,highlightCaseSensitive,animate,slowly)
{
	var tiddlerNames = titles.readBracketedList();
	for(var t = tiddlerNames.length-1;t>=0;t--)
		displayTiddler(src,tiddlerNames[t],state,highlightText,highlightCaseSensitive,animate,slowly);
}

// Display a tiddler with animation and scrolling, as though a link to it has been clicked on
//	src = source element object (eg link) for animation effects and positioning
//	title = title of tiddler to display
//	state = 0 is default or current state, 1 is read only and 2 is edittable
//	highlightText = text to highlight in the displayed tiddler
//	highlightCaseSensitive = flag for whether the highlight text is case sensitive
function displayTiddler(src,title,state,highlightText,highlightCaseSensitive,animate,slowly)
{
	var place = document.getElementById("tiddlerDisplay");
	var after = findContainingTiddler(src); // Which tiddler this one will be positioned after
	var before;
	if(after == null)
		before = place.firstChild;
	else if(after.nextSibling)
		before = after.nextSibling;
	else
		before = null;
	var theTiddler = createTiddler(place,before,title,state,highlightText,highlightCaseSensitive);
	if(src)
		{
		if(config.options.chkAnimate && (animate == undefined || animate == true))
			anim.startAnimating(new Zoomer(title,src,theTiddler,slowly),new Scroller(theTiddler,slowly));
		else
			window.scrollTo(0,ensureVisible(theTiddler));
		}
}

// Create a tiddler if it doesn't exist (with no fancy animating)
//	place = parent element
//	before = node before which to create/move the tiddler
//	title = title of tiddler to display
//	state = 0 is default or current state, 1 is read only and 2 is edittable
//	highlightText = text to highlight in the displayed tiddler
//	highlightCaseSensitive = flag for whether the highlight text is case sensitive
function createTiddler(place,before,title,state,highlightText,highlightCaseSensitive)
{
	var theTiddler = createTiddlerSkeleton(place,before,title);
	createTiddlerTitle(title,highlightText,highlightCaseSensitive);
	var theViewer = document.getElementById("viewer" + title);
	var theEditor = document.getElementById("editorWrapper" + title);
	switch(state)
		{
		case 0:
			if(!theViewer && !theEditor)
				{
				createTiddlerToolbar(title,false);
				createTiddlerViewer(title,highlightText,highlightCaseSensitive);
				createTiddlerFooter(title,false);
				}
			break;
		case 1: // Viewer
			if(theViewer)
				theViewer.parentNode.removeChild(theViewer);
			if(theEditor)
				theEditor.parentNode.removeChild(theEditor);
			createTiddlerToolbar(title,false);
			createTiddlerViewer(title,highlightText,highlightCaseSensitive);
			createTiddlerFooter(title,false);
			break;
		case 2: // Editor
			if(!theEditor)
				{
				if(theViewer)
					theViewer.parentNode.removeChild(theViewer);
				createTiddlerToolbar(title,true);
				createTiddlerEditor(title);
				createTiddlerFooter(title,true);
				}
			break;
		}
	return(theTiddler);
}

function refreshTiddler(title)
{
	var theViewer = document.getElementById("viewer" + title);
	if(theViewer)
		{
		theViewer.parentNode.removeChild(theViewer);
		createTiddlerViewer(title,null,null);
		}
}

function createTiddlerSkeleton(place,before,title)
{
	var theTiddler = document.getElementById("tiddler" + title);
	if(!theTiddler)
		{
		theTiddler = createTiddlyElement(null,"div","tiddler" + title,"tiddler",null);
		theTiddler.onmouseover = onMouseOverTiddler;
		theTiddler.onmouseout = onMouseOutTiddler;
		theTiddler.ondblclick = onDblClickTiddler;
		var theInnerTiddler = createTiddlyElement(theTiddler,"div",null,"unselectedTiddler",null);
		var theToolbar = createTiddlyElement(theInnerTiddler,"div","toolbar" + title,"toolbar", null);
		var theTitle = createTiddlyElement(theInnerTiddler,"div","title" + title,"title",null);
		var theBody = createTiddlyElement(theInnerTiddler,"div","body" + title,"body",null);
		var theFooter = createTiddlyElement(theInnerTiddler,"div","footer" + title,"footer",null);
		place.insertBefore(theTiddler,before);
		}
	if(typeof config.shadowTiny[title] == "string")
		addClass(theTiddler,"shadow");
	else
		removeClass(theTiddler,"shadow");
	return(theTiddler);
}

function createTiddlerTitle(title,highlightText,highlightCaseSensitive)
{
	var theTitle = document.getElementById("title" + title);
	if(theTitle)
		{
		removeChildren(theTitle);
		createTiddlyText(theTitle,title);
		if(store.tiddlerExists(title))
			theTitle.title = store.tiddlers[title].getSubtitle();
		}
}

// Create a tiddler toolbar according to whether it's an editor or not
function createTiddlerToolbar(title,isEditor)
{
	var theToolbar = document.getElementById("toolbar" + title);
	var lingo = config.views;
	if(theToolbar)
		{
		removeChildren(theToolbar);
		insertSpacer(theToolbar);
		if(isEditor)
			{
			// Editor toolbar
			lingo = lingo.editor;
			createTiddlyButton(theToolbar,lingo.toolbarDone.text,lingo.toolbarDone.tooltip,onClickToolbarSave);
			insertSpacer(theToolbar);
			createTiddlyButton(theToolbar,lingo.toolbarCancel.text,lingo.toolbarCancel.tooltip,onClickToolbarUndo);
			insertSpacer(theToolbar);
			createTiddlyButton(theToolbar,lingo.toolbarDelete.text,lingo.toolbarDelete.tooltip,onClickToolbarDelete);
			}
		else
			{
			// Viewer toolbar
			lingo = lingo.sitefied;
			createTiddlyButton(theToolbar,lingo.toolbarClose.text,lingo.toolbarClose.tooltip,onClickToolbarClose);
			insertSpacer(theToolbar);
			if(!readOnly)
				{
				createTiddlyButton(theToolbar,lingo.toolbarEdit.text,lingo.toolbarEdit.tooltip,onClickToolbarEdit);
				insertSpacer(theToolbar);
				}
			createTiddlyButton(theToolbar,lingo.toolbarPermalink.text,lingo.toolbarPermalink.tooltip,onClickToolbarPermaLink);
			insertSpacer(theToolbar);
			createTiddlyButton(theToolbar,lingo.toolbarReferences.text,lingo.toolbarReferences.tooltip,onClickToolbarReferences);
			}
		insertSpacer(theToolbar);
		}
}

// Create the body section of a read-only tiddler
function createTiddlerViewer(title,highlightText,highlightCaseSensitive)
{
	var theBody = document.getElementById("body" + title);
	if(theBody)
		{
		var tiddlerText = store.getTiddlerText(title);
		var theViewer = createTiddlyElement(theBody,"div","viewer" + title,"viewer",null);
		if(store.tiddlerExists(title))
			theViewer.setAttribute("tags",tiddler.tags.join(" "));
		if(tiddlerText == null)
			{
			tiddlerText = config.views.sitefied.defaultText.format([title]);
			theViewer.style.fontStyle = "italic";
			}
		sitefy(tiddlerText,theViewer,highlightText,highlightCaseSensitive);
		theViewer.style.overflow = "visible";
		theViewer.style.height = "auto";
		}
}

// Create the footer section of a tiddler
function createTiddlerFooter(title,isEditor)
{
	var theFooter = document.getElementById("footer" + title);
	var tiddler = store.tiddlers[title];
	if(theFooter && tiddler instanceof Tiddler)
		{
		removeChildren(theFooter);
		insertSpacer(theFooter);
		if(isEditor)
			{
			}
		else
			{
			var lingo = config.views.sitefied.tag;
			var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
			var theTags = createTiddlyElement(theFooter,"div",null,null,prompt);
			for(var t=0; t<tiddler.tags.length; t++)
				{
				var theTag = createTagButton(theTags,tiddler.tags[t],tiddler.title);
				createTiddlyText(theTags," ");
				}
			}
		}
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler)
{
	var theTag = createTiddlyButton(place,tag,config.views.sitefied.tag.tooltip.format([tag]),onClickTag);
	theTag.setAttribute("tag",tag);
	if(excludeTiddler)
		theTag.setAttribute("tiddler",excludeTiddler);
	return(theTag);
}

// Create the body section of an edittable tiddler
function createTiddlerEditor(title)
{
	var theBody = document.getElementById("body" + title);
	if(theBody)
		{
		var tiddlerText = store.getTiddlerText(title);
		var tiddlerExists = (tiddlerText != null);
		if(!tiddlerExists)
			tiddlerText = config.views.editor.defaultText.format([title]);
		var theEditor = createTiddlyElement(theBody,"div","editorWrapper" + title,"editor",null);
		theEditor.onkeypress = onEditKey;
		var theTitleBox = createTiddlyElement(theEditor,"input","editorTitle" + title,null,null);
		theTitleBox.setAttribute("type","text");
		theTitleBox.value = title;
		theTitleBox.setAttribute("size","40");
		theTitleBox.setAttribute("autocomplete","off");
		var theBodyBox = createTiddlyElement(theEditor,"textarea","editorBody" + title,null,null);
		theBodyBox.value = tiddlerText;
		var rows = 10;
		var lines = tiddlerText.match(regexpNewLine);
		if(lines != null && lines.length > rows)
			rows = lines.length + 5;
		theBodyBox.setAttribute("rows",rows);
		var theTagsBox = createTiddlyElement(theEditor,"input","editorTags" + title,null,null);
		theTagsBox.setAttribute("type","text");
		var tiddler = store.tiddlers[title];
		theTagsBox.value = tiddler instanceof Tiddler ? tiddler.getTags() : "";
		theTagsBox.setAttribute("size","40");
		theTagsBox.setAttribute("autocomplete","off");
		var tagPrompt = createTiddlyElement(theEditor,"div",null,"editorFooter",config.views.editor.tagPrompt);
		insertSpacer(tagPrompt);
		var lingo = config.views.editor.tagChooser;
		var addTag = createTiddlyButton(tagPrompt,lingo.text,lingo.tooltip,onClickAddTag);
		addTag.setAttribute("tiddler",title);
		theBodyBox.focus();
		}
}

function saveTiddler(title,minorUpdate)
{
	var titleBox = document.getElementById("editorTitle" + title);
	var newTitle = titleBox.value.trim();
	if(store.tiddlerExists(newTitle))
		{
		if(newTitle != title && !confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
			{
			titleBox.focus();
			titleBox.select();
			return;
			}
		}
	var body = document.getElementById("editorBody" + title);
	var newBody = body.value;
	newBody = newBody.replace(/\r/mg,"");
	var newTags = document.getElementById("editorTags" + title).value;
	blurTiddler(title);
	if(config.options.chkForceMinorUpdate)
		minorUpdate = !minorUpdate;
	var newDate = new Date();
	store.saveTiddler(title,newTitle,newBody,config.options.txtUserName,minorUpdate ? undefined : new Date(),newTags);
	displayTiddler(null,newTitle,1,null,null,null,false,false);
	// Close the old tiddler if this is a rename
	if(title != newTitle)
		{
		var oldTiddler = document.getElementById("tiddler" + title);
		var newTiddler = document.getElementById("tiddler" + newTitle);
		oldTiddler.parentNode.replaceChild(newTiddler,oldTiddler);
		}
	if(config.options.chkAutoSave)
		saveChanges();
}

function selectTiddler(title)
{
	var e = document.getElementById("tiddler" + title);
	if(e != null)
		e.firstChild.className = "selectedTiddler";
}

function deselectTiddler(title)
{
	var e = document.getElementById("tiddler" + title);
	if(e != null)
		e.firstChild.className = "unselectedTiddler";
}

function blurTiddler(title)
{
	var body = document.getElementById("editorBody" + title);
	if(body)
		{
		body.focus();
		body.blur();
		}
}

function deleteTiddler(title)
{
	closeTiddler(title,false);
	store.removeTiddler(title);
	// Autosave
	if(config.options.chkAutoSave)
		saveChanges();
}

function closeTiddler(title,slowly)
{
	var tiddler = document.getElementById("tiddler" + title);
	if(tiddler != null)
		{
		scrubIds(tiddler);
		if(config.options.chkAnimate)
			anim.startAnimating(new Slider(tiddler,false,slowly,"all"));
		else
			tiddler.parentNode.removeChild(tiddler);
		}
}

function scrubIds(e)
{
	if(e.id)
		e.id = null;
	var children = e.childNodes;
	for(var t=0; t<children.length; t++)
		{
		var c = children[t];
		if(c.id)
			c.id = null;
		}
}

function closeAllTiny()
{
	clearMessage();
	var place = document.getElementById("tiddlerDisplay");
	var tiddler = place.firstChild;
	var nextTiddler;
	while(tiddler)
		{
		nextTiddler = tiddler.nextSibling;
		if(tiddler.id)
			if(tiddler.id.substr(0,7) == "tiddler")
				{
				var title = tiddler.id.substr(7);
				if(!document.getElementById("editorWrapper" + title))
					place.removeChild(tiddler);
				}
		tiddler = nextTiddler;
		}
}

// ---------------------------------------------------------------------------------
// Message area
// ---------------------------------------------------------------------------------

function displayMessage(text,linkText)
{
	var msgArea = document.getElementById("messageArea");
	var msg;
	if(linkText)
		{
		msg = createTiddlyElement(msgArea,"div",null,null,null);
		var link = createTiddlyElement(msg,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
		}
	else
		msg = createTiddlyElement(msgArea,"div",null,null,text);
	msgArea.style.display = "block";
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	removeChildren(msgArea);
	msgArea.style.display = "none";
}

// ---------------------------------------------------------------------------------
// Menu and sidebar functions
// ---------------------------------------------------------------------------------

function refreshStory(hint)
{
	var hits = hint ? store.getReferringTiny(hint) : null;
	var displayNodes = document.getElementById("tiddlerDisplay").childNodes;
	for(var t=0;t<displayNodes.length;t++)
		{
		var theId = displayNodes[t].id;
		if(theId && theId.substr(0,7) == "tiddler")
			{
			var title = theId.substr(7);
			if(hint)
				{
				var f = false;
				for(var h=0; h<hits.length; h++)
					if(hits[h].title == title)
						f = true
				if(f)
					refreshTiddler(title);
				}
			else
				refreshTiddler(title);
			}
		}
}

function refreshTabs(hint)
{
	refreshSpecialItem("sidebarTabs","SideBarTabs","SideBarTabs");
}

function refreshMenu(hint)
{
	refreshSpecialItem("mainMenu","MainMenu","MainMenu");
}

function refreshTitle(title)
{
	refreshSpecialItem("siteTitle",title,"SiteTitle");
	refreshPageTitle();
}

function refreshSubtitle(title)
{
	refreshSpecialItem("siteSubtitle",title,"SiteSubtitle");
	refreshPageTitle();
}

function refreshPageTitle()
{
	document.title = getElementText("siteTitle") + " - " + getElementText("siteSubtitle");
}

function refreshSidebar(title)
{
	refreshSpecialItem("sidebarOptions",title,"SideBarOptions");
}

function refreshSpecialItem(elementID,title,defaultText)
{
	var place = document.getElementById(elementID);
	removeChildren(place);
	sitefy(store.getTiddlerText(title,defaultText),place,null,null);
}

function refreshStyles(title)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title);
}

// ---------------------------------------------------------------------------------
// Options cookie stuff
// ---------------------------------------------------------------------------------

function loadOptionsCookie()
{
	var cookies = document.cookie.split(";");
	for(var c=0; c<cookies.length; c++)
		{
		var p = cookies[c].indexOf("=");
		if(p != -1)
			{
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			switch(name.substr(0,3))
				{
				case "txt":
					config.options[name] = unescape(value);
					break;
				case "chk":
					config.options[name] = value == "true";
					break;
				}
			}
		}
}

function saveOptionCookie(name)
{
	var c = name + "=";
	switch(name.substr(0,3))
		{
		case "txt":
			c += escape(config.options[name].toString());
			break;
		case "chk":
			c += config.options[name] ? "true" : "false";
			break;
		}
	c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
	document.cookie = c;
}

// ---------------------------------------------------------------------------------
// Saving
// ---------------------------------------------------------------------------------

var saveUsingSafari = false;
var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// Check if there any unsaved changes before exitting
function checkUnsavedChanges()
{
	if(store.dirty)
		{
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
		}
}

// Save this site with the pending changes
function saveChanges()
{
	clearMessage();
	// Get the URL of the document
	var originalPath = document.location.toString();
	// Check we were loaded from a file URL
	if(originalPath.substr(0,5) != "file:")
		{
		alert(config.messages.notFileUrlError);
		displayTiddler(null,"SaveChanges",0,null,null,false,false);
		return;
		}
	// Remove any location part of the URL
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert to a native file format assuming
	// "file:///x:/path/path/path..." - pc local file --> "x:\path\path\path..."
	// "file://///server/share/path/path/path..." - FireFox pc network file --> "\\server\share\path\path\path..."
	// "file:///path/path/path..." - mac/unix local file --> "/path/path/path..."
	// "file://server/share/path/path/path..." - pc network file --> "\\server\share\path\path\path..."
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	// Load the original file
	var original = loadFile(localPath);
	if(original == null)
		{
		alert(config.messages.cantSaveError);
		displayTiddler(null,"SaveChanges",0,null,null,false,false);
		return;
		}
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var posClosingDiv = original.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		{
		alert(config.messages.invalidFileError.format([localPath]));
		return;
		}
	// Save the backup
	if(config.options.chkSaveBackups)
		{
		var backupPath = localPath.substr(0,localPath.lastIndexOf(".")) + "." + (new Date()).convertToYYYYMMDDHHMMSSMMM() + ".html";
		var backup = saveFile(backupPath,original);
		if(backup)
			displayMessage(config.messages.backupSaved,"file://" + backupPath);
		else
			alert(config.messages.backupFailed);
		}
	// Save Rss
	if(config.options.chkGenerateAnRssFeed)
		{
		var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
		var rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));
		if(rssSave)
			displayMessage(config.messages.rssSaved,"file://" + rssPath);
		else
			alert(config.messages.rssFailed);
		}
	// Save empty template
	if(config.options.chkSaveEmptyTemplate)
		{
		var emptyPath,p;
		if((p = localPath.lastIndexOf("/")) != -1)
			emptyPath = localPath.substr(0,p) + "/empty.html";
		else if((p = localPath.lastIndexOf("\\")) != -1)
			emptyPath = localPath.substr(0,p) + "\\empty.html";
		else
			emptyPath = localPath + ".empty.html";
		var empty = original.substr(0,posOpeningDiv + startSaveArea.length) + convertUnicodeToUTF8(generateEmpty()) + original.substr(posClosingDiv);
		var emptySave = saveFile(emptyPath,empty);
		if(emptySave)
			displayMessage(config.messages.emptySaved,"file://" + emptyPath);
		else
			alert(config.messages.emptyFailed);
		}
	// Save new file
	var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + 
				convertUnicodeToUTF8(allTinyAsHtml()) + "\n\t\t" +
				original.substr(posClosingDiv);
	var newSiteTitle = convertUnicodeToUTF8((getElementText("siteTitle") + " - " + getElementText("siteSubtitle")).htmlEncode());
	revised = revised.replace(new RegExp("<title>[^<]*</title>", "im"),"<title>"+ newSiteTitle +"</title>");
	var save = saveFile(localPath,revised);
	if(save)
		{
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
		}
	else
		alert(config.messages.mainFailed);
}

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl",null);
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title>" + store.getTiddlerText("SiteTitle","").htmlEncode() + "</title>");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + store.getTiddlerText("SiteSubtitle","").htmlEncode() + "</description>");
	s.push("<language>en-us</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>site " + version.major + "." + version.minor + "." + version.revision + "</generator>");
	// The body
	var tiddlers = store.getTiny("modified");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for (var t=tiddlers.length-1; t>=n; t--)
		s.push(tiddlers[t].saveToRss(u));
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

function generateEmpty()
{
	var systemTiny = store.getTaggedTiny("systemTiny");
	var savedTiny = [];
	for(var s=0;s<systemTiny.length;s++)
		savedTiny.push(systemTiny[s].saveToDiv());
	return savedTiny.join("\n");
}

function allTinyAsHtml()
{
	var savedTiny = [];
	var tiddlers = store.getTiny("title");
	for (var t = 0; t < tiddlers.length; t++)
		savedTiny.push(tiddlers[t].saveToDiv());
	return savedTiny.join("\n");
}

// UTF-8 encoding rules:
// 0x0000 - 0x007F:	0xxxxxxx
// 0x0080 - 0x07FF:	110xxxxx 10xxxxxx
// 0x0800 - 0xFFFF:	1110xxxx 10xxxxxx 10xxxxxx

function convertUTF8ToUnicode(u)
{
	var s = "";
	var t = 0;
	var b1, b2, b3;
	while(t < u.length)
		{
		b1 = u.charCodeAt(t++);
		if(b1 < 0x80)
			s += String.fromCharCode(b1);
		else if(b1 < 0xE0)
			{
			b2 = u.charCodeAt(t++);
			s += String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			}
		else
			{
			b2 = u.charCodeAt(t++);
			b3 = u.charCodeAt(t++);
			s += String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			}
	}
	return(s);
}

function convertUnicodeToUTF8(s)
{
	if(saveUsingSafari)
		return s;
	else if(window.Components)
		return mozConvertUnicodeToUTF8(s);
	else
		return manualConvertUnicodeToUTF8(s);
}

function manualConvertUnicodeToUTF8(s)
{
	var re = /[^\u0000-\u007F]/g ;
	return s.replace(re, function($0) {return("&#" + $0.charCodeAt(0).toString() + ";");})
}

function mozConvertUnicodeToUTF8(s)
{
	netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
	var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
	converter.charset = "UTF-8";
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	if(fin.length > 0)
		return u + fin;
	else
		return u;
}

function saveFile(fileUrl, content)
{
	var r = null;
	if(saveUsingSafari)
		r = safariSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = mozillaSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = ieSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = operaSaveFile(fileUrl, content);
	return(r);
}

function loadFile(fileUrl)
{
	var r = null;
	if(saveUsingSafari)
		r = safariLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = operaLoadFile(fileUrl);
	return(r);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath, content)
{
	try
		{
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		}
	catch(e)
		{
		//alert("Exception while attempting to save\n\n" + e.toString());
		return(null);
		}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return(true);
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try
		{
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
		}
	catch(e)
		{
		//alert("Exception while attempting to load\n\n" + e.toString());
		return(null);
		}
	return(content);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath, content)
{
	if(window.Components)
		try
			{
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if (!file.exists())
				file.create(0, 0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file, 0x20 | 0x02, 00004,null);
			out.write(content, content.length);
			out.flush();
			out.close();
			return(true);
			}
		catch(e)
			{
			//alert("Exception while attempting to save\n\n" + e);
			return(false);
			}
	return(null);
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components)
		try
			{
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if (!file.exists())
				return(null);
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file, 0x01, 00004, null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			return(sInputStream.read(sInputStream.available()));
			}
		catch(e)
			{
			//alert("Exception while attempting to load\n\n" + e);
			return(false);
			}
	return(null);
}

function operaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	if(i > 0)
		return url.substring(i-1);
	return url;
}

function operaSaveFile(filePath, content)
{
	try
		{
		var s = new java.io.PrintStream(new java.io.FileOutputStream(operaUrlToFilename(filePath)));
		s.print(content);
		s.close();
		}
	catch(e)
		{
		if(window.opera)
			opera.postError(e);
		return null;
		}
	return true;
}

function operaLoadFile(filePath)
{
	var content = [];
	alert(operaUrlToFilename(filePath));
	try
		{
		var r = new java.io.BufferedReader(new java.io.FileReader(operaUrlToFilename(filePath)));
		var line;
		while ((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
		}
	catch(e)
		{
		if(window.opera)
			opera.postError(e);
		return null;
		}
	return content.join("\n");
}

function safariFilenameToUrl(filename) {
	return ("file://" + filename);
}

function safariLoadFile(url)
{
	url = safariFilenameToUrl(url);
	var plugin = document.embeds["siteSafariSaver"];
	return plugin.readURL(url);
}

function safariSaveFile(url,content)
{
	url = safariFilenameToUrl(url);
	var plugin = document.embeds["siteSafariSaver"];
	return plugin.writeStringToURL(content,url);
}

// Lifted from http://developer.apple.com/internet/webcontent/detectplugins.html
function detectPlugin()
{
	var daPlugins = detectPlugin.arguments;
	var pluginFound = false;
	if (navigator.plugins && navigator.plugins.length > 0)
		{
		var pluginsArrayLength = navigator.plugins.length;
		for (pluginsArrayCounter=0; pluginsArrayCounter < pluginsArrayLength; pluginsArrayCounter++ )
			{
			var numFound = 0;
			for(namesCounter=0; namesCounter < daPlugins.length; namesCounter++)
				{
				if( (navigator.plugins[pluginsArrayCounter].name.indexOf(daPlugins[namesCounter]) >= 0) || 
						(navigator.plugins[pluginsArrayCounter].description.indexOf(daPlugins[namesCounter]) >= 0) )
					numFound++;
				}
			if(numFound == daPlugins.length)
				{
				pluginFound = true;
				break;
				}
			}
	}
	return pluginFound;
}

// ---------------------------------------------------------------------------------
// Event handlers
// ---------------------------------------------------------------------------------

function onEditKey(e)
{
	if (!e) var e = window.event;
	clearMessage();
	var consume = false;
	switch(e.keyCode)
		{
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey && this.id && this.id.substr(0,13) == "editorWrapper")
				{
				blurTiddler(this.id.substr(13));
				saveTiddler(this.id.substr(13),e.shiftKey);
				consume = true;
				}
			break;
		case 27: // Escape
			if(this.id && this.id.substr(0,13) == "editorWrapper")
				{
				blurTiddler(this.id.substr(13));
				displayTiddler(null,this.id.substr(13),1,null,null,false,false);
				consume = true;
				}
			break;
		}
	e.cancelBubble = consume;
	if(consume)
		if (e.stopPropagation) e.stopPropagation();
	return(!consume);

}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var theLink = theTarget;
	var title = null;
	do {
		title = theLink.getAttribute("tiddlyLink");
		theLink = theLink.parentNode;
	} while(title == null && theLink != null);
	if(title)
		{
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		var opening;
		if(toggling && document.getElementById("tiddler" + title))
			closeTiddler(title,e.shiftKey || e.altKey);
		else
			displayTiddler(theTarget,title,0,null,null,true,e.shiftKey || e.altKey);
		}
	clearMessage();
	return(false);
}

// Event handler for mouse over a tiddler
function onMouseOverTiddler(e)
{
	var tiddler;
	if(this.id.substr(0,7) == "tiddler")
		tiddler = this.id.substr(7);
	if(tiddler)
		selectTiddler(tiddler);
}

// Event handler for mouse out of a tiddler
function onMouseOutTiddler(e)
{
	var tiddler;
	if(this.id.substr(0,7) == "tiddler")
		tiddler = this.id.substr(7);
	if(tiddler)
		deselectTiddler(tiddler);
}

// Event handler for double click on a tiddler
function onDblClickTiddler(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	if(!readOnly && theTarget && theTarget.nodeName.toLowerCase() != "input" && theTarget.nodeName.toLowerCase() != "textarea")
		{
		clearMessage();
		if(document.selection && document.selection.empty)
			document.selection.empty();
		var tiddler;
		if(this.id.substr(0,7) == "tiddler")
			tiddler = this.id.substr(7);
		if(tiddler)
			displayTiddler(null,tiddler,2,null,null,false,false);
		return true;
		}
	else
		return false;
}

// Event handler for clicking on toolbar close
function onClickToolbarClose(e)
{
	if (!e) var e = window.event;
	clearMessage();
	if(this.parentNode.id)
		closeTiddler(this.parentNode.id.substr(7),e.shiftKey || e.altKey);
	return(false);
}

// Event handler for clicking on toolbar permalink
function onClickToolbarPermaLink(e)
{
	if(this.parentNode.id)
		{
		var title = this.parentNode.id.substr(7);
		var t = encodeURIComponent(String.encodeTiddlyLink(title));
		if(window.location.hash != t)
			window.location.hash = t;
		}
	return false;
}

// Event handler for clicking on toolbar close
function onClickToolbarDelete(e)
{
	clearMessage();
	if(this.parentNode.id)
		deleteTiddler(this.parentNode.id.substr(7));
	return false;
}

// Event handler for clicking on the toolbar references button
function onClickToolbarReferences(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var popup = createTiddlerPopup(this);
	if(popup && this.parentNode.id)
		{
		var title = this.parentNode.id.substr(7);
		var references = store.getReferringTiny(title);
		var c = false;
		for(var r=0; r<references.length; r++)
			if(references[r].title != title)
				{
				createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
				c = true;
				}
		if(!c)
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),config.views.sitefied.toolbarReferences.popupNone);
		}
	scrollToTiddlerPopup(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return(false);
}

// Event handler for clicking on a tiddler tag
function onClickTag(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var popup = createTiddlerPopup(this);
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag)
		{
		var tagged = store.getTaggedTiny(tag);
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++)
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		var lingo = config.views.sitefied.tag;
		if(titles.length > 0)
			{
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			createTiddlyElement(createTiddlyElement(popup,"li"),"hr");
			for(r=0; r<titles.length; r++)
				{
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
				}
			}
		else
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),lingo.popupNone.format([tag]));
		}
	scrollToTiddlerPopup(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return(false);
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(e)
{
	if (!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var tagged = store.getTaggedTiny(tag);
	for(var t=tagged.length-1; t>=0; t--)
		displayTiddler(this,tagged[t].title,0,null,null,false,e.shiftKey || e.altKey);
	return(false);
}

// Event handler for clicking on the 'add tag' button
function onClickAddTag(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var popup = createTiddlerPopup(this);
	var tiddler = this.getAttribute("tiddler");
	var tags = store.getTags();
	var lingo = config.views.editor.tagChooser;
	if(tags.length == 0)
		createTiddlyText(createTiddlyElement(popup,"li"),lingo.popupNone);
	for (t=0; t<tags.length; t++)
		{
		var theTag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),onClickAddTagPopup);
		theTag.setAttribute("tag",tags[t][0]);
		theTag.setAttribute("tiddler",tiddler);
		}
	scrollToTiddlerPopup(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return(false);
}

// Event handler for clicking on a tag in the 'add tag' popup
function onClickAddTagPopup(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var tiddler = this.getAttribute("tiddler");
	var tag = this.getAttribute("tag");
	var tagsBox = document.getElementById("editorTags" + tiddler);
	if(tagsBox)
		tagsBox.value += " " + String.encodeTiddlyLink(tag);
	return(false);
}

// Event handler for clicking on toolbar close
function onClickToolbarEdit(e)
{
	clearMessage();
	if(this.parentNode.id)
		displayTiddler(null,this.parentNode.id.substr(7),2,null,null,false,false);
	return false;
}

// Event handler for clicking on toolbar save
function onClickToolbarSave(e)
{
	if (!e) var e = window.event;
	if(this.parentNode.id)
		saveTiddler(this.parentNode.id.substr(7),e.shiftKey);
	return false;
}

// Event handler for clicking on toolbar save
function onClickToolbarUndo(e)
{
	if(this.parentNode.id)
		displayTiddler(null,this.parentNode.id.substr(7),1,null,null,false,false);
	return false;
}

// Eek... it's bad that this is done via a function rather than a normal, copy-able href
function onClickPermaView()
{
	var tiddlerDisplay = document.getElementById("tiddlerDisplay");
	var links = [];
	for(var t=0;t<tiddlerDisplay.childNodes.length;t++)
		{
		var tiddlerName = tiddlerDisplay.childNodes[t].id.substr(7);
		links.push(String.encodeTiddlyLink(tiddlerName));
		}
	window.location.hash = encodeURIComponent(links.join(" "));
	return false;
}

// ---------------------------------------------------------------------------------
// Animation engine
// ---------------------------------------------------------------------------------

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() // Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0)
		{
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},25);
		}
	this.running += arguments.length;
}

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a<me.animations.length)
		{
		var animation = me.animations[a];
		animation.progress += animation.step;
		if(animation.progress < 0 || animation.progress > 1)
			{
			animation.stop();
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
			}
		else
			{
			animation.tick();
			a++;
			}
		}
}

// Map a 0..1 value to 0..1, but slow down at the start and end
Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
}

// ---------------------------------------------------------------------------------
// Zoomer animation
// ---------------------------------------------------------------------------------

function Zoomer(text,startElement,targetElement,slowly)
{
	this.element = document.createElement("div");
	this.element.appendChild(document.createTextNode(text));
	this.element.className = "zoomer";
	document.body.appendChild(this.element);
	this.startElement = startElement;
	this.startLeft = findPosX(this.startElement);
	this.startTop = findPosY(this.startElement);
	this.startWidth = this.startElement.offsetWidth;
	this.startHeight = this.startElement.offsetHeight;
	this.targetElement = targetElement;
	this.targetLeft = findPosX(this.targetElement);
	this.targetTop = findPosY(this.targetElement);
	this.targetWidth = this.targetElement.offsetWidth;
	this.targetHeight = this.targetElement.offsetHeight;
	this.progress = 0;
	this.step = slowly ? config.animSlow : config.animFast;
	//this.targetElement.style.opacity = 0;
	return this;
}

Zoomer.prototype.stop = function()
{
	this.element.parentNode.removeChild(this.element);
	//this.targetElement.style.opacity = 1;
}

Zoomer.prototype.tick = function()
{
	var f = Animator.slowInSlowOut(this.progress);
	this.element.style.left = this.startLeft + (this.targetLeft-this.startLeft) * f + "px";
	this.element.style.top = this.startTop + (this.targetTop-this.startTop) * f + "px";
	this.element.style.width = this.startWidth + (this.targetWidth-this.startWidth) * f + "px";
	this.element.style.height = this.startHeight + (this.targetHeight-this.startHeight) * f + "px";
	this.element.style.display = "block";
	//this.targetElement.style.opacity = this.progress;
	//this.targetElement.style.filter = "alpha(opacity:" + this.progress * 100 + ")";
}

// ---------------------------------------------------------------------------------
// Scroller animation
// ---------------------------------------------------------------------------------

function Scroller(targetElement,slowly)
{
	this.targetElement = targetElement;
	this.startScroll = findScrollY();
	this.targetScroll = ensureVisible(targetElement);
	this.progress = 0;
	this.step = slowly ? config.animSlow : config.animFast;
	return this;
}

Scroller.prototype.stop = function()
{
	window.scrollTo(0,this.targetScroll);
}

Scroller.prototype.tick = function()
{
	var f = Animator.slowInSlowOut(this.progress);
	window.scrollTo(0,this.startScroll + (this.targetScroll-this.startScroll) * f);
}

// ---------------------------------------------------------------------------------
// Slider animation
// ---------------------------------------------------------------------------------

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,slowly,deleteMode)
{
	this.element = element;
	element.style.display = "block";
	this.deleteMode = deleteMode;
	this.element.style.height = "auto";
	this.realHeight = element.offsetHeight;
	this.opening = opening;
	this.step = slowly ? config.animSlow : config.animFast;
	if(opening)
		{
		this.progress = 0;
		element.style.height = "0px";
		element.style.display = "block";
		}
	else
		{
		this.progress = 1;
		this.step = -this.step;
		}
	element.style.overflow = "hidden";
	return this;
}

Slider.prototype.stop = function()
{
	if(this.opening)
		this.element.style.height = "auto";
	else
		{
		switch(this.deleteMode)
			{
			case "none":
				this.element.style.display = "none";
				break;
			case "all":
				this.element.parentNode.removeChild(this.element);
				break;
			case "children":
				removeChildren(this.element);
				break;
			}
		}
}

Slider.prototype.tick = function()
{
	var f = Animator.slowInSlowOut(this.progress);
	var h = this.realHeight * f;
	this.element.style.height = h + "px";
	this.element.style.opacity = f;
}

// ---------------------------------------------------------------------------------
// Popup menu
// ---------------------------------------------------------------------------------

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root)
{
	Popup.remove();
	var popup = createTiddlyElement(document.body,"ol","popup","popup",null);
	Popup.stack.push({root: root, popup: popup});
	return popup;
}

Popup.onDocumentClick = function(e)
{
	if (!e) var e = window.event;
	var target = resolveTarget(e);
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
}

Popup.show = function(unused,slowly)
{
	var curr = Popup.stack[Popup.stack.length-1];
	var rootLeft = findPosX(curr.root);
	var rootTop = findPosY(curr.root);
	var rootHeight = curr.root.offsetHeight;
	var popupLeft = rootLeft;
	var popupTop = rootTop + rootHeight;
	var popupWidth = curr.popup.offsetWidth;
	var winWidth = findWindowWidth();
	if(popupLeft + popupWidth > winWidth)
		popupLeft = winWidth - popupWidth;
	curr.popup.style.left = popupLeft + "px";
	curr.popup.style.top = popupTop + "px";
	curr.popup.style.display = "block";
	addClass(curr.root,"highlight");
	if(config.options.chkAnimate)
		anim.startAnimating(new Scroller(curr.popup,slowly));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
}

Popup.remove = function()
{
	if(Popup.stack.length > 0)
		{
		Popup.removeFrom(0);
		}
}

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--)
		{
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		p.popup.parentNode.removeChild(p.popup);
		}
	Popup.stack = Popup.stack.slice(0,from);
}

// Backwards compatibility
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// ---------------------------------------------------------------------------------
// Augmented methods for the JavaScript Number(), Array() and String() objects
// ---------------------------------------------------------------------------------

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return c;
}

// Find an entry in an array. Returns the array index or null
Array.prototype.find = function(item)
{
	for(var t=0; t<this.length; t++)
		if(this[t] == item)
			return t;
	return null;
}

// Find an entry in an array by the value of one of it's members. Returns the array index or null
Array.prototype.findByMember = function(member,value)
{
	for(var t=0; t<this.length; t++)
		if(this[t][member] == value)
			return t;
	return null;
}

// Get an item in an array by the value of a particular member of the item. Returns the item or null
Array.prototype.get = function(member,value)
{
	for(t=0; t<this.length; t++)
		if(this[t][members] == value)
			return this[t];
	return null;
}

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique != undefined && unique == false)
		this.push(item);
	else
		{
		if(this.find(item) == null)
			this.push(item);
		}
}

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	if(n < this.length)
		return this.slice(this.length-n);
	else
		return this;
}

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	var regexpTrim = new RegExp("^\\s*(.*?)\\s*$","mg");
	return(this.replace(regexpTrim,"$1"));
}

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1)
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	return s.join("");
}

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
	var subRegExp = new RegExp("(?:%(\\d+))","mg");
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1])
			{
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
			}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
}

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	return(this.replace(new RegExp("[\\\\\\^\\$\\*\\+\\?\\(\\)\\=\\!\\|\\,\\{\\}\\[\\]\\.]","g"),"\\$&"));
}

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	var regexpAmp = new RegExp("&","mg");
	var regexpLessThan = new RegExp("<","mg");
	var regexpGreaterThan = new RegExp(">","mg");
	var regexpQuote = new RegExp("\"","mg");
	return(this.replace(regexpAmp,"&amp;").replace(regexpLessThan,"&lt;").replace(regexpGreaterThan,"&gt;").replace(regexpQuote,"&quot;"));
}

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '', [[]] or left unquoted (and therefore space-separated)
String.prototype.readMacroParams = function()
{
	var regexpMacroParam = new RegExp("(?:\\s*)(?:(?:\"([^\"]*)\")|(?:'([^']*)')|(?:\\[\\[([^\\]]*)\\]\\])|([^\"'\\s]\\S*))","mg");
	var params = [];
	do {
		var match = regexpMacroParam.exec(this);
		if(match)
			{
			if(match[1]) // Double quoted
				params.push(match[1]);
			else if(match[2]) // Single quoted
				params.push(match[2]);
			else if(match[3]) // Double-square-bracket quoted
				params.push(match[3]);
			else if(match[4]) // Unquoted
				params.push(match[4]);
			}
	} while(match);
	return params;
}

// Process a string list of tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var bracketedPattern = "\\[\\[([^\\]]+)\\]\\]";
	var unbracketedPattern = "[^\\s$]+";
	var pattern = "(?:" + bracketedPattern + ")|(" + unbracketedPattern + ")";
	var re = new RegExp(pattern,"mg");
	var tiddlerNames = [];
	do {
		var match = re.exec(this);
		if(match)
			{
			if(match[1]) // Bracketed
				tiddlerNames.pushUnique(match[1],unique);
			else if(match[2]) // Unbracketed
				tiddlerNames.pushUnique(match[2],unique);
			}
	} while(match);
	return(tiddlerNames);
}

// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	if(title.indexOf(" ") == -1)
		return(title);
	else
		return("[[" + title + "]]");
}

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return(s);
}

// ---------------------------------------------------------------------------------
// RGB colour object
// ---------------------------------------------------------------------------------

// Construct an RGB colour object from a '#rrggbb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string")
		{
		if(r.substr(0,1) == "#")
			{
			this.r = parseInt(r.substr(1,2),16)/255;
			this.g = parseInt(r.substr(3,2),16)/255;
			this.b = parseInt(r.substr(5,2),16)/255;
			}
		else
			{
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/ ;
			var c = r.match(rgbPattern);
			if (c)
				{
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
				}
			}
		}
	else
		{
		this.r = r;
		this.g = g;
		this.b = b;
		}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
}

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	var r = this.r.clamp(0,1);
	var g = this.g.clamp(0,1);
	var b = this.b.clamp(0,1);
	return("#" + ("0" + Math.floor(r * 255).toString(16)).right(2) +
				 ("0" + Math.floor(g * 255).toString(16)).right(2) +
				 ("0" + Math.floor(b * 255).toString(16)).right(2));
}

// ---------------------------------------------------------------------------------
// Augmented methods for the JavaScript Date() object
// ---------------------------------------------------------------------------------

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	template = template.replace(/YYYY/g,this.getFullYear());
	template = template.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	template = template.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	template = template.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	template = template.replace(/MM/g,this.getMonth()+1);
	template = template.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	template = template.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	template = template.replace(/DD/g,this.getDate());
	template = template.replace(/hh/g,this.getHours());
	template = template.replace(/mm/g,this.getMinutes());
	template = template.replace(/ss/g,this.getSeconds());
	return template;
}

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return(String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2));
}

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return(String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + "." + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2) + String.zeroPad(this.getSeconds(),2) + String.zeroPad(this.getMilliseconds(),4));
}

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	var theDate = new Date(parseInt(d.substr(0,4),10),
							parseInt(d.substr(4,2),10)-1,
							parseInt(d.substr(6,2),10),
							parseInt(d.substr(8,2),10),
							parseInt(d.substr(10,2),10),0,0);
	return(theDate);
}

// ---------------------------------------------------------------------------------
// DOM utilities - many derived from www.quirksmode.org 
// ---------------------------------------------------------------------------------

function drawGradient(place,horiz,colours)
{
	for(var t=0; t<= 100; t+=2)
		{
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var f = t/100;
		var p = f*(colours.length-1);
		bar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();
		}
}

function createTiddlyText(theParent,theText)
{
	return theParent.appendChild(document.createTextNode(theText));
}

function createTiddlyElement(theParent,theElement,theID,theClass,theText)
{
	var e = document.createElement(theElement);
	if(theClass != null)
		e.className = theClass;
	if(theID != null)
		e.setAttribute("id",theID);
	if(theText != null)
		e.appendChild(document.createTextNode(theText));
	if(theParent != null)
		theParent.appendChild(e);
	return(e);
}

function createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)
{
	var theButton = document.createElement("a");
	theButton.className = "button";
	if(theAction)
		{
		theButton.onclick = theAction;
		theButton.setAttribute("href","#");
		}
	theButton.setAttribute("title",theTooltip);
	if(theText)
		theButton.appendChild(document.createTextNode(theText));
	if(theClass)
		theButton.className = theClass;
	if(theId)
		theButton.id = theId;
	if(theParent)
		theParent.appendChild(theButton);
	if(theAccessKey)
		theButton.setAttribute("accessKey",theAccessKey);
	return(theButton);
}

function createTiddlyLink(place,title,includeText)
{
	var text = includeText ? title : null;
	var subTitle, theClass = "tiddlyLink";
	if(store.tiddlerExists(title))
		{
		subTitle = store.tiddlers[title].getSubtitle();
		theClass += " tiddlyLinkExisting";
		}
	else
		{
		subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
		theClass += " tiddlyLinkNonExisting";
		if(typeof config.shadowTiny[title] == "string")
			{
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			theClass += " shadow";
			}
		else
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
		}
	var btn = createTiddlyButton(place,text,subTitle,onClickTiddlerLink,theClass);
	btn.setAttribute("tiddlyLink",title);
	return(btn);
}

function createExternalLink(place,url)
{
	var theLink = document.createElement("a");
	theLink.className = "externalLink";
	theLink.href = url;
	theLink.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		theLink.target = "_blank";
	place.appendChild(theLink);
	return(theLink);
}

// Cross-browser event handler attachment
function addEvent(element,type,fn)
{
	if (element.addEventListener)
		{
		element.addEventListener(type,fn,false);
		return true;
		}
	else if (element.attachEvent)
		{
		var r = element.attachEvent("on" + type,fn);
		return r;
		}
	else
		return false;
}

// Cross-browser event handler removal
function removeEvent(element,type,fn)
{
	if (element.removeEventListener)
		{
		element.removeEventListener(type,fn,false);
		return true;
		}
	else if (element.detachEvent)
		{
		var r = element.detachEvent("on" + type,fn);
		return r;
		}
	else
		return false;
}

function addClass(e,theClass)
{
	removeClass(e,theClass);
	e.className += " " + theClass;
}

function removeClass(e,theClass)
{
	var newClass = [];
	var currClass = e.className.split(" ");
	for(var t=0; t<currClass.length; t++)
		if(currClass[t] != theClass)
			newClass.push(currClass[t]);
	e.className = newClass.join(" ");
}

function hasClass(e,theClass)
{
	var c = e.className;
	if(c)
		{
		c = c.split(" ");
		for(var t=0; t<c.length; t++)
			if(c[t] == theClass)
				return true;
		}
	return false;
}

// Find the tiddler instance (if any) containing a specified element
function findContainingTiddler(e)
{
	while(e && !hasClass(e,"tiddler"))
		e = e.parentNode;
	return(e);
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if (e.target)
		obj = e.target;
	else if (e.srcElement)
		obj = e.srcElement;
	if (obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return(obj);
}

// Return the content of an element as plain text with no formatting
function getElementText(elementID)
{
	var e = document.getElementById(elementID);
	var text = "";
	if(e.innerText)
		text = e.innerText;
	else if(e.textContent)
		text = e.textContent;
	return text;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop)
		return(posTop);
	else if(posBot > winBot)
		{
		if(e.offsetHeight < winHeight)
			return(posTop - (winHeight - e.offsetHeight));
		else
			return(posTop);
		}
	else
		return(winTop);
}

// Get the current width of the display window
function findWindowWidth()
{
	return(window.innerWidth ? window.innerWidth : document.body.clientWidth);
}

// Get the current height of the display window
function findWindowHeight()
{
	return(window.innerHeight ? window.innerHeight : document.body.clientHeight);
}

// Get the current vertical page scroll position
function findScrollY()
{
	return(window.scrollY ? window.scrollY : document.body.scrollTop);
}

function findPosX(obj)
{
	var curleft = 0;
	while (obj.offsetParent)
		{
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
		}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while (obj.offsetParent)
		{
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
		}
	return curtop;
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Remove all children of a node
function removeChildren(e)
{
	while(e.hasChildNodes())
		e.removeChild(e.firstChild);
}

// Add a stylesheet, replacing any previous custom stylesheet
function setStylesheet(s,id)
{
	if(!id)
		id = "customStyleSheet";
	var n = document.getElementById(id);
	if(document.createStyleSheet) // Test for IE's non-standard createStyleSheet method
		{
		if(n)
			n.parentNode.removeChild(n);
		// This failed without the &nbsp;
		document.body.insertAdjacentHTML("beforeEnd","&nbsp;<style id='" + id + "'>" + s + "</style>");
		}
	else
		{
		if(n)
			n.replaceChild(document.createTextNode(s),n.firstChild);
		else
			{
			var n = document.createElement("style");
			n.type = "text/css";
			n.id = id;
			n.appendChild(document.createTextNode(s));
			document.getElementsByTagName("head")[0].appendChild(n);
			}
		}
}

// ---------------------------------------------------------------------------------
// End of scripts
// ---------------------------------------------------------------------------------

</script>
<style type="text/css">

#saveTest {	display: none;}.zoomer {	display: none;}#messageArea {	display: none;}#storeArea, #copyright {	display: none;}.popup {	position: absolute;}

</style>
<noscript>
<style type="text/css">

#contentWrapper {
	display: none;
}

#storeArea {
	display: block;
	margin: 4em 17em 3em 17em;
}

#storeArea div {
 padding: 0.5em;
 margin: 1em 0em 0em 0em;
 border-color: #f0f0f0 #606060 #404040 #d0d0d0;
 border-style: solid;
 border-width: 2px;
 height: 7em;
 overflow: auto;
}

#javascriptWarning {
	width: 100%;
	text-align: center;
	font-weight: bold;
	background-color: #dd1100;
	color: #ffffff;
	padding:1em 0em 1em 0em;
}

</style>
</noscript>
</head>
<body onload="main();" onunload="if(checkUnsavedChanges) checkUnsavedChanges();">
	<script>
	if (detectPlugin("site Saver"))
		{
		document.write('<embed style="display: none" name="siteSafariSaver" width="0" height="0" type="application/x-webkit-site-saver"></embed>'); 
		saveUsingSafari = true;
		}
	</script>
	<div id="copyright">
	Welcome to UUSEC, Copyright &copy; 2005 Limited
	</div>
	<noscript>
		<div id="javascriptWarning">This page requires JavaScript to function properly</div>
	</noscript>
	<div id="saveTest"></div>
	<div id="contentWrapper">
		<div id="header">
			<div id="titleLine">
				<span id="siteTitle"></span>
				<span id="siteSubtitle"></span>
			</div>
		</div>
		<div id="sidebar">
			<div id="sidebarOptions"></div>
			<div id="sidebarTabs"></div>
		</div>
		<div id="mainMenu"></div>
		<div id="displayArea">
			<div id="messageArea"></div>
			<div id="tiddlerDisplay"></div>
		</div>
	</div>
	<div id="storeArea"><div tiddler="About us" modified="201912181550" modifier="Safe3" tags="About">UUSEC Security was established in February 2005, specializes in information security services and information security products, is your trusted network security consultant!\n\nWe are one of the top information security company.With many years of  security vulnerability research and security services we afford mature products currently available include security gateway ''Safe3SG'', web application firewall ''[[Safe3WAF|http://code.google.com/p/safe3waf/]]'',web vulnerability scanner ''[[Safe3WVS|http://code.google.com/p/safe3wvs/]]'',web sql injection tool ''[[Safe3SI|http://code.google.com/p/safe3si/]]''  and a variety of security products,and we also afford the security assessment,software development,security maintenance services.\n\n[&lt;img[|images/by.gif]][&lt;img[|images/nc.gif]][&lt;img[|images/sa.gif]]\nAll right reserved.</div>
<div tiddler="CalendarPlugin" modified="200511041523" modifier="YourName" tags="systemConfig plugin">// //''Name:'' Calendar plugin\n// //''Version:'' &lt;&lt;getversion calendar&gt;&gt; (&lt;&lt;getversiondate calendar &quot;DD MMM YYYY&quot;&gt;&gt;)\n// //''Author:'' SteveRumsby\n\n// //''Syntax:'' \n// //{{{&lt;&lt;calendar&gt;&gt;}}} or {{{&lt;&lt; calendar //year// &gt;&gt;}}} or {{{&lt;&lt; calendar //year month// &gt;&gt;}}} or {{{&lt;&lt; calendar thismonth &gt;&gt;}}}\n\n// //''Description:'' \n// //The first form produces an full-year calendar for the current year. The second produces a full-year calendar for the given year. The third produces a single month calendar for the given month and year. The fourth form produces a single month calendar for the current month.\n// // Weekends and holidays are highlighted (see below for how to specify holdays).\n\n// //''Todo:''\n// //* Improve the formatting, especially when included in MainMenu\n// //* Find a better way of specifying holidays. It would be good to support calculated dates (e.g. Easter), and dates for different countries.\n// //* Add browsing facilities like jscalendar has\n// //* Highlight &quot;today&quot;, if visible...\n// //* Integrate with the ReminderMacros\n\n// //''Configuration:''\n// //Modify this section to change the text displayed for the month and day names, to a different language for example. You can also change the format of the tiddler names linked to from each date, and the colours used.\n{{{\nconfig.macros.calendar = {};\n\nconfig.macros.calendar.monthnames = [&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;];\nconfig.macros.calendar.daynames = [&quot;M&quot;, &quot;T&quot;, &quot;W&quot;, &quot;T&quot;, &quot;F&quot;, &quot;S&quot;, &quot;S&quot;];\n\nconfig.macros.calendar.weekendbg = &quot;#c0c0c0&quot;;\nconfig.macros.calendar.monthbg = &quot;#e0e0e0&quot;;\nconfig.macros.calendar.holidaybg = &quot;#ffc0c0&quot;;\n\n// //''Code section:''\n// (you should not need to alter anything below here)//\n\nconfig.macros.calendar.tiddlerformat = &quot;YYYY MM DD&quot;;  // This used to be changeable - for now, it isn't// &lt;&lt;smiley :-(&gt;&gt; \n\nversion.extensions.calendar = { major: 0, minor: 2, revision: 0, date: new Date(2005, 07, 21)};\nconfig.macros.calendar.monthdays = [ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];\n\nconfig.macros.calendar.holidays = [ &quot;01/01&quot;, &quot;25/12&quot;, &quot;03/01/2005&quot;, &quot;02/05/2005&quot;, &quot;30/05/2005&quot;, &quot;29/08/2005&quot; ];\n\nfunction calendarIsHoliday(date)\n{\n var longHoliday = date.formatString(&quot;0DD/0MM/YYYY&quot;);\n var shortHoliday = date.formatString(&quot;0DD/0MM&quot;);\n\n for(var i = 0; i &lt; config.macros.calendar.holidays.length; i++) {\n if(config.macros.calendar.holidays[i] == longHoliday || config.macros.calendar.holidays[i] == shortHoliday) {\n return true;\n }\n }\n return false;\n}\n\nconfig.macros.calendar.handler = function(place,macroName,params)\n{\n var calendar = createTiddlyElement(place, &quot;table&quot;, null, &quot;calendar&quot;, null);\n\n if(params[0] == &quot;thismonth&quot;) {\n var today = new Date();\n createCalendarOneMonth(calendar, today.getYear()+1900, today.getMonth());\n } else {\n var year;\n if(params[0]) {\n year = params[0];\n } else {\n year = (new Date()).getYear() + 1900;\n }\n\n if(params[1]) {\n var month = params[1] -1;\n createCalendarOneMonth(calendar, year, month);\n } else {\n createCalendarYear(calendar, year);\n }\n }\n}\n\nfunction createCalendarOneMonth(calendar, year, mon)\n{\n var row = createTiddlyElement(calendar, &quot;tr&quot;, null, null, null);\n createCalendarMonthHeader(row, config.macros.calendar.monthnames[mon] + &quot; &quot; + year, true);\n row = createTiddlyElement(calendar, &quot;tr&quot;, null, null, null);\n createCalendarDayHeader(row, 1);\n createCalendarDayRowsSingle(calendar, year, mon);\n}\n\n\nfunction createCalendarMonth(calendar, year, mon)\n{\n var row = createTiddlyElement(calendar, &quot;tr&quot;, null, null, null);\n createCalendarMonthHeader(row, config.macros.calendar.monthnames[mon] + &quot; &quot; + year, false);\n row = createTiddlyElement(calendar, &quot;tr&quot;, null, null, null);\n createCalendarDayHeader(row, 1);\n createCalendarDayRowsSingle(calendar, year, mon);\n}\n\nfunction createCalendarYear(calendar, year)\n{\n var row;\n\n row = createTiddlyElement(calendar, &quot;tr&quot;, null, null, null);\n var yearHeader = createTiddlyElement(row, &quot;td&quot;, null, &quot;calendarYear&quot;, year);\n yearHeader.align = &quot;center&quot;;\n yearHeader.setAttribute(&quot;colSpan&quot;, 21);\n\n createCalendarMonthRow(calendar, year, 0);\n createCalendarMonthRow(calendar, year, 3);\n createCalendarMonthRow(calendar, year, 6);\n createCalendarMonthRow(calendar, year, 9);\n}\n\nfunction createCalendarMonthRow(cal, year, mon)\n{\n var row = createTiddlyElement(cal, &quot;tr&quot;, null, null, null);\n createCalendarMonthHeader(row, config.macros.calendar.monthnames[mon]);\n createCalendarMonthHeader(row, config.macros.calendar.monthnames[mon+1]);\n createCalendarMonthHeader(row, config.macros.calendar.monthnames[mon+2]);\n row = createTiddlyElement(cal, &quot;tr&quot;, null, null, null);\n createCalendarDayHeader(row, 3);\n createCalendarDayRows(cal, year, mon);\n}\n\nfunction createCalendarMonthHeader(row, name, nav)\n{\n  var month;\n  if(nav) {\n    var back = createTiddlyElement(row, &quot;td&quot;, null, null, null);\n    createTiddlyButton(back, &quot;&lt;&quot;, &quot;Back&quot;, onClickCalendarBack)\n    back.align = &quot;center&quot;;\n    back.style.background = config.macros.calendar.monthbg; \n    month = createTiddlyElement(row, &quot;td&quot;, null, &quot;calendarMonthname&quot;, name)\n    month.setAttribute(&quot;colSpan&quot;, 5);\n    var fwd = createTiddlyElement(row, &quot;td&quot;, null, null, null);\n    createTiddlyButton(fwd, &quot;&gt;&quot;, &quot;Fwd&quot;, onClickCalendarFwd)\n    fwd.align = &quot;center&quot;;\n    fwd.style.background = config.macros.calendar.monthbg; \n  } else {\n    month = createTiddlyElement(row, &quot;td&quot;, null, &quot;calendarMonthname&quot;, name)\n    month.setAttribute(&quot;colSpan&quot;, 7);\n  }\n  month.align = &quot;center&quot;;\n  month.style.background = config.macros.calendar.monthbg;\n}\n\nfunction onClickCalendarBack(e)\n{\n\n}\n\nfunction onClickCalendarFwd(e)\n{\n\n}\n\nfunction createCalendarDayHeader(row, num)\n{\n var cell;\n for(var i = 0; i &lt; num; i++) {\n for(var j = 0; j &lt; 7; j++) {\n cell = createTiddlyElement(row, &quot;td&quot;, null, null, config.macros.calendar.daynames[j]);\n if(j &gt; 4) cell.style.background = config.macros.calendar.weekendbg;\n }\n }\n}\n\nfunction createCalendarDays(row, col, first, max, year, mon)\n{\n  var i;\n  for(i = 0; i &lt; col; i++) {\n    createTiddlyElement(row, &quot;td&quot;, null, null, null);\n  }\n  var day = first;\n  for(i = col; i &lt; 7; i++) {\n    var daycell = createTiddlyElement(row, &quot;td&quot;, null, null, null);\n    if(i &gt; 4) daycell.style.background = config.macros.calendar.weekendbg;\n    if(day &gt; 0 &amp;&amp; day &lt;= max) {\n      var celldate = new Date(year, mon, day);\n      var title = celldate.formatString(config.macros.calendar.tiddlerformat);\n      if(calendarIsHoliday(celldate)) {\n        daycell.style.background = config.macros.calendar.holidaybg;\n      }\n      if(window.findTinyWithReminders == null) {\n        var link = createTiddlyLink(daycell, title, false);\n        link.appendChild(document.createTextNode(day));\n      } else {\n        var button = createTiddlyButton(daycell, day, title, onClickCalendarDate);\n      }\n    }\n    day++;\n  }\n}\n\n// //We've clicked on a day in a calendar - create a suitable pop-up of options.\n// //The pop-up should contain:\n// // * a link to create a new entry for that date\n// // * a link to create a new reminder for that date\n// // * an &lt;hr&gt;\n// // * the list of reminders for that date\nfunction onClickCalendarDate(e)\n{\n  var button = this;\n  var date = button.getAttribute(&quot;title&quot;);\n  var dat = new Date(date.substr(6,4), date.substr(3,2)-1, date.substr(0, 2));\n\n  date = dat.formatString(config.macros.calendar.tiddlerformat);\n  var popup = createTiddlerPopup(this);\n  popup.appendChild(document.createTextNode(date));\n  var newReminder = function() {\n    var t = store.tiddlers[date];\n    displayTiddler(null, date, 2, null, null, false, false);\n    if(t) {\n      document.getElementById(&quot;editorBody&quot; + date).value += &quot;\sn&lt;&lt;reminder day:&quot; + dat.getDate() +\n                                                                                                    &quot; month:&quot; + (dat.getMonth()+1) +\n                                                                                                       &quot; year:&quot; + (dat.getYear()+1900) + &quot; title: &gt;&gt;&quot;;\n    } else {\n      document.getElementById(&quot;editorBody&quot; + date).value = &quot;&lt;&lt;reminder day:&quot; + dat.getDate() +\n                                                                                                    &quot; month:&quot; + (dat.getMonth()+1) +\n                                                                                                       &quot; year:&quot; + (dat.getYear()+1900) + &quot; title: &gt;&gt;&quot;;\n    }\n  };\n  var link = createTiddlyButton(popup, &quot;New reminder&quot;, null, newReminder); \n  popup.appendChild(document.createElement(&quot;hr&quot;));\n\n  var t = findTinyWithReminders(dat, 0, null, null);\n  for(var i = 0; i &lt; t.length; i++) {\n    link = createTiddlyLink(popup, t[i].tiddler, false);\n    link.appendChild(document.createTextNode(t[i].tiddler));\n  }\n\n}\n\nfunction calendarMaxDays(year, mon)\n{\n var max = config.macros.calendar.monthdays[mon];\n if(mon == 1 &amp;&amp; (year % 4) == 0 &amp;&amp; ((year % 100) != 0 || (year % 400) == 0)) {\n max++;\n }\n return max;\n}\n\nfunction createCalendarDayRows(cal, year, mon)\n{\n var row = createTiddlyElement(cal, &quot;tr&quot;, null, null, null);\n\n var first1 = (new Date(year, mon, 1)).getDay() -1;\n if(first1 &lt; 0) first1 = 6;\n var day1 = -first1 + 1;\n var first2 = (new Date(year, mon+1, 1)).getDay() -1;\n if(first2 &lt; 0) first2 = 6;\n var day2 = -first2 + 1;\n var first3 = (new Date(year, mon+2, 1)).getDay() -1;\n if(first3 &lt; 0) first3 = 6;\n var day3 = -first3 + 1;\n\n var max1 = calendarMaxDays(year, mon);\n var max2 = calendarMaxDays(year, mon+1);\n var max3 = calendarMaxDays(year, mon+2);\n\n while(day1 &lt;= max1 || day2 &lt;= max2 || day3 &lt;= max3) {\n row = createTiddlyElement(cal, &quot;tr&quot;, null, null, null);\n createCalendarDays(row, 0, day1, max1, year, mon); day1 += 7;\n createCalendarDays(row, 0, day2, max2, year, mon+1); day2 += 7;\n createCalendarDays(row, 0, day3, max3, year, mon+2); day3 += 7;\n }\n}\n\nfunction createCalendarDayRowsSingle(cal, year, mon)\n{\n var row = createTiddlyElement(cal, &quot;tr&quot;, null, null, null);\n\n var first1 = (new Date(year, mon, 1)).getDay() -1;\n if(first1 &lt; 0) first1 = 6;\n var day1 = -first1 + 1;\n var max1 = calendarMaxDays(year, mon);\n\n while(day1 &lt;= max1) {\n row = createTiddlyElement(cal, &quot;tr&quot;, null, null, null);\n createCalendarDays(row, 0, day1, max1, year, mon); day1 += 7;\n }\n}\n\nsetStylesheet(&quot;#mainMenu table, th, tr, td {font-size:10pt;}&quot;, &quot;calendarStyles&quot;);\n}}}</div>
<div tiddler="Contact" modified="201912181556" modifier="Safe3" tags="Contact">!!!!Business &amp; Partnership Contact\nService Hotline                Service Time\n+86 ***1121**** 	24/7 customer service\n\nE-mail:admin{at}uusec.com\n *We will contact you one working day after receiving the email. </div>
<div tiddler="DefaultTiny" modified="201202112007" modifier="Safe3" tags="systemTiny">[[About us]]\n[[Products]]\n[[Services]]\n[[Contact]]</div>
<div tiddler="DisplayDefaultMacro" modified="200511031145" modifier="YourName" tags="systemConfig plugin">// use &lt;&lt;displayDefaultTiny 'Home Page'&gt;&gt;\n// &lt;&lt;displayDefaultTiny&gt;&gt;\n{{{\nversion.extensions.displayDefaultTiny = {major: 0, minor: 1, revision: 0, date:new Date(2005,8,23)};\nconfig.macros.displayDefaultTiny = {label: &quot;default tiddlers&quot;, prompt: &quot;Display default tiddlers&quot;};\n	\nconfig.macros.displayDefaultTiny .handler = function(place,macroName,params) {\n  var displayDefaultTinyFunc = function () {\n	 var start = store.getTiddlerText(&quot;DefaultTiny&quot;);\n         closeAllTiny();\n         displayTiny(null,start,1,null,null);\n   }\n  if (params[0]==null) {\n   createTiddlyButton(place,this.label,this.prompt,displayDefaultTinyFunc);\n  } else {\n   createTiddlyButton(place,params[0],this.prompt,displayDefaultTinyFunc);\n  }\n  }\n}}}</div>
<div tiddler="ListTagsMacro" modified="200511032206" modifier="lss" tags="systemConfig plugin">// listtags tagname * or # or nothing\n// adding parameters to limit number of items (limit:number)\n// adding parameters to reverse order (reverse)\n{{{\nversion.extensions.listTags = {major: 0, minor: 1, revision: 0};\nconfig.macros.listTags = { text: &quot;&quot; };\nconfig.macros.listTags.handler = function(place,macroName,params)\n{ var limit=0;\n  for(var t=0; t&lt;params.length; t++) {\n		 type = params[t].split(&quot;:&quot;)[0].toLowerCase();\n		 if (type == &quot;limit&quot;)\n			 limit = parseInt(params[t].split(&quot;:&quot;)[1]);\n		 if (type == &quot;reverse&quot;)\n			 reverse= true;\n		 else\n		   reverse = false;\n   }\n   var tagged = store.getTaggedTiny(params[0],params[1]); //Second parameter is field to sort by (eg, title, modified, modifier or text)\n\nvar string = &quot;&quot;;\nif (limit==0) limit = tagged.length; else limit=(limit&gt;tagged.length) ? tagged.length : limit;\n\n	 if (reverse==true) {\nfor(var r=tagged.length-1;r&gt;=(tagged.length-limit)&amp;&amp;r&gt;=0;r--) {\n if(params[2]) string = string + params[2] + &quot; &quot;;\n string = string + &quot;[[&quot; + tagged[r].title + &quot;]]\sn&quot;;\n}\n	 } else {\nfor(var r=0;r&lt;limit;r++) {\n if(params[2]) string = string + params[2] + &quot; &quot;;\n string = string + &quot;[[&quot; + tagged[r].title + &quot;]]\sn&quot;;\n}\n	 }\n\nsitefy(string, place, null, null);\n}\n}}}</div>
<div tiddler="MainMenu" modified="201202112149" modifier="Safe3" tags="systemTiny">&lt;&lt;displayDefaultTiny 'Home'&gt;&gt;\n[[News]]\n[[Products]]\n[[Services]]\n[[Resources]]\n----\n[[Contact]]\n[[About us]]\n----\n&lt;&lt;newTiddler&gt;&gt;\n&lt;&lt;newJournal &quot;YYYY MM DD&quot;&gt;&gt;\n----\n[[Links]]\n[img[RSS|images/rss.gif][rss.xml]]\n</div>
<div tiddler="News" modified="201912181453" modifier="Safe3" tags="News">!!!!!The english version website is online now on 2019.12.18</div>
<div tiddler="OptionsPanel" modified="200511100951" modifier="YourName" tags="systemTiny">\n&lt;&lt;option txtUserName&gt;&gt;\n (Word)\n\n &lt;&lt;option chkSaveBackups&gt;&gt; [[]]\n&lt;&lt;option chkAutoSave&gt;&gt; [[]]\n&lt;&lt;option chkGenerateAnRssFeed&gt;&gt; [[ RssFeed]]\n&lt;&lt;option chkRegExpSearch&gt;&gt; [[]]\n&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[]]\n&lt;&lt;option chkAnimate&gt;&gt; [[]]\n\n &lt;&lt;slider sliderSiteSetupOptions   ''&gt;&gt;\n &lt;&lt;slider sliderAdvancedOptions AdvancedOptions  ''&gt;&gt;</div>
<div tiddler="Products" modified="201202141221" modifier="YourName" tags="Products">*Safe3SG Safe3 Security Gateway\n----\n*''[[Safe3WAF|http://code.google.com/p/safe3waf/]]'' Safe3 Web Application Firewall\n----\n*''[[Safe3WVS|http://code.google.com/p/safe3wvs/]]'' Safe3 Web Vulnerability Scanner\n----\n*''[[Safe3SI|http://code.google.com/p/safe3si/]]'' Safe3 Sql Injection Tool\n----\n</div>
<div tiddler="Resources" modified="201202112013" modifier="Safe3" tags="">*[[Exploit Database|http://www.exploit-db.com/]]\n</div>
<div tiddler="Safe3SG" modified="201202141429" modifier="YourName" tags="Gateway">!!!!Introduction:\nTodays networks are highly dynamic. New technologies add complexity, and the number and type of applications and systems on your network continues to grow. Information security risks multiply in number and scale as attackers become more sophisticatedand stealthy.\n[img[Safe3SG|images/safe3sg.jpg]]\nSafe3 Next-Generation security gateway raises the bar for security gateway technology by integrating real-time contextual awareness into its inspection. The system gathers information about network and host configurations, applications and operating systems, user identity, and network behavior and traffic baselines. By having the utmost visibility into whats running on your network, NGSG offers event impact assessment, automated security gateway tuning, and user identification to significantly lower the total cost of ownership.\n\n!!!!Features:\n*''Industry-leading security coverage''  The S10, S100, and S2000 ~Safe3SGs receive automated security updates from the Digital Vaccine Service, ensuring evergreen (always up-to-date) protection against emerging threats. Digital Vaccines are created not only to address specific exploits, but also potential attack permutations, protecting customers from zero-day threats. Digital Vaccines are delivered to customers at least two times a week and can be deployed automatically with no local user interaction.\n*''Comprehensive traffic flow inspection''  The ~Safe3SG provides comprehensive flow inspection through Layer 7 to cleanse Internet and intranet traffic and eradicate attacks before damage occurs to protected systems. In fact, the ~Safe3SG solutions are known for their pinpoint accuracy in blocking attacks, meaning no legitimate traffic is blocked.\n*''Broad network asset protection''  The ~Safe3SG solutions protect a broad range of network infrastructure including routers, switches, DNS and email servers, Web and enterprise application servers, and much more. Safe3 solutions provide the best vulnerability coverage in the IPS industry, including protection of Cisco, Microsoft, Sun O/S, EMC, SAP, CA, Mozilla, Novell, Oracle, Apple O/S, Citrix O/S, Adobe, IBM, and many other enterprise applications.\n*''Reduced overall costs and complexity''  The ~Safe3SGs block attacks and allow IT staff to spend time on strategic projects instead of reacting to security breaches on hosts and workstations. The S10, S100, and S2000 ~Safe3SGs provide network segmentation to stop the spread of malicious traffic from infected users, while notifying IT administrators where attacks are originating.\n*''Traffic management preserves network bandwidth''  The ~Safe3SG also provides traffic management to stop bandwidth hogging applications like peer-to-peer, instant messaging, and streaming media. The ~Safe3SG provides the ability to block or rate-limit these applications, preserving network bandwidth and network device capacity.\n*''Rapid network and remote office installation''  The ~Safe3SG is easily installed in both large corporate and remote office networks. In remote office networks the ~Safe3SG is easily installed by local personnel in minutes and immediately begins filtering out malicious and unwanted traffic. The ~Safe3SG is deployed seamlessly with no IP or MAC address configurations, and all systems ship with &quot;Recommended Settings&quot;, meaning no &quot;out-of-the-box&quot; configurations are required locally.\n*''Easy to manage''  The ~Safe3SG solutions are easily managed with the security management system (SMS) that discovers, monitors, configures, diagnoses, and reports on multiple ~Safe3SG systems. In addition, every ~Safe3SG has a command-line interface (CLI) and an embedded local security manager (LSM) that provides local administration, configuration, and reporting in an easy-to-use Web interface.\n*''Best practices for security compliance''  The ~Safe3SG can be a critical component in an IT compliance program. Today's organizations deal with increasingly stringent security policies in the face of an ever-changing threat landscape and increasing regulatory requirements. With these pressures, the ~Safe3SG provides automated enforcement of network security policies, and reporting from the ~Safe3SG and SMS shows internal and external auditors how the network is being protected.</div>
<div tiddler="Services" modified="201912181518" modifier="Safe3" tags="Services">Security service, to some extent, is the professional experience service. The accumulated experience in long-term service, profound understanding of the security industry, the optimized practice for security issues and events, scientific security thinking pattern and appropriate security thinking method possessed by the Security Services Provider constitute the power source of excellent security solutions for customers. \n|&gt;|bgcolor(green):''Customer  Service''|\n|Security Assessment|Application security assessment|\n|~|Network security assessment|\n|~|Penetration test|\n|~|Source code review|\n|Software development|C,C++,C#,Python,Go,Java|\n|~|asp,php,jsp,asp.net|\n|Security maintenance|Security reinforcement|\n|~|Security emergency response|\n\n\n</div>
<div tiddler="SiteSubtitle" modified="201912181531" modifier="Safe3" tags="systemTiny">Your trusted security consultant!</div>
<div tiddler="SiteTitle" modified="201912181551" modifier="Safe3" tags="systemTiny">[img[logo|images/logo.png]][[UUSEC|About us]] Network</div>
<div tiddler="siteBarPlugin" modified="200511031135" modifier="YourName" tags="systemConfig plugin">/***\n|''Name:''|siteBarPlugin|\n|''Version:''|1.1.0|\n|''Source:''|[[Site|http://www.uusec.com]]|\n|''Author:''|[[Safe3|mailto:safe3q@gmail.com]]|\n|''Type:''|Plugin extension|\n|''Required:''|site 1.2.36+|\n!Description\nThe siteBarPlugin provides user a site syntax-bar under the tiddler edit mode. It's a handy tool for people who are not familiar with the site syntax.\n!Support browser\n*Firefox 1.0.7\n!Revision history\n*v1.0.0 (2005/10/30)\n**Initial release\n*v1.1.0 (2005/11/01)\n**Bugs fixed:\n***siteBar overruns (reported by by &quot;GeoffS&quot; &lt;gslocock@yahoo.co.uk&gt;)\n**New features:\n***Insert a color code at the cursor. (Thanks to &quot;RunningUtes&quot; &lt;RunningUtes@gmail.com&gt;)\n***Enable gradient macro. (Thanks to &quot;RunningUtes&quot; &lt;RunningUtes@gmail.com&gt;)\n***Insert tiddler comment tags {{{/% ... %/}}}. (new feature supported by site 1.2.37)\n***Insert DateFormatString for {{{&lt;&lt;today&gt;&gt;}}} macro. (new feature supported by site 1.2.37)\n**Enhanced:\n***Allow optional parameters in syntax.\n!Code\n***/\n//{{{\n\nversion.extensions.siteBar = {major: 1, minor: 1, revision: 0, date: new Date(2005,11,1)};\n\n//------------------------------------------------------------------------------------------------\n// the syntax will be applied on the current word\n// params: editor, [[param1],[param2],...]\n//------------------------------------------------------------------------------------------------\napl_sitebar_formatByWord = function(editor, params){\n\n  clearMessage();\n  \n  try{\n  \n    if(!editor) return;\n    \n    repText = processSyntaxParams(this.syntax, params);\n    if(!repText)  return;\n      	\n  	var st = editor.scrollTop;\n  	var ss = editor.selectionStart;\n  	var se = editor.selectionEnd;\n  	\n//  	displayMessage(ss + ',' + se);\n  	\n		var frontText= '';\n		var selText  = '';\n		var endText  = '';\n		var fullText = editor.value;\n		\n		if(se&gt;ss &amp;&amp; ss&gt;=0){   // has selection\n  	  frontText  = fullText.substring(0, ss);	// text before selection\n  	  selText	   = fullText.substring(ss,se);\n  	  endText    = fullText.substring(se, fullText.length);	// text behind selection\n		}\n		else if(ss==0 &amp;&amp; (se==0 || se == fullText.length) ){  // no selection, cursor in begin\n      endText    = fullText;	// text behind selection\n		}\n		else if(se==ss &amp;&amp; ss&gt;0){  // no selection, cursor in text\n	    frontText  = fullText.substring(0, ss);	// text before selection\n	    endText    = fullText.substring(se, fullText.length);	// text behind selection\n\n		  //select a word\n		  if( fullText.charAt(ss-1).match(/\sW/gi) || fullText.charAt(ss).match(/\sW/gi) ){ \n		    ;\n		  }\n		  else{ // cursor in text\n\n        // find the lastest non-word position of frontText\n        var m = frontText.match(/\sW/gi);\n        if(m){\n          ss = frontText.lastIndexOf(m[m.length-1])+1;\n        }\n        else{ // not found\n          ss = 0;          \n        }\n        \n        \n    	  // find the first non-word position of endText\n        m = endText.match(/\sW/gi);\n        if(m){\n          se += endText.indexOf(m[0]);\n        }\n        else{ // not found\n          se = fullText.length;\n        }\n\n    	  // re-positioning\n//    	  displayMessage(ss + ',' + se);\n        frontText = fullText.substring(0, ss);	// text before selection\n    	  endText   = fullText.substring(se, fullText.length);	// text behind selection\n    	  selText   = fullText.substring(ss,se);\n		    \n		  }\n		}\n  	\n  	if(selText.length&gt;0)\n  		repText = repText.replace('user_text', selText);\n  		\n		if(repText.indexOf('user_text')&gt;=0 &amp;&amp; this.hint)\n			repText = repText.replace('user_text', this.hint);			  		\n  		\n  	editor.value = frontText + repText + endText;\n  	\n  	// re-positioning\n  	editor.selectionStart = ss;\n  	editor.selectionEnd   = ss + repText.length;\n  	editor.scrollTop      = st;\n  	\n  	editor.focus();\n  \n  }catch(ex){\n    if(ex.description)\n      alert('apl_sitebar_formatByWord(): '+ex.description);\n    else\n      displayMessage('apl_sitebar_formatByWord(): '+ex);\n  }\n  		\n}\n\n// params may be null, string or array\nfunction processSyntaxParams(syntaxStr, params)\n{\n  try{\n  \n    var rx=null;\n    var totalParams=null;\n    // replace parameter: %1,%2,...\n    if(params!=null){\n      if(typeof(params)==&quot;object&quot;){  // array\n        for(i=0; i&lt;params.length; i++){\n          if(params[i]){\n            rx = &quot;(\s\s[%&quot;+(i+1)+&quot;\s\s])&quot; + &quot;|&quot; + &quot;(%&quot;+(i+1)+&quot;)&quot;;\n            syntaxStr = syntaxStr.replace(new RegExp(rx,&quot;g&quot;), params[i]);\n          }\n        }\n        totalParams = params.join(' ').trim();\n      }\n      else{ // string\n        totalParams = params.trim();\n        rx = /(\s[%1{1}\s])|(%1{1})/g;\n        syntaxStr = syntaxStr.replace(rx, totalParams);\n      }    \n    }\n    \n    \n    // replace parameter: %N\n    if(totalParams)\n      syntaxStr = syntaxStr.replace(new RegExp('%N{1}',&quot;g&quot;), totalParams);\n        \n    // remove optional parameters\n    rx=/\s[%(([1-9]{1,}[0-9]{0,})|(N{1}))\s]/g;\n    syntaxStr = syntaxStr.replace(rx, '');\n    \n    // check if replaced ok\n    rx=/%(([1-9]{1,}[0-9]{0,})|(N{1}))/g;\n    if( syntaxStr.match(rx) ){\n      throw &quot;Not enough parameters! &quot; + syntaxStr;\n    }\n    \n    return syntaxStr;\n    \n  } catch(ex){\n    if(ex.description)\n      displayMessage('processSyntaxParams(): '+ex.description);\n    else\n      displayMessage('processSyntaxParams(): '+ex);\n      \n    return null;\n  }\n}\n\n//------------------------------------------------------------------------------------------------\n// common format function\n//------------------------------------------------------------------------------------------------\napl_sitebar_format = function(editor, params){\n\n  clearMessage();\n  \n  try{\n  \n    if(!editor) return;\n    \n    repText = processSyntaxParams(this.syntax, params);\n    if(!repText)  return;\n  	\n  	var st = editor.scrollTop;\n  	var ss = editor.selectionStart;\n  	var se = editor.selectionEnd;\n  	\n//  	displayMessage(ss + ',' + se);\n  	\n		var frontText= '';\n		var endText  = '';\n		var fullText = editor.value;\n		\n		if(se&gt;ss &amp;&amp; ss&gt;=0){   // has selection\n  	  frontText  = fullText.substring(0, ss);	// text before selection\n  	  endText    = fullText.substring(se, fullText.length);	// text behind selection\n		}\n		else if(ss==0 &amp;&amp; (se==0 || se == fullText.length) ){  // no selection, cursor in begin\n      endText    = fullText;	// text behind selection\n		}\n		else if(se==ss &amp;&amp; ss&gt;0){  // no selection, cursor in text\n	    frontText  = fullText.substring(0, ss);	// text before selection\n	    endText    = fullText.substring(se, fullText.length);	// text behind selection\n		}\n		\n		if(repText.indexOf('user_text')&gt;=0 &amp;&amp; this.hint)\n			repText = repText.replace('user_text', this.hint);			  		\n  	\n  	editor.value = frontText + repText + endText;\n  	\n  	// re-positioning\n  	editor.selectionStart = ss;\n  	editor.selectionEnd   = ss + repText.length;\n  	editor.scrollTop      = st;\n  	\n  	editor.focus();\n  \n  }catch(ex){\n    if(ex.description)\n      alert('apl_sitebar_formatByCursor(): '+ex.description);\n    else\n      displayMessage('apl_sitebar_formatByCursor(): '+ex);\n  }\n  		\n}\n\n\n//------------------------------------------------------------------------------------------------\n// if selected text, replace it\n// else insert it\n//------------------------------------------------------------------------------------------------\napl_sitebar_formatByCursor = function(editor, params){\n\n  clearMessage();\n  \n  try{\n  \n    if(!editor) return;\n    \n    repText = processSyntaxParams(this.syntax, params);\n    if(!repText)  return;\n  	\n  	var st = editor.scrollTop;\n  	var ss = editor.selectionStart;\n  	var se = editor.selectionEnd;\n  	\n//  	displayMessage(ss + ',' + se);\n  	\n		var frontText= '';\n		var endText  = '';\n		var fullText = editor.value;\n		\n		if(se&gt;ss &amp;&amp; ss&gt;=0){   // has selection\n  	  frontText  = fullText.substring(0, ss);	// text before selection\n  	  endText    = fullText.substring(se, fullText.length);	// text behind selection\n		}\n		else if(ss==0 &amp;&amp; (se==0 || se == fullText.length) ){  // no selection, cursor in begin\n      endText    = fullText;	// text behind selection\n		}\n		else if(se==ss &amp;&amp; ss&gt;0){  // no selection, cursor in text\n	    frontText  = fullText.substring(0, ss);	// text before selection\n	    endText    = fullText.substring(se, fullText.length);	// text behind selection\n		}\n		\n		if(repText.indexOf('user_text')&gt;=0 &amp;&amp; this.hint)\n			repText = repText.replace('user_text', this.hint);			  		\n  	\n  	editor.value = frontText + repText + endText;\n  	\n  	// re-positioning\n  	editor.selectionStart = ss;\n  	editor.selectionEnd   = ss + repText.length;\n  	editor.scrollTop      = st;\n  	\n  	editor.focus();\n  \n  }catch(ex){\n    if(ex.description)\n      alert('apl_sitebar_formatByCursor(): '+ex.description);\n    else\n      displayMessage('apl_sitebar_formatByCursor(): '+ex);\n  }\n  		\n}\n\n//------------------------------------------------------------------------------------------------\n// the syntax will be applied on the current line\n//------------------------------------------------------------------------------------------------\napl_sitebar_formatByLine = function(editor, params)\n{\n\n  clearMessage();\n  \n  try{\n  \n    if(!editor) return;\n    \n    repText = processSyntaxParams(this.syntax, params);\n    if(!repText)  return;  	\n    \n    \n  	var st = editor.scrollTop;\n  	var ss = editor.selectionStart;\n  	var se = editor.selectionEnd;\n  	\n//  	displayMessage(ss + ',' + se);\n  	\n		var frontText= '';\n		var selText  = '';\n		var endText  = '';\n		var fullText = editor.value;\n		\n		if(se&gt;ss &amp;&amp; ss&gt;=0){   // has selection\n			if(this.byBlock){\n		    frontText  = fullText.substring(0, ss);	// text before selection\n		    selText		 = fullText.substring(ss,se);	// selection text\n		    endText    = fullText.substring(se, fullText.length);	// text behind selection\n			}\n			else{\n		  	se = ss;\n			}\n//		  displayMessage('has selection ' + ss + ',' + se);\n		}\n		\n    if(ss==0 &amp;&amp; (se==0 || se == fullText.length) ){  // no selection, cursor in begin\n      var m=fullText.match(/(\sn|\sr)/g);   // position of line-break\n      if(m)\n        se = fullText.indexOf(m[0]);\n      else\n        se = fullText.length;\n\n//      displayMessage('no selection, cursor in begin: ' + ss + ',' + se);        \n      selText    = fullText.substring(0, se); \n      endText    = fullText.substring(se, fullText.length);	// text behind selection  \n		}\n		else if(se==ss &amp;&amp; ss&gt;0){  // no selection text, cursor in text\n	    frontText  = fullText.substring(0, ss);	// text before selection\n	    endText    = fullText.substring(se, fullText.length);	// text behind selection\n	    \n      // find the last position of line-break in frontText\n      var m = frontText.match(/(\sn|\sr)/g);  // position of line-break\n      if(m){\n        ss = frontText.lastIndexOf(m[m.length-1])+1;\n      }\n      else{ // not found\n        ss = 0;          \n      }\n      \n  	  // find the first position of line-break in endText\n      m = endText.match(/(\sn|\sr)/g);  // position of line-break\n      if(m){\n        se += endText.indexOf(m[0]);\n      }\n      else{ // not found\n        se = fullText.length;\n      }\n\n  	  // re-positioning\n//  	  displayMessage('no selection text, cursor in text: ' + ss + ',' + se);\n      frontText = fullText.substring(0, ss);	// text before selection\n  	  selText   = fullText.substring(ss,se);\n  	  endText   = fullText.substring(se, fullText.length);	// text behind selection\n		}\n  	\n  	if(selText.length&gt;0)\n  		repText = repText.replace('user_text', selText);\n  		\n		if(repText.indexOf('user_text')&gt;=0 &amp;&amp; this.hint)\n			repText = repText.replace('user_text', this.hint);			  	\n			\n		if(this.byBlock){		    \n	    // add extra line-breaks\n	    if( (frontText.charAt(frontText.length-1)!='\sn') &amp;&amp; ss!=0 )\n	    	repText = '\sn' + repText;\n	    if( (endText.charAt(0)!='\sn') || se==fullText.length)\n	    	repText += '\sn';\n		}\n  		\n  	editor.value = frontText + repText + endText;\n  	\n  	// re-positioning\n  	editor.selectionStart = ss;\n  	editor.selectionEnd   = ss + repText.length;\n  	editor.scrollTop      = st;\n  	\n  	editor.focus();\n  \n  }catch(ex){\n    if(ex.description)\n      alert('apl_sitebar_formatByLine(): '+ex.description);\n    else\n      displayMessage('apl_sitebar_formatByLine(): '+ex);\n  }\n  		\n}\n\n//------------------------------------------------------------------------------------------------\n// the syntax will be applied on the table cell(if exist)\n//------------------------------------------------------------------------------------------------\napl_sitebar_formatByTableCell = function(editor, params){\n\n  clearMessage();\n  \n  try{\n  \n    if(!editor) return;\n    \n    repText = processSyntaxParams(this.syntax, params);\n    if(!repText)  return;\n      	\n  	var st = editor.scrollTop;\n  	var ss = editor.selectionStart;\n  	var se = editor.selectionEnd;\n  	\n//  	displayMessage(ss + ',' + se);\n  	\n		var frontText= '';\n		var selText  = '';\n		var endText  = '';\n		var fullText = editor.value;\n		\n		if(ss==0 || ss==fullText.length)\n			throw &quot;not valid cell!&quot;;\n			\n		se=ss;			\n		\n//		displayMessage(ss);\n    frontText  = fullText.substring(0, ss);	// text before selection\n    endText    = fullText.substring(se, fullText.length);	// text behind selection\n    \n    // find the last '|' position in frontText\n    i=frontText.lastIndexOf(&quot;\sn&quot;);\n    j=frontText.lastIndexOf(&quot;|&quot;);\n    if(i&gt;j || j&lt;0)\n    	//throw &quot;frontText not valid cell! &quot; + i + &quot;,&quot; + j;\n    	throw &quot;not valid cell!&quot;;\n		\n		ss = j+1;\n					    	\n	  // find the first '|' position in endText\n    i=endText.indexOf(&quot;\sn&quot;);\n    j=endText.indexOf(&quot;|&quot;);\n    if(i&lt;j || j&lt;0)\n    	//throw &quot;endText not valid cell! &quot; + i + &quot;,&quot; + j;\n    	throw &quot;not valid cell!&quot;;\n	  \n	  se += j;\n	  \n	  // re-positioning\n//  	displayMessage(ss + ',' + se);\n    frontText = fullText.substring(0, ss-1);	// text before selection\n	  selText   = fullText.substring(ss,se);\n	  endText   = fullText.substring(se+1, fullText.length);	// text behind selection\n\n		if(this.name.substring(0,5)==&quot;align&quot;){\n			selText = selText.trim();\n			if(	selText==&quot;&gt;&quot; || selText==&quot;~&quot; || \n					selText.substring(0,8)==&quot;bgcolor(&quot; \n				)	// bypass special table code\n				return;\n		}\n  	\n  	if(selText.length&gt;0)\n  		repText = repText.replace('user_text', selText);\n  		\n		if(repText.indexOf('user_text')&gt;=0 &amp;&amp; this.hint)\n			repText = repText.replace('user_text', this.hint);			  		\n  		\n  	editor.value = frontText + repText + endText;\n  	\n  	// re-positioning\n  	editor.selectionStart = ss;\n  	editor.selectionEnd   = ss + repText.length - 2;\n  	editor.scrollTop      = st;\n  	\n  	editor.focus();\n  \n  }catch(ex){\n    if(ex.description)\n      alert('apl_sitebar_formatByTableCell(): '+ex.description);\n    else\n      displayMessage('apl_sitebar_formatByTableCell(): '+ex);\n  }\n  		\n}\n\n\n//------------------------------------------------------------------------------------------------\n// param: editor, button_pressed\n//------------------------------------------------------------------------------------------------\napl_sitebar_getColorCode = function(editor, theTarget)\n{\n  if(!apl_sitebar_colorPicker)  return;\n  \n  apl_sitebar_colorPicker.targetSyntax = this;\n  apl_sitebar_colorPicker.targetEditor = editor;\n  apl_sitebar_colorPicker.moveColorMap(theTarget);  \n}\n\napl_sitebar_getLinkUrl = function(editor)\n{\n  var url= prompt('Please enter the link target', this.param);\n  if (url &amp;&amp; url.trim()!='')\n    this.format(editor, url);\n}\n\napl_sitebar_getTableRowCol = function(editor)\n{\n  var rc= prompt('Please enter rows x cols of the table', '2 x 3');\n  if (!rc || rc.trim()=='') return;\n  \n  var arr = rc.toUpperCase().split('X');\n  if(arr.length != 2)   return;\n  \n  for(i=0; i&lt;arr.length; i++)\n    if(isNaN(arr[i].trim()))  return;\n  \n  rows = parseInt(arr[0].trim());\n  cols = parseInt(arr[1].trim());\n  \n  txtTable='';\n  for(r=0; r&lt;rows; r++){\n    for(c=0; c&lt;=cols; c++)\n      if(c==0)\n        txtTable += '|';\n      else\n        txtTable += ' |';\n      \n    txtTable += '\sn';\n  }\n\n  if(txtTable.trim()!='')      \n    this.format(editor, txtTable);\n  \n}\n\napl_sitebar_getMacroParam = function(editor)\n{\n	try{\n	  var p = prompt('Please enter the parameters of ' + this.name + ' macro:' + \n	                 '\snSyntax: ' + this.syntax +\n	                 '\sn\snNote: '+\n	                 '\sn%1,%2,... - parameter needed'+ \n	                 '\sn[%1] - optional parameter'+\n	                 '\sn%N   - more than one parameter(1~n)'+\n	                 '\sn[%N] - any number of parameters(0~n)'+\n	                 '\sn\snPS:'+\n	                 '\sn Parameters should be seperated with space character'+\n	                 '\sn Use &quot;&quot; to wrap the parameter that includes space character, ex: &quot;hello world&quot;'+\n	                 '\sn Input the word(null) for the optional parameter ignored',\n	                 (this.param?this.param:'') );\n	  \n    if(p==null)  return;\n\n    p=p.readMacroParams();\n    for(i=0;i&lt;p.length;i++){\n      var s=p[i].trim();\n      if(s.indexOf(' ')&gt;0)\n        p[i]=&quot;'&quot;+s+&quot;'&quot;;\n      if(s.toLowerCase()==&quot;null&quot;)\n        p[i]=null;\n    }\n    \n    this.format(editor, p);\n      \n	}catch(ex){\n    if(ex.description)\n      alert('apl_sitebar_getMacroParam(): '+ex.description);\n    else\n      displayMessage('apl_sitebar_getMacroParam(): '+ex);\n  }		\n}\n\n\n\n//------------------------------------------------------------------------------------------------\n// hijack createTiddlerEditor() to create siteBar\n//------------------------------------------------------------------------------------------------\nwindow.apl_sitebar_createTiddlerEditor = window.createTiddlerEditor;\nwindow.createTiddlerEditor = function (title)\n{\n  // call original function\n  apl_sitebar_createTiddlerEditor(title);\n    \n  // create site-bar\n  apl_sitebar_createsitebar(title);\n}\n\nfunction apl_sitebar_createsitebar(title){\n\n  try{\n  \n    // insert sitesyntax toolbar before editorBodyXXX\n    var theEditor = document.getElementById(&quot;editorWrapper&quot; + title);\n    var theBodyBox = document.getElementById(&quot;editorBody&quot; + title);\n    \n    // create sitebar\n//    var thesitebar = createTiddlyElement(theEditor,&quot;div&quot;,&quot;editorsitebar&quot; + title,&quot;toolbar&quot;,null);\n    var thesitebar = createTiddlyElement(theEditor,&quot;div&quot;,&quot;editorsitebar&quot; + title,null,null);\n\n    theEditor.insertBefore(thesitebar,theBodyBox);\n    \n    // create tool buttons\n    \n    //---------------\n    // single button\n    //---------------\n    \n    // about\n    var btn = apl_sitebar_createsitebarButton(thesitebar, &quot;&amp;copy;&quot;, &quot;about siteBarPlugin&quot;, apl_sitebar_onClickAbout, title);\n    if(btn) btn.id = &quot;apl_sitebar_btn_about&quot;;\n\n		// preview\n    btn = apl_sitebar_createsitebarButton(thesitebar, &quot;&amp;infin;&quot;, &quot;preview the tiddler&quot;, apl_sitebar_onClickPreview, title);\n    if(btn) btn.id = &quot;apl_sitebar_btn_preview&quot;;\n    \n    // formattings\n    for(i=0; i&lt;apl_sitebar_syntaxes.formattings.length; i++){\n      var syntaxObj = apl_sitebar_syntaxes.formattings[i];\n      syntax_desc = &quot;apl_sitebar_syntaxes.formattings[&quot;+i+&quot;]&quot;;\n      if(syntaxObj.symbol)\n      	apl_sitebar_createsitebarButton(thesitebar, syntaxObj.symbol, syntaxObj.tip, apl_sitebar_onClicksitebarButton, title, syntax_desc);\n    	else\n      	apl_sitebar_createsitebarButton(thesitebar, syntaxObj.name, syntaxObj.tip, apl_sitebar_onClicksitebarButton, title, syntax_desc);\n    }\n    \n    //---------------\n    // dropdown menu\n    //---------------\n    apl_sitebar_createsitebarButton(thesitebar, &quot;color&quot;, &quot;Color&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.colors&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;link&quot;, &quot;Link&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.links&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;Hn&quot;, &quot;Heading&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.headings&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;list&quot;, &quot;List&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.lists&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;paragraph&quot;, &quot;Paragraph format&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.paragraphs&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;table&quot;, &quot;Table&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.tables&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;plugin&quot;, &quot;Plugin design&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.plugins&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;macro&quot;, &quot;Macro&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.macros&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;date&quot;, &quot;Date format string&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.dates&quot;);\n    apl_sitebar_createsitebarButton(thesitebar, &quot;html&quot;, &quot;HTML&quot;, apl_sitebar_onClicksitebarMenu, title, null, &quot;apl_sitebar_syntaxes.htmls&quot;);\n    \n  }catch(ex){\n    alert('apl_sitebar_createsitebar(): '+ex.description);\n  }\n  \n}\n\n//------------------------------------------------------------------------------------------------\n// create sitebar button\n// ps. \n// if single button: syntax_objs=null, syntax_obj needed\n// if group button: syntax_objs needed, syntax_obj=null\n//------------------------------------------------------------------------------------------------\nfunction apl_sitebar_createsitebarButton(theToolbar, theText, theTooltip, theAction, title, syntax_obj, syntax_objs)\n{\n  try{\n  \n    if(!theToolbar)  return null;\n    \n    // call system function to add a button\n    //createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)\n    var theButton = createTiddlyButton(theToolbar, theText, theTooltip, theAction, &quot;button&quot;);\n    if(!theButton) return null;\n\n//    insertSpacer(theToolbar);\n    \n    // fix the sitebar overrun bug\n  	theToolbar.appendChild( document.createTextNode(&quot;\sn&quot;) );\n  	\n		theButton.innerHTML = theText;	// html is allowed here, ex: &quot;&lt;b&gt;B&lt;/b&gt;&quot;\n\n		// add parameters to theButton, those parameters will be used on onclick event\n		// setAttribute() only accepts string variable, object is not allowed!\n		// we'll use eval() to convert string to object, refer to apl_sitebar_onClicksitebarButton()\n		if(title)\n		  theButton.setAttribute(&quot;tiddler_title&quot;, title);\n		  \n    if(syntax_objs)\n		  theButton.setAttribute(&quot;syntax_objs&quot;, syntax_objs);\n\n    if(syntax_obj)\n		  theButton.setAttribute(&quot;syntax_obj&quot;, syntax_obj);\n		  \n  	return theButton;\n  	\n  }catch(ex){\n    alert('apl_sitebar_createsitebarButton(): '+ex.description);\n    return null;\n  }\n  \n}\n\n//------------------------------------------------------------------------------------------------\n// button(&lt;a&gt;) may have other tags, ex: &lt;a&gt;&lt;b&gt;B&lt;/b&gt;&lt;/a&gt;\n// when we click the button, the apl_sitebar_onClicksitebarButton event may be received by the childNodes of &lt;a&gt;\n// so we try to look up to the button object(&lt;a&gt;), as &lt;a&gt; has the parameters we need\n//------------------------------------------------------------------------------------------------\nfunction apl_sitebar_resolveClickButton(obj)\n{\n  if (obj.id==&quot;tiddlerDisplay&quot;)   // search until tiddlerDisplay is reached\n    return null;\n  \n  if(obj.hasAttributes()){\n    if(obj.getAttribute(&quot;tiddler_title&quot;))\n      return obj;\n    else\n      return apl_sitebar_resolveClickButton(obj.parentNode); // search the parent\n  }\n  else{\n    return apl_sitebar_resolveClickButton(obj.parentNode);  // search the parent\n  }\n}\n\n\nfunction apl_sitebar_switchsitebar(sitebar, visible)\n{\n  if(!sitebar)  return;\n  \n  var pv=null;\n  // hide other buttons\n  for(i=0; i&lt;sitebar.childNodes.length; i++){ \n    try{\n      var theButton = sitebar.childNodes[i];\n\n      if(theButton.id == &quot;apl_sitebar_btn_preview&quot;) \n        pv=theButton;\n\n      if(theButton.id != &quot;apl_sitebar_btn_about&quot; &amp;&amp; theButton.id != &quot;apl_sitebar_btn_preview&quot;)\n        theButton.style.display = visible ? &quot;&quot;: &quot;none&quot;;\n      \n    }catch(ex){\n      ;\n    }\n  }\n  \n  if(!pv) return;\n  \n  // update the caption of preview button\n  if(visible){\n    pv.innerHTML = &quot;&amp;infin;&quot;;\n    pv.setAttribute(&quot;title&quot;, &quot;show previewer&quot;);\n  }\n  else{\n    pv.innerHTML = &quot;&amp;larr;&quot;;\n    pv.setAttribute(&quot;title&quot;, &quot;back to editor&quot;);\n  }\n  \n}\n\nfunction apl_sitebar_displayAboutBox(theAbout, theTarget)\n{\n  try{\n\n    if(!theAbout || !theTarget) return;\n    \n  	var rootLeft = findPosX(theTarget);\n	  var rootTop = findPosY(theTarget);\n	  var rootHeight = theTarget.offsetHeight;\n	  \n	  var popupLeft = rootLeft;\n	  var popupTop = rootTop + rootHeight;\n	  \n	  var popupWidth = theAbout.offsetWidth;\n	  \n	  var winWidth = findWindowWidth();\n	  if(popupLeft + popupWidth &gt; winWidth)\n		  popupLeft = winWidth - popupWidth;\n  		\n	  theAbout.style.left = popupLeft + &quot;px&quot;;\n	  theAbout.style.top = popupTop + &quot;px&quot;;\n	  theAbout.style.display = &quot;block&quot;;\n	  \n//    window.scrollTo(0,y);   // some bugs here\n    \n  }catch(ex){\n    alert('apl_sitebar_displayAboutBox(): '+ex.description);\n  }\n}\n\nfunction apl_sitebar_onClickAbout(e)\n{\n	if (!e) var e = window.event;\n	var theTarget = resolveTarget(e);\n	if(!theTarget) return(false);\n	\n  try{\n  \n    // check if already exist\n    var theAbout = document.getElementById(&quot;aboutsitebar&quot;);\n    \n    if(theAbout){  // switch theAbout\n    	relateTo = theAbout.getAttribute(&quot;relateTo&quot;);\n    	if(relateTo == theTarget.parentNode.id){\n	    	theAbout.style.display = (theAbout.style.display==&quot;block&quot;)? &quot;none&quot; : &quot;block&quot;;\n    	}\n    	else{\n    		theAbout.setAttribute(&quot;relateTo&quot;, theTarget.parentNode.id);\n    		apl_sitebar_displayAboutBox(theAbout, theTarget);\n    	}\n    }\n    else{	// create theAbout box\n      theAbout = document.createElement(&quot;div&quot;);\n      theAbout.setAttribute(&quot;id&quot;, &quot;aboutsitebar&quot;);\n      theAbout.setAttribute(&quot;style&quot;, &quot;position:absolute; z-index:99; display:block; background-color:white; border:medium solid red;&quot;);\n      theAbout.setAttribute(&quot;class&quot;, &quot;viewer&quot;);\n      ver = version.extensions.siteBar.major + &quot;.&quot; + version.extensions.siteBar.minor + &quot;.&quot; + version.extensions.siteBar.revision;\n      theAbout.innerHTML = 	'&lt;center&gt;siteBarPlugin Version '+ver+'&lt;br&gt;&lt;/center&gt;&lt;hr&gt;&lt;ul&gt;'+\n      											'&lt;li&gt;Author: &lt;a href=&quot;mailto:arphenlin@gmail.com&quot;&gt;Arphen Lin&lt;/a&gt;&lt;/li&gt;'+\n      											'&lt;li&gt;Web: &lt;a href=&quot;http://aiddlysite.sourceforge.net/&quot; target=&quot;new&quot;&gt;Aiddlysite&lt;/a&gt;&lt;/li&gt;'+\n      											'&lt;/ul&gt;';\n			theAbout.onclick = function(){\n														document.getElementById(&quot;aboutsitebar&quot;).style.display=&quot;none&quot;;\n													};											\n      theAbout.setAttribute(&quot;relateTo&quot;, theTarget.parentNode.id);\n      \n      document.body.appendChild(theAbout);\n      \n      apl_sitebar_displayAboutBox(theAbout, theTarget);\n    }\n    \n  }catch(ex){\n  	alert('apl_sitebar_onClickAbout(): '+ ex.description);\n  }		\n\n	e.cancelBubble = true;\n	if (e.stopPropagation) e.stopPropagation();\n	return(false);	\n}\n\nfunction apl_sitebar_onClickPreview(e)\n{\n	if (!e) var e = window.event;\n	var theTarget = resolveTarget(e);\n	if(!theTarget) return(false);\n	\n//	displayMessage(theTarget);\n	\n  try{\n\n    var sitebar = theTarget.parentNode;\n    if(!sitebar)  return;\n    \n    title = sitebar.id.substring(13, sitebar.id.length); // &quot;editorsitebar&quot;+title\n    var editorWrapper = document.getElementById( &quot;editorWrapper&quot;+title);\n  \n  	var editor= document.getElementById(&quot;editorBody&quot;+title);\n\n    // check if already exist\n    var previewer = document.getElementById(&quot;previewer&quot;+title);\n    if(previewer){  // switch previewer\n      if(previewer.style.display==&quot;block&quot;){\n        previewer.style.display = &quot;none&quot;;\n        editor.style.display = &quot;block&quot;;\n      }\n      else{\n        previewer.innerHTML = ''; // clear the contents\n        sitefy(editor.value, previewer, null, null);  // refresh the contents\n        previewer.style.display = &quot;block&quot;;\n        editor.style.display = &quot;none&quot;;\n      }\n    }\n    else{	// create previewer\n      previewer = document.createElement(&quot;div&quot;);\n      previewer.setAttribute(&quot;id&quot;, &quot;previewer&quot;+title);\n      previewer.setAttribute(&quot;style&quot;, &quot;overflow:auto; display:block; border:solid 1px;&quot;);\n      previewer.style.height = (editor.offsetHeight) + &quot;px&quot;;\n      previewer.setAttribute(&quot;class&quot;, &quot;viewer&quot;);\n      editorWrapper.insertBefore(previewer, editor);\n      \n      sitefy(editor.value, previewer, null, null);\n      \n      // hide editor\n      editor.style.display = &quot;none&quot;;\n    }\n    \n    apl_sitebar_switchsitebar(sitebar, (editor.style.display==&quot;block&quot;) );\n    \n  }catch(ex){\n  	alert('apl_sitebar_onClickPreview(): '+ ex.description);\n  }		\n\n	e.cancelBubble = true;\n	if (e.stopPropagation) e.stopPropagation();\n	return(false);\n  \n}\n\n\n//------------------------------------------------------------------------------------------------\n// onclick event handler\n//------------------------------------------------------------------------------------------------\nfunction apl_sitebar_onClicksitebarButton(e)\n{\n	if (!e) var e = window.event;\n	var theTarget = apl_sitebar_resolveClickButton(resolveTarget(e));\n	if(!theTarget) return(false);\n	\n  try{\n  \n  	title = theTarget.getAttribute(&quot;tiddler_title&quot;);\n  	\n  	var editor = document.getElementById(&quot;editorBody&quot;+title);\n    if(!editor) return;\n    \n    var syntax = null;\n    cmd = &quot;syntax = &quot; + theTarget.getAttribute(&quot;syntax_obj&quot;);\n  	eval(cmd);\n  	if(!syntax) return;\n  	\n  	if(syntax.needParam)\n  	  syntax.needParam(editor, theTarget);\n  	else\n  	  syntax.format(editor);\n  		\n  }catch(ex){\n  	alert('apl_sitebar_onClicksitebarButton(): '+ ex.description);\n  }		\n\n	e.cancelBubble = true;\n	if (e.stopPropagation) e.stopPropagation();\n	return(false);\n\n}\n\n\n//------------------------------------------------------------------------------------------------\n// create drop-down menu\n//------------------------------------------------------------------------------------------------\nfunction apl_sitebar_onClicksitebarMenu(e)\n{\n	if(!e) var e = window.event;\n	var theTarget = resolveTarget(e);   // = &lt;span&gt;, the object we click on\n	\n  try{  		\n	\n	  title = theTarget.getAttribute(&quot;tiddler_title&quot;);\n	  \n    // retrieve the string and eval() it \n    my_syntaxes = theTarget.getAttribute(&quot;syntax_objs&quot;);\n    var items=null;\n    cmd = &quot;items = &quot;+my_syntaxes;\n    eval(cmd);\n  	if(!items) return;\n\n  	var popup = createTiddlerPopup(this);\n  	if(!popup) return;\n\n  	for (i=0; i&lt;items.length; i++){\n		  var theItem = createTiddlyButton(\n                        createTiddlyElement(popup, &quot;li&quot;),\n                        items[i].name,\n                        items[i].tip,\n                        apl_sitebar_onClicksitebarButton\n                        );\n\n  		theItem.setAttribute(&quot;syntax_obj&quot;, my_syntaxes + &quot;[&quot;+i+&quot;]&quot;);\n  		theItem.setAttribute(&quot;tiddler_title&quot;, title);\n		}\n\n  	scrollToTiddlerPopup(popup,false);\n  	\n  }catch(ex){\n    alert('apl_sitebar_onClicksitebarMenu(): '+ex.description);\n  }	\n  \n	e.cancelBubble = true;\n	if (e.stopPropagation) e.stopPropagation();\n	return(false);\n  \n}\n\n\n//------------------------------------------------------------------------------------------------\n// apl_sitebar_ColorPicker class\n//------------------------------------------------------------------------------------------------\nfunction apl_sitebar_ColorPicker(theAction){\n  \n  // 16x16 colors\n  this.colorTable = [  \n    &quot;#FFFFFF&quot;,&quot;#DDDDDD&quot;,&quot;#CCCCCC&quot;,&quot;#BBBBBB&quot;,&quot;#AAAAAA&quot;,&quot;#999999&quot;,&quot;#666666&quot;,&quot;#333333&quot;,&quot;#111111&quot;,&quot;#000000&quot;,&quot;#FFCC00&quot;,&quot;#FF9900&quot;,&quot;#FF6600&quot;,&quot;#FF3300&quot;,&quot;#CC3300&quot;,&quot;#CC0033&quot;,\n    &quot;#99CC00&quot;,&quot;#99DD00&quot;,&quot;#99EE00&quot;,&quot;#EE9900&quot;,&quot;#DD9900&quot;,&quot;#CC9900&quot;,&quot;#FFCC33&quot;,&quot;#FFCC66&quot;,&quot;#FF9966&quot;,&quot;#FF6633&quot;,&quot;#660000&quot;,&quot;#990000&quot;,&quot;#CC0000&quot;,&quot;#FF0000&quot;,&quot;#FF3366&quot;,&quot;#FF0033&quot;,\n    &quot;#CCFF00&quot;,&quot;#CCFF33&quot;,&quot;#333300&quot;,&quot;#666600&quot;,&quot;#999900&quot;,&quot;#CCCC00&quot;,&quot;#FFFF00&quot;,&quot;#CC9933&quot;,&quot;#CC6633&quot;,&quot;#330000&quot;,&quot;#993333&quot;,&quot;#CC3333&quot;,&quot;#FF3333&quot;,&quot;#CC3366&quot;,&quot;#FF6699&quot;,&quot;#FF0066&quot;,\n    &quot;#99FF00&quot;,&quot;#CCFF66&quot;,&quot;#99CC33&quot;,&quot;#666633&quot;,&quot;#999933&quot;,&quot;#CCCC33&quot;,&quot;#FFFF33&quot;,&quot;#996600&quot;,&quot;#993300&quot;,&quot;#663333&quot;,&quot;#CC6666&quot;,&quot;#FF6666&quot;,&quot;#990033&quot;,&quot;#CC3399&quot;,&quot;#FF66CC&quot;,&quot;#FF0099&quot;,\n    &quot;#66FF00&quot;,&quot;#99FF66&quot;,&quot;#66CC33&quot;,&quot;#669900&quot;,&quot;#999966&quot;,&quot;#CCCC66&quot;,&quot;#FFFF66&quot;,&quot;#996633&quot;,&quot;#663300&quot;,&quot;#996666&quot;,&quot;#FF9999&quot;,&quot;#FF3399&quot;,&quot;#CC0066&quot;,&quot;#990066&quot;,&quot;#FF33CC&quot;,&quot;#FF00CC&quot;,\n    &quot;#33FF00&quot;,&quot;#66FF33&quot;,&quot;#339900&quot;,&quot;#66CC00&quot;,&quot;#99FF33&quot;,&quot;#CCCC99&quot;,&quot;#FFFF99&quot;,&quot;#CC9966&quot;,&quot;#CC6600&quot;,&quot;#CC9999&quot;,&quot;#FF99CC&quot;,&quot;#CC6699&quot;,&quot;#993366&quot;,&quot;#660033&quot;,&quot;#CC0099&quot;,&quot;#330033&quot;,\n    &quot;#00CC00&quot;,&quot;#33CC00&quot;,&quot;#336600&quot;,&quot;#669933&quot;,&quot;#99CC66&quot;,&quot;#CCFF99&quot;,&quot;#FFFFCC&quot;,&quot;#FFCC99&quot;,&quot;#FF9933&quot;,&quot;#FFCCCC&quot;,&quot;#CC99CC&quot;,&quot;#996699&quot;,&quot;#993399&quot;,&quot;#990099&quot;,&quot;#663366&quot;,&quot;#660066&quot;,\n    &quot;#006600&quot;,&quot;#33CC33&quot;,&quot;#66CC66&quot;,&quot;#00FF00&quot;,&quot;#33FF33&quot;,&quot;#66FF66&quot;,&quot;#99FF99&quot;,&quot;#CCFFCC&quot;,&quot;#99CCFF&quot;,&quot;#FFCCFF&quot;,&quot;#FF99FF&quot;,&quot;#FF66FF&quot;,&quot;#FF33FF&quot;,&quot;#FF00FF&quot;,&quot;#CC66CC&quot;,&quot;#CC33CC&quot;,\n    &quot;#003300&quot;,&quot;#336633&quot;,&quot;#009900&quot;,&quot;#339933&quot;,&quot;#669966&quot;,&quot;#99CC99&quot;,&quot;#CCFFFF&quot;,&quot;#3399FF&quot;,&quot;#6699CC&quot;,&quot;#CCCCFF&quot;,&quot;#CC99FF&quot;,&quot;#9966CC&quot;,&quot;#663399&quot;,&quot;#330066&quot;,&quot;#9900CC&quot;,&quot;#CC00CC&quot;,\n    &quot;#00FF33&quot;,&quot;#00CC33&quot;,&quot;#006633&quot;,&quot;#339966&quot;,&quot;#66CC99&quot;,&quot;#99FFCC&quot;,&quot;#99CCCC&quot;,&quot;#0066CC&quot;,&quot;#336699&quot;,&quot;#9999FF&quot;,&quot;#9999CC&quot;,&quot;#9933FF&quot;,&quot;#6600CC&quot;,&quot;#660099&quot;,&quot;#CC33FF&quot;,&quot;#CC00FF&quot;,\n    &quot;#00FF66&quot;,&quot;#33FF66&quot;,&quot;#009933&quot;,&quot;#00CC66&quot;,&quot;#33FF99&quot;,&quot;#99FFFF&quot;,&quot;#669999&quot;,&quot;#003366&quot;,&quot;#003399&quot;,&quot;#6666FF&quot;,&quot;#6666CC&quot;,&quot;#666699&quot;,&quot;#330099&quot;,&quot;#9933CC&quot;,&quot;#CC66FF&quot;,&quot;#9900FF&quot;,\n    &quot;#00FF99&quot;,&quot;#66FF99&quot;,&quot;#33CC66&quot;,&quot;#009966&quot;,&quot;#66FFFF&quot;,&quot;#66CCCC&quot;,&quot;#336666&quot;,&quot;#006699&quot;,&quot;#3366CC&quot;,&quot;#3333FF&quot;,&quot;#3333CC&quot;,&quot;#333399&quot;,&quot;#333366&quot;,&quot;#6633CC&quot;,&quot;#9966FF&quot;,&quot;#6600FF&quot;,\n    &quot;#00FFCC&quot;,&quot;#66FFCC&quot;,&quot;#33CC99&quot;,&quot;#33FFFF&quot;,&quot;#33CCCC&quot;,&quot;#339999&quot;,&quot;#003333&quot;,&quot;#3399CC&quot;,&quot;#6699FF&quot;,&quot;#0000FF&quot;,&quot;#0000CC&quot;,&quot;#000099&quot;,&quot;#000066&quot;,&quot;#000033&quot;,&quot;#6633FF&quot;,&quot;#3300FF&quot;,\n    &quot;#00CC99&quot;,&quot;#33FFCC&quot;,&quot;#00FFFF&quot;,&quot;#00CCCC&quot;,&quot;#009999&quot;,&quot;#006666&quot;,&quot;#33CCFF&quot;,&quot;#66CCFF&quot;,&quot;#0099CC&quot;,&quot;#3366FF&quot;,&quot;#00CCFF&quot;,&quot;#0099FF&quot;,&quot;#0066FF&quot;,&quot;#0033FF&quot;,&quot;#0033CC&quot;,&quot;#3300CC&quot;\n  ];\n\n	this.colorMap = null;		// div object\n\n  this.targetSyntax = null;   // the syntax object that called apl_sitebar_ColorPicker\n  this.targetEditor = null;   // the editor object that will be applied selected color\n  this.theAction = theAction;\n  \n  this.createColorMap();\n\n}\n\napl_sitebar_ColorPicker.prototype.showColorMap = function() \n{\n  if(this.colorMap){\n    this.colorMap.style.display = &quot;block&quot;;\n  }\n}\n\napl_sitebar_ColorPicker.prototype.hideColorMap = function() \n{\n  if(this.colorMap){\n    this.colorMap.style.display = &quot;none&quot;;\n  }\n}\n\n\napl_sitebar_ColorPicker.prototype.moveColorMap = function(theTarget)\n{\n  try{\n\n    var cm = this.colorMap; \n    if(!cm) return;\n    \n  	var rootLeft = findPosX(theTarget);\n	  var rootTop = findPosY(theTarget);\n	  var rootHeight = theTarget.offsetHeight;\n	  \n	  var popupLeft = rootLeft;\n	  var popupTop = rootTop + rootHeight;\n	  \n	  var popupWidth = cm.offsetWidth;\n	  \n	  var winWidth = findWindowWidth();\n	  if(popupLeft + popupWidth &gt; winWidth)\n		  popupLeft = winWidth - popupWidth;\n  		\n	  cm.style.left = popupLeft + &quot;px&quot;;\n	  cm.style.top = popupTop + &quot;px&quot;;\n	  cm.style.display = &quot;block&quot;;\n	  \n//    window.scrollTo(0,y);   // some bugs here\n    \n  }catch(ex){\n    alert('moveColorMap(): '+ex.description);\n  }\n}\n\napl_sitebar_ColorPicker.prototype.createColorMap = function() \n{\n	try{	\n\n    if(!this.theAction) return;\n        \n		if(this.colorMap)	return;\n	\n    // create div\n		this.colorMap = document.createElement(&quot;div&quot;);\n		this.colorMap.setAttribute(&quot;id&quot;,&quot;colorMap&quot;);\n		this.colorMap.setAttribute(&quot;style&quot;,&quot;display:none; position:absolute; left:0px; top:0px; z-index:99; margin:0px; padding:0px; cursor:crosshair;&quot;);\n		document.body.appendChild(this.colorMap);\n\n    // create table\n    var theTable = document.createElement(&quot;table&quot;);\n    theTable.setAttribute(&quot;cellspacing&quot;, 0);\n    theTable.setAttribute(&quot;cellpadding&quot;, 0);\n    theTable.setAttribute(&quot;style&quot;, &quot;border:solid 1px black;&quot;);\n    this.colorMap.appendChild(theTable);\n    \n    // create tr/td\n    cellsPerRow = 16;\n    var theTR=null;\n    for(i=0; i&lt;this.colorTable.length; i++){\n      // create new row\n      if((i%cellsPerRow)==0){  // 16x16\n        theTR = document.createElement(&quot;tr&quot;);\n        theTable.appendChild(theTR);\n      }\n\n      var theTD = document.createElement(&quot;td&quot;);\n      if(this.colorTable[i].trim() == '')\n        theTD.setAttribute(&quot;bgcolor&quot;, &quot;white&quot;);\n      else\n        theTD.setAttribute(&quot;bgcolor&quot;, this.colorTable[i]);\n      theTD.setAttribute(&quot;style&quot;, &quot;border:solid 1px black;&quot;);\n      theTD.onclick = this.theAction;\n      theTD.innerHTML = '&lt;span style=&quot;font-size:8px&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;';\n      theTR.appendChild(theTD);\n    }\n    \n    // bottom row\n    theTR = document.createElement(&quot;tr&quot;);\n		theTable.appendChild(theTR);\n		var theTD = document.createElement(&quot;td&quot;);\n		theTD.setAttribute(&quot;bgcolor&quot;, &quot;white&quot;);\n		theTD.setAttribute(&quot;style&quot;, &quot;border:solid 1px black;&quot;);\n		theTD.setAttribute(&quot;colspan&quot;,cellsPerRow);\n    theTD.onclick = function(){	if(apl_sitebar_colorPicker)	apl_sitebar_colorPicker.hideColorMap(); };\n		theTD.innerHTML = '&lt;center&gt;&lt;span style=&quot;font-size:10px;&quot;&gt;close&lt;/span&gt;&lt;/center&gt;';\n    theTR.appendChild(theTD);\n		\n	}catch(ex){\n		alert('createColorMap: '+ex.description);\n	}\n	\n}\n\n//------------------------------------------------------------------------------------------------\n// do on select a color\n//------------------------------------------------------------------------------------------------\nfunction apl_sitebar_onSelectColor(e) \n{\n  \n	if (!e) var e = window.event;\n	var theTarget = resolveTarget(e);   //&lt;span&gt;\n	if(!theTarget) return(false);\n\n  try{\n\n  	if(!apl_sitebar_colorPicker)  return;\n  	\n    apl_sitebar_colorPicker.hideColorMap();\n\n    // get the color  	\n    theTD = theTarget.parentNode;\n    color = theTD.getAttribute(&quot;bgcolor&quot;);\n    if(!color)  return;\n    \n    if(apl_sitebar_colorPicker.targetSyntax &amp;&amp; apl_sitebar_colorPicker.targetEditor)\n      apl_sitebar_colorPicker.targetSyntax.format(apl_sitebar_colorPicker.targetEditor, color);\n      \n  }catch(ex){\n    alert('apl_sitebar_onSelectColor: '+ex.description);\n  }     \n  \n	e.cancelBubble = true;\n	if (e.stopPropagation) e.stopPropagation();\n	return(false);\n   \n}\n\n\n//------------------------------------------------------------------------------------------------\n// global variables: color picker\n//------------------------------------------------------------------------------------------------\nvar apl_sitebar_colorPicker = new apl_sitebar_ColorPicker(apl_sitebar_onSelectColor);\n\n//------------------------------------------------------------------------------------------------\n// global variables: syntax object\n// \n// parameter syntax: %1,%2,... - parameter needed, [%1] - optional parameter\n//                   %N        - more than one parameter(1~n)\n//                   [%N]      - any parameter(0~n)\n//------------------------------------------------------------------------------------------------\nvar apl_sitebar_syntaxes = {\n  formattings: [\n		{\n			name: 	&quot;ignore&quot;,\n			tip:    &quot;ignore site word&quot;,\n			symbol: &quot;~&quot;,\n			syntax: &quot;~user_text&quot;,\n			hint:   &quot;site_word&quot;,\n			format:	apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;bold&quot;,\n			tip:    &quot;bolder text&quot;,\n			symbol: &quot;&lt;strong&gt;B&lt;/strong&gt;&quot;,\n			syntax: &quot;''user_text''&quot;,\n			hint:		&quot;bold_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;italic&quot;,\n			tip:    &quot;italic text&quot;,\n			symbol: &quot;&lt;em&gt;I&lt;/em&gt;&quot;,\n			syntax: &quot;//user_text//&quot;,\n			hint:		&quot;italic_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;underline&quot;,\n			tip:    &quot;underline text&quot;,\n			symbol: &quot;&lt;u&gt;U&lt;/u&gt;&quot;,\n			syntax: &quot;__user_text__&quot;,\n			hint:		&quot;underline_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;strike&quot;,\n			tip:    &quot;strikethrough text&quot;,\n			symbol: &quot;&lt;strike&gt;S&lt;/strike&gt;&quot;,\n			syntax: &quot;==user_text==&quot;,\n			hint:		&quot;strikethrough_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;sup&quot;,\n			tip:    &quot;superscript text&quot;,\n			symbol: &quot;X&lt;sup&gt;2&lt;/sup&gt;&quot;,\n			syntax: &quot;^^user_text^^&quot;,\n			hint:		&quot;superscript_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;sub&quot;,\n			tip:    &quot;subscript text&quot;,\n			symbol: &quot;X&lt;sub&gt;2&lt;/sub&gt;&quot;,\n			syntax: &quot;~~user_text~~&quot;,\n			hint:		&quot;subscript_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;comment&quot;,\n			tip:    &quot;comment text&quot;,\n			symbol: &quot;/%&quot;,\n			syntax: &quot;/%user_text%/&quot;,\n			hint:		&quot;comment_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;monospaced&quot;,\n			tip:    &quot;monospaced text&quot;,\n			symbol: &quot;&lt;code&gt;mono&lt;/code&gt;&quot;,\n			syntax: &quot;{{{user_text}}}&quot;,\n			hint:		&quot;monospaced_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;line&quot;,\n			tip:    &quot;horizontal line&quot;,\n			symbol: &quot;&amp;mdash;&quot;,\n			syntax: &quot;\sn----\sn&quot;,\n			format: apl_sitebar_formatByCursor\n		},\n		{\n			name: 	&quot;crlf&quot;,\n			tip:    &quot;line break&quot;,\n			symbol: &quot;&amp;para;&quot;,\n			syntax: &quot;\sn&quot;,\n			format: apl_sitebar_formatByCursor\n		}\n  ],  // formattings\n  colors: [\n		{\n			name: 	&quot;highlight&quot;,\n			tip:    &quot;highlight text&quot;,\n			syntax: &quot;@@user_text@@&quot;,\n			hint:		&quot;highlight_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;color&quot;,\n			tip:    &quot;text color&quot;,\n			hint:		&quot;your_text&quot;,\n			syntax: &quot;@@color(%1):user_text@@&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getColorCode\n		},\n		{\n			name: 	&quot;bgcolor&quot;,\n			tip:    &quot;background color&quot;,\n			hint:		&quot;your_text&quot;,\n			syntax: &quot;@@bgcolor(%1):user_text@@&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getColorCode\n		},\n    {\n      name:   &quot;colorcode&quot;,\n      tip:    &quot;insert colorcode&quot;,\n      syntax: &quot;%1&quot;,\n      format: apl_sitebar_formatByCursor,\n      needParam: apl_sitebar_getColorCode\n    }		\n  ],  // colors\n  lists:[\n		{\n			name: 	&quot;bullet&quot;,\n			tip:    &quot;bullet point&quot;,\n			syntax: &quot;*user_text&quot;,\n			hint:		&quot;bullet_text&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;numbered&quot;,\n			tip:    &quot;numbered list&quot;,\n			syntax: &quot;#user_text&quot;,\n			hint:		&quot;numbered_text&quot;,\n			format: apl_sitebar_formatByLine\n		}\n  ],  // lists\n  headings:[\n		{\n			name: 	&quot;Heading 1&quot;,\n			tip:    &quot;Heading 1&quot;,\n			syntax: &quot;!user_text&quot;,\n			hint:		&quot;heading_1&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;Heading 2&quot;,\n			tip:    &quot;Heading 2&quot;,\n			syntax: &quot;!!user_text&quot;,\n			hint:		&quot;heading_2&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;Heading 3&quot;,\n			tip:    &quot;Heading 3&quot;,\n			syntax: &quot;!!!user_text&quot;,\n			hint:		&quot;heading_3&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;Heading 4&quot;,\n			tip:    &quot;Heading 4&quot;,\n			syntax: &quot;!!!!user_text&quot;,\n			hint:		&quot;heading_4&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;Heading 5&quot;,\n			tip:    &quot;Heading 5&quot;,\n			syntax: &quot;!!!!!user_text&quot;,\n			hint:		&quot;heading_5&quot;,\n			format: apl_sitebar_formatByLine\n		}\n  ],  // headings\n  paragraphs:[\n		{\n			name: 	&quot;comment by line&quot;,\n			tip:    &quot;line comment&quot;,\n			syntax: &quot;/%user_text%/&quot;,\n			hint:		&quot;comment_text&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;comment by block&quot;,\n			tip:    &quot;block comment&quot;,\n			syntax: &quot;/%\snuser_text\sn%/&quot;,\n			hint:		&quot;comment_text&quot;,\n			byBlock: true,			\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;monospaced by line&quot;,\n			tip:    &quot;line monospaced&quot;,\n			syntax: &quot;{{{\snuser_text\sn}}}&quot;,\n			hint:		&quot;monospaced_text&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;monospaced by block&quot;,\n			tip:    &quot;block monospaced&quot;,\n			syntax: &quot;{{{\snuser_text\sn}}}&quot;,\n			hint:		&quot;monospaced_text&quot;,\n			byBlock: true,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;quote by line&quot;,\n			tip:    &quot;line quote&quot;,\n			syntax: &quot;&gt;user_text&quot;,\n			hint:		&quot;quote_text&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;quote by block&quot;,\n			tip:    &quot;block quote&quot;,\n			syntax: &quot;&lt;&lt;&lt;\snuser_text\sn&lt;&lt;&lt;&quot;,\n			hint:		&quot;quote_text&quot;,\n			byBlock: true,			\n			format: apl_sitebar_formatByLine\n		}\n  ],  // paragraphs\n  links:[\n		{\n			name: 	&quot;site&quot;,\n			tip:    &quot;site link&quot;,\n			syntax: &quot;[[user_text]]&quot;,\n			hint:		&quot;site_word&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;pretty&quot;,\n			tip:    &quot;pretty link&quot;,\n			syntax: &quot;[[user_text|%1]]&quot;, \n			hint:		&quot;pretty_word&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getLinkUrl,\n			param:	&quot;PrettyLink Target&quot;\n		},\n		{\n			name: 	&quot;url&quot;,\n			tip:    &quot;url link&quot;,\n			syntax: &quot;[[user_text|%1]]&quot;, \n			hint:		&quot;your_text&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getLinkUrl,\n			param:	&quot;http://...&quot;\n		},\n		{\n			name: 	&quot;image&quot;,\n			tip:    &quot;image link&quot;,\n			syntax: &quot;[img[user_text|%1]]&quot;, \n			hint:		&quot;alt_text&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getLinkUrl,\n			param:	&quot;image/icon.jpg&quot;\n		}\n  ],  // links\n  plugins:[\n		{\n			name: 	&quot;codes area&quot;,\n			tip:    &quot;block monospaced for plugin&quot;,\n			syntax: &quot;//{{{\snuser_text\sn//}}}&quot;,\n			hint:		&quot;monospaced_plugin_text&quot;,\n			byBlock: true,\n			format: apl_sitebar_formatByLine\n		},  \n		{\n			name: 	&quot;comment by line&quot;,\n			tip:    &quot;line comment&quot;,\n			syntax: &quot;//user_text&quot;,\n			hint:		&quot;plugin_comment&quot;,\n			format: apl_sitebar_formatByLine\n		},\n		{\n			name: 	&quot;comment by block&quot;,\n			tip:    &quot;block comment&quot;,\n			syntax: &quot;/***\snuser_text\sn***/&quot;,\n			hint:		&quot;plugin_comment&quot;,\n			byBlock: true,\n			format: apl_sitebar_formatByLine\n		}\n  ],  // plugins\n  tables:[\n		{\n			name: 	&quot;table&quot;,\n			tip:    &quot;create a new table&quot;,\n			syntax: &quot;\sn%1\sn&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getTableRowCol\n		},\n		{\n			name: 	&quot;table header&quot;,\n			tip:    &quot;table header text&quot;,\n			syntax: &quot;|user_text|c&quot;,\n			hint:		&quot;table_header&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;cell&quot;,\n			tip:    &quot;create a tabel cell&quot;,\n			syntax: &quot;|user_text|&quot;,\n			hint:		&quot;your_text&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;column header&quot;,\n			tip:    &quot;create a column header cell&quot;,\n			syntax: &quot;|!user_text|&quot;,\n			hint:		&quot;column_header&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;cell bgcolor&quot;,\n			tip:    &quot;cell bgcolor&quot;,\n			syntax: &quot;|bgcolor(%1):user_text|&quot;,\n			hint:		&quot;your_text&quot;,\n			format: apl_sitebar_formatByTableCell,\n			needParam: apl_sitebar_getColorCode\n		},\n		{\n			name: 	&quot;align left&quot;,\n			tip:    &quot;add a tabel cell&quot;,\n			syntax: &quot;|user_text|&quot;,\n			hint:		&quot;your_text&quot;,\n			format: apl_sitebar_formatByTableCell\n		},\n		{\n			name: 	&quot;align center&quot;,\n			tip:    &quot;add a tabel cell&quot;,\n			syntax: &quot;| user_text |&quot;,\n			hint:		&quot;your_text&quot;,\n			format: apl_sitebar_formatByTableCell\n		},\n		{\n			name: 	&quot;align right&quot;,\n			tip:    &quot;add a tabel cell&quot;,\n			syntax: &quot;| user_text|&quot;,\n			hint:		&quot;your_text&quot;,\n			format: apl_sitebar_formatByTableCell\n		}\n  ],  // tables\n  macros:[\n		{\n			name: 	&quot;allTags&quot;,\n			tip:    &quot;allTags&quot;,\n			syntax: &quot;&lt;&lt;allTags&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;closeAll&quot;,\n			tip:    &quot;closeAll&quot;,\n			syntax: &quot;&lt;&lt;closeAll&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;gradient&quot;,\n			tip:    &quot;gradient&quot;,\n			syntax: &quot;&lt;&lt;gradient vert #ffffff %1&gt;&gt;user_text&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord,\n      needParam: apl_sitebar_getColorCode\n		},\n		{\n			name: 	&quot;list&quot;,\n			tip:    &quot;list&quot;,\n			syntax: &quot;&lt;&lt;list&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;list missing&quot;,\n			tip:    &quot;list missing&quot;,\n			syntax: &quot;&lt;&lt;list missing&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},\n		{\n			name: 	&quot;list orphans&quot;,\n			tip:    &quot;list orphans&quot;,\n			syntax: &quot;&lt;&lt;list orphans&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;newJournal&quot;,\n			tip:    &quot;newJournal&quot;,\n			syntax: &quot;&lt;&lt;newJournal&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;newTiddler&quot;,\n			tip:    &quot;newTiddler&quot;,\n			syntax: &quot;&lt;&lt;newTiddler&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;option&quot;,\n			tip:    &quot;option&quot;,\n			syntax: &quot;&lt;&lt;option %1&gt;&gt;[%2]\sn&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getMacroParam,\n			param: 	'chkOpenInNewWindow &quot;Open link in new window&quot;'\n		},		\n		{\n			name: 	&quot;permaview&quot;,\n			tip:    &quot;permaview&quot;,\n			syntax: &quot;&lt;&lt;permaview&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;saveChanges&quot;,\n			tip:    &quot;saveChanges&quot;,\n			syntax: &quot;&lt;&lt;saveChanges&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;search&quot;,\n			tip:    &quot;search&quot;,\n			syntax: &quot;&lt;&lt;search&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;slider&quot;,\n			tip:    &quot;slider&quot;,\n			syntax: &quot;&lt;&lt;slider %1 %2 %3&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getMacroParam,\n			param: 	&quot;sliderID sliderTiddler sliderLabel&quot;\n		},		\n		{\n			name: 	&quot;sparkline&quot;,\n			tip:    &quot;sparkline&quot;,\n			syntax: &quot;&lt;&lt;sparkline %N&gt;&gt;&quot;, \n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getMacroParam,\n			param:	&quot;number_list(ex: 100 123 ...)&quot;\n		},		\n		{\n			name: 	&quot;tabs&quot;,\n			tip:    &quot;tabs&quot;,\n			syntax: &quot;&lt;&lt;tabs [%N]&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getMacroParam,\n			param: 	&quot;indentifier tabLabel tabName Tiddler&quot;\n		},		\n		{\n			name: 	&quot;tag&quot;,\n			tip:    &quot;tag&quot;,\n			syntax: &quot;&lt;&lt;tag %1&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getMacroParam,\n			param: 	&quot;tagName(ex: systemConfig)&quot;\n		},		\n		{\n			name: 	&quot;tiddler&quot;,\n			tip:    &quot;tiddler&quot;,\n			syntax: &quot;&lt;&lt;tiddler %1&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getMacroParam,\n			param: 	&quot;Tiddler&quot;\n		},		\n		{\n			name: 	&quot;timeline&quot;,\n			tip:    &quot;timeline&quot;,\n			syntax: &quot;&lt;&lt;timeline&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		},		\n		{\n			name: 	&quot;today&quot;,\n			tip:    &quot;today&quot;,\n			syntax: &quot;&lt;&lt;today [%1]&gt;&gt;&quot;, \n			format: apl_sitebar_formatByWord,\n			needParam: apl_sitebar_getMacroParam,\n			param:  '&quot;YYYY/MM/DD hh:mm:ss&quot;'\n		},		\n		{\n			name: 	&quot;version&quot;,\n			tip:    &quot;version&quot;,\n			syntax: &quot;&lt;&lt;version&gt;&gt;&quot;,\n			format: apl_sitebar_formatByWord\n		}\n  ], // macros\n  dates:[\n    {\n      name:   &quot;YYYY&quot;,\n      tip:    &quot;full year&quot;,\n      syntax: &quot;YYYY&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;YY&quot;,\n      tip:    &quot;2-digit year&quot;,\n      syntax: &quot;YY&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;MMM&quot;,\n      tip:    &quot;month name&quot;,\n      syntax: &quot;MMM&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;MM&quot;,\n      tip:    &quot;month&quot;,\n      syntax: &quot;MM&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;0MM&quot;,\n      tip:    &quot;zero-leading month&quot;,\n      syntax: &quot;0MM&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;DDD&quot;,\n      tip:    &quot;week day&quot;,\n      syntax: &quot;DDD&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;DD&quot;,\n      tip:    &quot;day&quot;,\n      syntax: &quot;DD&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;0DD&quot;,\n      tip:    &quot;zero-leading day&quot;,\n      syntax: &quot;0DD&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;hh&quot;,\n      tip:    &quot;hour&quot;,\n      syntax: &quot;hh&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;mm&quot;,\n      tip:    &quot;minute&quot;,\n      syntax: &quot;mm&quot;,\n      format: apl_sitebar_formatByCursor\n    },\n    {\n      name:   &quot;ss&quot;,\n      tip:    &quot;second&quot;,\n      syntax: &quot;ss&quot;,\n      format: apl_sitebar_formatByCursor\n    }    \n  ], // dates\n  htmls:[\n		{\n			name: 	&quot;&lt;html&gt;&quot;,\n			tip:    &quot;html tag&quot;,\n			syntax: &quot;&lt;html&gt;\snuser_text\sn&lt;/html&gt;&quot;,\n			hint:		&quot;html_content&quot;,\n			byBlock: true,\n			format: apl_sitebar_formatByLine\n		}\n  ]	// htmls\n};\n\n\n//}}}</div>
<div tiddler="" modified="201912181426" modifier="YourName" tags="systemConfig systemTiny">// // '':'' zh_CN\n// // '':'' \n// // '':'' Safe3\n// // '':'' 1.2.37 (2005/10/28)\n// // '':''\n// // Oct 28, 2005: 1  config.messages.shadowedTiddlerToolTip\n// //                          2. config.macros.list.shadowed.prompt\n// //                          3. config.views.sitefied.tag\n{{{\nversion.extensions.zh_CN = {major: 1, minor: 2, revision: 37, date: new Date(&quot;Oct 28, 2005&quot;)};\n// // ''Messages''\nconfig.messages= {\n customConfigError: &quot;customConfig  - '%1' - %0&quot;,\n savedSnapshotError: &quot;&quot;,\n subtitleUnknown: &quot;()&quot;,\n undefinedTiddlerToolTip: &quot;'%0' &quot;,\n externalLinkTooltip: &quot; %0&quot;,\n shadowedTiddlerToolTip: &quot;'%0' , &quot;,\n noTags: &quot;&quot;,\n notFileUrlError: &quot;&quot;,\n cantSaveError: &quot;FireFox&quot;,\n invalidFileError: &quot; '%0' &quot;,\n backupSaved: &quot;&quot;,\n backupFailed: &quot;&quot;,\n rssSaved: &quot;RSS feed &quot;,\n rssFailed: &quot; RSS feed &quot;,\n emptySaved: &quot;&quot;,\n emptyFailed: &quot;&quot;,\n mainSaved: &quot;&quot;,\n mainFailed: &quot;. &quot;,\n macroError: &quot;macro '%0'&quot;,\n overwriteWarning: &quot;'%0' []&quot;,\n unsavedChangesWarning: &quot; \sn\sn[][]&quot;,\n dates: {\n months: [&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;],\n days: [&quot;&quot;, &quot;&quot;,&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;]\n }\n };\nconfig.views = {\n sitefied: {\n tag: {labelNoTags: &quot;&quot;, labelTags: &quot;Tag: &quot;, tooltip: &quot; '%0' &quot;, openAllText: &quot;&quot;, openAllTooltip: &quot; '%0'  &quot;, popupNone: &quot; '%0'&quot;},\n toolbarClose: {text: &quot;&quot;, tooltip: &quot;&quot;},\n toolbarEdit: {text: &quot;&quot;, tooltip: &quot;&quot;},\n toolbarPermalink: {text: &quot;&quot;, tooltip: &quot;&quot;},\n toolbarReferences: {text: &quot;&quot;, tooltip: &quot;&quot;, popupNone: &quot;&quot;},\n defaultText: &quot;&quot;\n },\n editor: {\n tagPrompt: &quot;[[]]&quot;,\n tagChooser: {text: &quot;&quot;, tooltip: &quot;&quot;, popupNone: &quot;&quot;, tagTooltip: &quot; '%0'&quot;},\n toolbarDone: {text: &quot;&quot;, tooltip: &quot;&quot;},\n toolbarCancel: {text: &quot;&quot;, tooltip: &quot;&quot;},\n toolbarDelete: {text: &quot;&quot;, tooltip: &quot;&quot;},\n defaultText: &quot;&quot;\n }\n };\n// // ''SiderBar''\nconfig.shadowTiny.SideBarOptions = &quot;&lt;&lt;gradient vert #ffffff #cc9900&gt;&gt;&lt;&lt;search&gt;&gt;&lt;&lt;closeAll&gt;&gt;&lt;&lt;permaview&gt;&gt;&lt;&lt;saveChanges&gt;&gt;&lt;&lt;slider chkSliderOptionsPanel OptionsPanel  ''&gt;&gt;&gt;&gt;&quot;;\nconfig.shadowTiny.AdvancedOptions = &quot;&lt;&lt;option chkOpenInNewWindow&gt;&gt; \sn&lt;&lt;option chkSaveEmptyTemplate&gt;&gt; \sn&lt;&lt;option chkToggleLinks&gt;&gt; \sn\sn&lt;&lt;option chkHttpReadOnly&gt;&gt;  ({{{http:}}})\sn&lt;&lt;option chkForceMinorUpdate&gt;&gt; \sn( Shift  Ctrl-Shift-Enter)&quot;;\nconfig.shadowTiny.OptionsPanel = &quot;\sn&lt;&lt;option txtUserName&gt;&gt;\sn (Word)\sn\sn &lt;&lt;option chkSaveBackups&gt;&gt; [[]]\sn&lt;&lt;option chkAutoSave&gt;&gt; [[]]\sn&lt;&lt;option chkGenerateAnRssFeed&gt;&gt; [[ RssFeed]]\sn&lt;&lt;option chkRegExpSearch&gt;&gt; [[]]\sn&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[]]\sn&lt;&lt;option \snchkAnimate&gt;&gt; [[]]\sn\sn &lt;&lt;slider sliderAdvancedOptions AdvancedOptions  ''&gt;&gt;&quot;;\nconfig.shadowTiny.SideBarTabs = &quot;&lt;&lt;tabs txtMainTab Timeline '' TabTimeline All '' TabAll Tabs '' TabTags More '' TabMore&gt;&gt;&quot;;\nconfig.shadowTiny.TabMore = &quot;&lt;&lt;tabs txtMoreTab  '' TabMoreMissing  '' TabMoreOrphans&gt;&gt;&quot;;\nconfig.shadowTiny.SliderTimeline = &quot;&lt;&lt;slider sliderTimeline TabTimeline  ''&gt;&gt;&quot;;\nconfig.macros.search.label = &quot; Search&quot;;\nconfig.macros.search.prompt = &quot;Search Content&quot;;\nconfig.macros.search.sizeTextbox = 15;\nconfig.macros.search.accessKey = &quot;F&quot;;\nconfig.macros.search.successMsg = &quot; %0 &quot;;\nconfig.macros.search.failureMsg = &quot; &quot;;\nconfig.macros.timeline.dateFormat = &quot;YYYY0MM0DD&quot;;\nconfig.macros.allTags.tooltip = &quot;- '%0'&quot;;\nconfig.macros.allTags.noTags = &quot;&quot;;\nconfig.macros.list.all.prompt = &quot;&quot;;\nconfig.macros.list.missing.prompt = &quot;&quot;;\nconfig.macros.list.orphans.prompt = &quot;&quot;;\nconfig.macros.list.shadowed.prompt = &quot;&quot;;\n// // ''ToolsBar''\nconfig.macros.closeAll.label = &quot;Close All&quot;;\nconfig.macros.closeAll.prompt = &quot;Close all opened tiddlers(except editing)&quot;;\nconfig.macros.saveChanges.label = &quot;&quot;;\nconfig.macros.saveChanges.prompt = &quot;&quot;;\nconfig.macros.permaview.label = &quot;&quot;;\nconfig.macros.permaview.prompt = &quot;&quot;;\nconfig.macros.newTiddler.label = &quot;&quot;;\nconfig.macros.newTiddler.prompt = &quot;&quot;;\nconfig.macros.newJournal.label = &quot;&quot;;\nconfig.macros.newJournal.prompt = &quot;&quot;;\n// // ''Date formatString''\nDate.prototype.formatString = function(template)\n{\n template = template.replace(/YYYY/g,this.getFullYear() + '');\n template = template.replace(/YY/g,String.zeroPad(this.getFullYear()-1911,2) + '');\n template = template.replace(/MMM/g,config.messages.dates.months[this.getMonth()] + '');\n template = template.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2) + '');\n template = template.replace(/MM/g,this.getMonth()+1 + '');\n template = template.replace(/DDD/g,''+config.messages.dates.days[this.getDay()]);\n template = template.replace(/0DD/g,String.zeroPad(this.getDate(),2)+ '');\n template = template.replace(/DD/g,this.getDate() + '');\n template = template.replace(/hh/g,this.getHours());\n template = template.replace(/mm/g,this.getMinutes());\n template = template.replace(/ss/g,this.getSeconds());\n return template;\n};\n}}}</div>
		</div>
</body>
</html>